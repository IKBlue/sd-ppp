"use strict";(()=>{var Xn=Object.create;var _t=Object.defineProperty;var io=Object.getOwnPropertyDescriptor;var Zn=Object.getOwnPropertyNames;var ei=Object.getPrototypeOf,ti=Object.prototype.hasOwnProperty;var k=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var kt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),gr=(e,t)=>{for(var r in t)_t(e,r,{get:t[r],enumerable:!0})},ri=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Zn(t))!ti.call(e,n)&&n!==r&&_t(e,n,{get:()=>t[n],enumerable:!(o=io(t,n))||o.enumerable});return e};var w=(e,t,r)=>(r=e!=null?Xn(ei(e)):{},ri(t||!e||!e.__esModule?_t(r,"default",{value:e,enumerable:!0}):r,e));var T=(e,t,r,o)=>{for(var n=o>1?void 0:o?io(t,r):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(n=(o?s(t,r,n):s(n))||n);return o&&n&&_t(t,r,n),n};var A=kt((Bs,wo)=>{"use strict";wo.exports=window.React});var b=kt((Vs,Po)=>{"use strict";Po.exports=window.ReactJSXRuntime});var Ao=kt((Hs,Eo)=>{"use strict";Eo.exports=window.socketIO});var mt=kt((ua,Ro)=>{"use strict";Ro.exports=window.Jimp});var no={};gr(no,{Promote:()=>Jn,SDPPP:()=>Yn,SDPPPProvider:()=>Sn,useAgentState:()=>Dn,useSDPPPComfyCaller:()=>se,useSDPPPContext:()=>Ae,useSDPPPWebpageList:()=>bn,useSDPPPWorkflowList:()=>vn});var W=k("photoshop");function Se(e,t,r=0){return"-".repeat(r)+`${t} (id:${e})`}function he(e,t){return`${t} (id:${e})`}function oi(e){let t=e.split(" (id:");return{name:t[0],id:parseInt(t[1].slice(0,-1))}}function so(e){return oi(e)}var ge=k("photoshop"),ni=k("uxp");var yr={"SDPPP Get Document":"SDPPP Get Document","SDPPP Get Layer By ID":"SDPPP Get Layer","SDPPP Get Linked Layers":"SDPPP Get Linked Layers","SDPPP Get Layers In Group":"SDPPP Get Layers In Group","SDPPP Get Text From Layer":"SDPPP Get Text From Layer","SDPPP Parse Layer Info":"SDPPP Parse Layer Info","SDPPP Get Selection":"SDPPP Get Selection","SDPPP Get Image From Photoshop":"SDPPP Get Image From Photoshop","SDPPP Send Images To Photoshop":"SDPPP Send Images To Photoshop","SDPPP Settings":"SDPPP Settings/Misc"};var wr={"### Active Document ###":"### \u5F53\u524D\u6587\u6863 ###","### The Canvas ###":"### \u6574\u4E2A\u753B\u5E03 ###","### New Layer ###":"### \u65B0\u56FE\u5C42 ###","### Selected Layer ###":"### \u6240\u9009\u56FE\u5C42 ###","### Keep Size or Fit Canvas ###":"### \u4FDD\u6301\u5C3A\u5BF8\u6216\u9002\u5E94\u753B\u5E03 ###",_SDPPP_PSD_:"_SDPPP_PSD_","Save and run immediately":"\u4FDD\u5B58\u5E76\u7ACB\u5373\u6267\u884C",Close:"\u5173\u95ED","Select a {0}":"\u9009\u62E9\u4E00\u4E2A {0}","How to use .ccx file":"\u5982\u4F55\u4F7F\u7528 .ccx \u6587\u4EF6","1. If you have installed Adobe Creative Cloud":"1. \u5982\u679C\u4F60\u5DF2\u7ECF\u5B89\u88C5\u4E86 Adobe Creative Cloud","Just double click the .ccx file, it will install the plugin automatically":"\u53CC\u51FB .ccx \u6587\u4EF6\uFF0C\u5B83\u4F1A\u81EA\u52A8\u5B89\u88C5","2. If you don't have Adobe Creative Cloud":"2. \u5982\u679C\u4F60\u6CA1\u6709 Adobe Creative Cloud","Rename .ccx to .zip and extract it into ":"\u5C06 .ccx \u91CD\u547D\u540D\u4E3A .zip \u5E76\u89E3\u538B\u5230",or:"\u6216","Photoshop directory":"Photoshop \u5B89\u88C5\u76EE\u5F55","Cannot connect multiple different document widgets with same value":"\u4E0D\u80FD\u8FDE\u63A5\u591A\u4E2A\u5177\u6709\u76F8\u540C\u503C\u7684\u6587\u6863\u5C0F\u90E8\u4EF6","You can only have one SDPPP Settings node in a workflow":"\u4E00\u4E2A\u5DE5\u4F5C\u6D41\u4E2D\u53EA\u80FD\u6709\u4E00\u4E2A SDPPP Settings \u8282\u70B9","convert widget {0} failed:":"\u63A7\u4EF6{0}\u8F6C\u6362\u5931\u8D25\uFF1A","hidden webview load failed: {0}, please select a browser page to continue":"\u5185\u7F6E webview \u52A0\u8F7D\u5931\u8D25: {0}\uFF0C\u8BF7\u9009\u62E9\u4E00\u4E2A\u6D4F\u89C8\u5668\u9875\u9762\u7EE7\u7EED","SDPPP Get Document":"SDPPP\u83B7\u53D6\u6587\u6863(GetDocument)","SDPPP Get Layer By ID":"SDPPP\u83B7\u53D6\u56FE\u5C42(GetLayer)","SDPPP Get Linked Layers":"SDPPP\u83B7\u53D6\u94FE\u63A5\u56FE\u5C42(GetLinkedLayers)","SDPPP Get Layers In Group":"SDPPP\u83B7\u53D6\u7EC4\u4E2D\u56FE\u5C42(GetLayersInGroup)","SDPPP Get Text From Layer":"SDPPP\u83B7\u53D6\u56FE\u5C42\u6587\u672C(GetTextFromLayer)","SDPPP Parse Layer Info":"SDPPP\u89E3\u6790\u56FE\u5C42\u4FE1\u606F(ParseLayerInfo)","SDPPP Get Selection":"SDPPP\u83B7\u53D6\u9009\u533A(GetSelection)","SDPPP Get Image From Photoshop":"SDPPP\u4ECEPS\u83B7\u53D6\u56FE\u50CF(GetImageFromPhotoshop)","SDPPP Send Images To Photoshop":"SDPPP\u53D1\u9001\u56FE\u50CF\u5230PS(SendImagesToPhotoshop)","SDPPP Send Text To Layer":"SDPPP\u53D1\u9001\u6587\u672C\u5230\u56FE\u5C42(SendTextToLayer)","SDPPP Run Photoshop Action":"SDPPP\u8FD0\u884CPS Action(RunPhotoshopAction)","download PS plugin (.ccx)":"\u4E0B\u8F7D Photoshop \u63D2\u4EF6 (.ccx)","current ComfyUI pageid: {0}":"\u5F53\u524D ComfyUI \u9875\u9762ID: {0}","current A1111 pageid: {0}":"\u5F53\u524D A1111 \u9875\u9762ID: {0}","document linked":"\u6587\u6863\u53C2\u6570\u5DF2\u94FE\u63A5","layer linked":"\u56FE\u5C42\u53C2\u6570\u5DF2\u94FE\u63A5","bound linked":"\u8303\u56F4\u53C2\u6570\u5DF2\u94FE\u63A5",document:"\u6587\u6863",Document:"\u6587\u6863",DOCUMENT:"\u6587\u6863",document_name:"\u6587\u6863\u540D\u5B57id",layer_nameid:"\u56FE\u5C42\u540D\u5B57id",layer_name:"\u56FE\u5C42\u540D\u5B57",layer_info:"\u56FE\u5C42\u4FE1\u606F",bound_top:"\u8303\u56F4\u4E0A\u8FB9\u8DDD",bound_left:"\u8303\u56F4\u5DE6\u8FB9\u8DDD",bound_width:"\u8303\u56F4\u5BBD\u5EA6",bound_height:"\u8303\u56F4\u9AD8\u5EA6",center_x:"\u4E2D\u5FC3\u70B9x",center_y:"\u4E2D\u5FC3\u70B9y",opacity:"\u900F\u660E\u5EA6",layer:"\u56FE\u5C42",layer_or_group:"\u56FE\u5C42(\u6216\u7EC4)",Layer_or_group:"\u56FE\u5C42(\u6216\u7EC4)",bound:"\u8303\u56F4",bounds:"\u8303\u56F4","bounds [optional]":"\u8303\u56F4[\u53EF\u9009]",boundary:"\u8303\u56F4",Boundary:"\u8303\u56F4",canvas_bound:"\u753B\u5E03\u8303\u56F4",layer_bound:"\u56FE\u5C42\u8303\u56F4","Photoshop Disconnected!":"Photoshop \u672A\u8FDE\u63A5\uFF01",rgb_out:"RGB\u8F93\u51FA",alpha_out:"Alpha\u8F93\u51FA",images:"\u56FE\u50CF",text:"\u6587\u672C",ID_mode:"\u7CBE\u786EID\u6A21\u5F0F",name_mode:"\u540D\u5B57\u5339\u914D\u6A21\u5F0F",select:"\u9009\u62E9","document boundary":"\u6587\u6863\u8303\u56F4","layer boundary":"\u56FE\u5C42\u8303\u56F4","selection boundary":"\u9009\u4E2D\u8303\u56F4","save .psd to this workflow":"\u4FDD\u5B58.psd\u5230\u8FD9\u4E2A\u5DE5\u4F5C\u6D41","extract saved .psd to Photoshop":"\u63D0\u53D6\u4FDD\u5B58\u7684.psd\u5230Photoshop","sample .psd":"\u793A\u4F8B.psd",mask:"\u906E\u7F69",name:"\u540D\u79F0",quality:"\u56FE\u50CF\u8D28\u91CF",timeout:"\u8D85\u65F6","--multi-user activated, Not Login!":"--multi-user\u5DF2\u6FC0\u6D3B\uFF0C\u4F46\u672A\u767B\u5F55\uFF01",Logout:"\u767B\u51FA","User: ":"\u7528\u6237: ",connect:"\u8FDE\u63A5",connected:"\u5DF2\u8FDE\u63A5",disconnect:"\u65AD\u5F00",disconnected:"\u5DF2\u65AD\u5F00\u8FDE\u63A5","reconnecting...":"\u91CD\u8FDE\u4E2D...",connecting:"\u8FDE\u63A5\u4E2D",webpages:"\u7F51\u9875\u5217\u8868",workflows:"\u5DE5\u4F5C\u6D41",workflow:"\u5DE5\u4F5C\u6D41","auto run page [{0}] after change..":"\u66F4\u6539\u540E\u81EA\u52A8\u8FD0\u884C\u9875\u9762 {0}..","auto run workflow [{0}] after change..":"\u66F4\u6539\u540E\u81EA\u52A8\u8FD0\u884C\u5DE5\u4F5C\u6D41 {0}..","auto run workflow after change..":"\u66F4\u6539\u540E\u81EA\u52A8\u8FD0\u884C\u5DE5\u4F5C\u6D41..",selection_only:"\u4EC5\u9009\u533A","Queue:":"\u961F\u5217:","Set As:":"\u8BBE\u7F6E\u4E3A:","Error {0}... please contact me via Discord/Github":"\u51FA\u73B0\u9519\u8BEF {0}...\uFF0C\u8BF7\u901A\u8FC7 QQ/Github \u8054\u7CFB\u6211","Webview initialize failed. Please report to me via Discord/Github with your ComfyURL, Operate System":"Webview \u521D\u59CB\u5316\u5931\u8D25\uFF0C\u8BF7\u901A\u8FC7 QQ/Github \u8054\u7CFB\u6211\u5E76\u9644\u4E0A\u4F60\u7684Comfy\u5730\u5740\u3001\u64CD\u4F5C\u7CFB\u7EDF","Workflow List of ComfyUI with --multi-user is only available for sponsors":'\u5E26"--multi-user"\u7684ComfyUI\u4EC5\u5BF9\u8D5E\u52A9\u8005\u5F00\u653E',"(Page ID: {0})Queue: {1}":"(\u9875\u9762ID: {0}) \u961F\u5217\u957F\u5EA6 {1}","no suitable node to control in this workflow":"\u8FD9\u4E2A\u5DE5\u4F5C\u6D41\u4E2D\u6CA1\u6709\u80FD\u63A7\u5236\u7684\u8282\u70B9",Save:"\u4FDD\u5B58",Edit:"\u7F16\u8F91","Edit in ComfyUI":"\u5728 ComfyUI \u4E2D\u7F16\u8F91","using browser page [{0}] for workflow running":"\u6B63\u63A5\u7BA1\u7F51\u9875 [{0}] \u8FD0\u884C\u5DE5\u4F5C\u6D41","workflow running by hidden webview":"\u5DE5\u4F5C\u6D41\u5728\u9690\u85CF\u7684webview\u4E2D\u8FD0\u884C","Lock Image":"\u9501\u5B9A\u56FE\u50CF","Unlock Image":"\u89E3\u9501\u56FE\u50CF","search...":"\u641C\u7D22...","disabled when running in browser page":"\u63A5\u7BA1\u7F51\u9875\u65F6\u4E0D\u53EF\u7528","only supported in Photoshop":"\u4EC5\u5728 Photoshop \u4E2D\u652F\u6301",Login:"\u767B\u5F55","Invitation Code":"\u9080\u8BF7\u7801",Username:"\u7528\u6237\u540D",Password:"\u5BC6\u7801","Please input invitation code":"\u8BF7\u8F93\u5165\u9080\u8BF7\u7801","Please input username":"\u8BF7\u8F93\u5165\u7528\u6237\u540D","Please input password":"\u8BF7\u8F93\u5165\u5BC6\u7801","502: Maybe the server is not running":"502: \u670D\u52A1\u5668\u53EF\u80FD\u672A\u8FD0\u884C","404: Maybe SDPPP is not installed or failed to run in ComfyUI":"404: \u53EF\u80FD\u5728ComfyUI\u4E2DSDPPP\u672A\u5B89\u88C5\u6216\u8FD0\u884C\u5931\u8D25","{0}. reconnecting...":"{0}. \u91CD\u8FDE\u4E2D...","disconnected to {0} failed {1}":"\u65AD\u5F00\u8FDE\u63A5 {0} \u9519\u8BEF {1}","version mismatch, please reinstall PS plugin":"\u7248\u672C\u4E0D\u5339\u914D\uFF0C\u8BF7\u91CD\u65B0\u5B89\u88C5 PS \u63D2\u4EF6","instance type not recognized":"\u672A\u8BC6\u522B\u7684\u8F6F\u4EF6\u7C7B\u578B","Error: {0}":"\u9519\u8BEF: {0}","Verification Error":"\u9A8C\u8BC1\u9519\u8BEF","document {0} not found":"\u627E\u4E0D\u5230\u6587\u6863: {0}",'only layer kind "TEXT" is supported, invalid layer: {0}':"\u4E0D\u652F\u6301\u975E\u6587\u672C\u56FE\u5C42: {0}","create layer failed":"\u521B\u5EFA\u56FE\u5C42\u5931\u8D25","layer not found {0}":"\u627E\u4E0D\u5230\u56FE\u5C42: {0}","no linked layer for {0}":"\u6CA1\u6709\u94FE\u63A5\u56FE\u5C42: {0}","layer {0} is not a group":"\u56FE\u5C42 {0} \u4E0D\u662F\u4E00\u4E2A\u7EC4","no layer in group {0}":"\u7EC4 {0} \u4E2D\u6CA1\u6709\u56FE\u5C42","layer not found: {0}":"\u627E\u4E0D\u5230\u56FE\u5C42: {0}","No upload_name":"\u4E0A\u4F20\u63A5\u53E3\u8FD4\u56DE\u4E86\u5931\u8D25","get pixel of {0} failed":"\u83B7\u53D6\u50CF\u7D20\u5931\u8D25: {0}","merge group failed":"\u5408\u5E76\u7EC4\u5931\u8D25","invalid name: {0}":"\u975E\u6CD5\u7684\u540D\u79F0: {0}","get_layer_info: layer_identify required":"get_layer_info: \u9700\u8981 layer_identify","invalid action: {0}":"\u65E0\u6548\u7684\u64CD\u4F5C: {0}","create document failed":"\u521B\u5EFA\u6587\u6863\u5931\u8D25","create document for preview":"\u521B\u5EFA\u9884\u89C8\u6587\u6863","resize document for preview":"\u8C03\u6574\u9884\u89C8\u6587\u6863\u5C3A\u5BF8","no first related layer in {0}":"\u7EC4 {0} \u4E2D\u6CA1\u6709\u7B2C\u4E00\u4E2A\u76F8\u5173\u56FE\u5C42","imageDataError: data length is not multiple of width * height":"\u56FE\u50CF\u6570\u636E\u6709\u8BEF: \u6570\u636E\u957F\u5EA6\u4E0D\u662F\u5BBD\u5EA6 * \u9AD8\u5EA6\u7684\u500D\u6570","imageDataError: originComponents must be 1 or 3":"\u56FE\u50CF\u6570\u636E\u6709\u8BEF: originComponents \u5FC5\u987B\u662F 1 \u6216 3","unexpected connection lost, please try to reconnect":"\u610F\u5916\u65AD\u5F00\u8FDE\u63A5\uFF0C\u8BF7\u5C1D\u8BD5\u91CD\u65B0\u8FDE\u63A5","Workflow list is empty, please save a workflow by Comfy's lastest UI":"\u5DE5\u4F5C\u6D41\u5217\u8868\u4E3A\u7A7A\uFF0C\u8BF7\u5728Comfy\u7684\u65B0\u7248UI\u4E2D\u4FDD\u5B58\u4E00\u4E2A\u5DE5\u4F5C\u6D41","No opened ComfyUI pages":"\u6CA1\u6709\u5DF2\u6253\u5F00\u7684ComfyUI\u9875\u9762","comfyAPI is not initialized, maybe comfyUI is too old":"\u65E0\u6CD5\u83B7\u53D6 ComfyAPI\uFF0C\u53EF\u80FD ComfyUI \u7248\u672C\u592A\u65E7","unsupported channel counts: {0}":"\u4E0D\u652F\u6301\u7684\u901A\u9053\u6570: {0}","Timeout, Maybe the URL is wrong":"\u8D85\u65F6\uFF0C\u53EF\u80FD comfy\u5730\u5740 \u586B\u5199\u9519\u8BEF","Workflow list loading failed: {0}":"\u5DE5\u4F5C\u6D41\u5217\u8868\u52A0\u8F7D\u5931\u8D25: {0}","Please register a user in ComfyUI":"\u8BF7\u5728 ComfyUI \u4E2D\u6CE8\u518C\u4E00\u4E2A\u7528\u6237","GetSelection need Photoshop version 25+":"GetSelection \u9700\u8981 Photoshop 25+ \u7248\u672C","Action {0} not found":"Action {0} \u672A\u627E\u5230","Action set {0} not found":"ActionSet {0} \u672A\u627E\u5230","create document for sent images":"\u7ED9\u53D1\u9001\u7684\u56FE\u7247\u521B\u5EFA\u6587\u6863","show sent images":"\u663E\u793A\u53D1\u9001\u7684\u56FE\u7247","fallback show sent images":"\u53D6\u6D88\u663E\u793A\u53D1\u9001\u7684\u56FE\u7247","get content of layer {0}":"\u83B7\u53D6\u56FE\u5C42 {0} \u7684\u5185\u5BB9","fallback get content of layer {0}":"\u53D6\u6D88\u83B7\u53D6\u56FE\u5C42 {0} \u7684\u5185\u5BB9","get layer info":"\u83B7\u53D6\u56FE\u5C42\u4FE1\u606F","sdppp extract PSD":"sdppp \u5BFC\u5165 PSD","sdppp get PSD":"sdppp \u83B7\u53D6 PSD","set text to layer":"\u8BBE\u7F6E\u56FE\u5C42\u7684\u6587\u672C","sdppp Run Photoshop Action":"sdppp \u8FD0\u884C Photoshop Action","{0} wants to extract a PSD file to Photoshop, are you sure?":"{0} \u60F3\u8981\u91CA\u653E\u4E00\u4E2A.psd\u6587\u4EF6\u5230Photoshop\uFF0C\u786E\u5B9A\u5417\uFF1F","should sdppp refuse extracting PSD to Photoshop in this session anymore?":"\u662F\u5426\u8981\u8BA9 sdppp \u62D2\u7EDD\u672C\u6B21PS\u4F1A\u8BDD\u518D\u6B21\u63A5\u53D7.psd\u91CA\u653E\u8BF7\u6C42\uFF1F","Wide Mode":"\u5BBD\u5C4F\u6A21\u5F0F","Quick Set":"\u5FEB\u901F\u8BBE\u7F6E","Selected Layer":"\u9009\u4E2D\u56FE\u5C42","Selected Layer (invert)":"\u9009\u4E2D\u56FE\u5C42(\u53CD\u5411)",Canvas:"\u753B\u5E03",Selection:"\u9009\u533A",Manual:"\u624B\u52A8\u6A21\u5F0F",Auto:"\u81EA\u52A8\u6A21\u5F0F","This plugin is based on sd-ppp":"\u672C\u63D2\u4EF6\u57FA\u4E8Esd-ppp\u5F00\u53D1","And follows its open source license:":"\u5E76\u9075\u5FAA\u5176\u5F00\u6E90\u534F\u8BAE\uFF1A",Cloud:"\u4E91\u7AEF",Sponsors:"\u8D5E\u52A9","waiting...":"\u865A\u4F4D\u4EE5\u5F85",Links:"\u53CB\u60C5\u94FE\u63A5",Community:"\u793E\u533A","LICENSE:":"\u8BB8\u53EF\u8BC1\uFF1A",upload:"\u4E0A\u4F20","Simplify Workflow":"\u7B80\u5316\u5DE5\u4F5C\u6D41",Photoshop:"Photoshop","Photoshop plugin settings":"Photoshop \u63D2\u4EF6\u8BBE\u7F6E","Photoshop plugin":"Photoshop \u63D2\u4EF6","SDPPP Settings/Misc":"SDPPP \u8BBE\u7F6E/\u6742\u9879","Sample .PSD for this workflow:":"\u793A\u4F8B.PSD","Download Example .PSD":"\u4E0B\u8F7D\u793A\u4F8B.PSD","Maximum Image Size (px):":"\u6700\u5927\u56FE\u50CF\u5C3A\u5BF8(px)",Download:"\u4E0B\u8F7D",Upload:"\u4E0A\u4F20",Reset:"\u91CD\u7F6E",Refresh:"\u5237\u65B0","Comfy URL: {0}":"Comfy\u5730\u5740: {0}","Photoshop is not connected":"Photoshop \u672A\u8FDE\u63A5","select...":"\u8BF7\u9009\u62E9","click to edit":"\u70B9\u51FB\u7F16\u8F91","ComfyManager not found, cannot reboot":"Comfy Manager\u672A\u5B89\u88C5\uFF0C\u65E0\u6CD5\u91CD\u542F","Failed to reboot ComfyUI":"\u91CD\u542FComfyUI\u5931\u8D25"};var ao=typeof k<"u"?k:void 0,Tt="en";typeof navigator<"u"&&navigator.language?Tt=navigator.language=="zh-CN"?"zhcn":"en":ao&&(Tt=ao("uxp").host.uiLocale.startsWith("zh")?"zhcn":"en");function m(e,...t){let r=Tt=="zhcn"?wr[e]:e in yr?yr[e]:e;if(!r)throw new Error(`i18n key not found: ${e}`);return r.replace(/{(\d+)}/g,function(o,n){return typeof t[n]<"u"?t[n]:o})}function Oe(e,t){return e==t||wr[e]==t}function at(){return Tt}var E=class e{static SPECIAL_DOCUMENT_CURRENT="### Active Document ###";static is_SPECIAL_DOCUMENT_CURRENT(t){return Oe(this.SPECIAL_DOCUMENT_CURRENT,t)}static get_SPECIAL_DOCUMENT_CURRENT(){return m(this.SPECIAL_DOCUMENT_CURRENT)}static SPECIAL_LAYER_KEEP_SIZE="### Keep Size or Fit Canvas ###";static is_SPECIAL_LAYER_FIT(t){return Oe(this.SPECIAL_LAYER_KEEP_SIZE,t)}static get_SPECIAL_LAYER_FIT(){return m(this.SPECIAL_LAYER_KEEP_SIZE)}static SPECIAL_LAYER_USE_CANVAS="### The Canvas ###";static is_SPECIAL_LAYER_USE_CANVAS(t){return Oe(this.SPECIAL_LAYER_USE_CANVAS,t)}static get_SPECIAL_LAYER_USE_CANVAS(){return m(this.SPECIAL_LAYER_USE_CANVAS)}static SPECIAL_LAYER_NEW_LAYER="### New Layer ###";static is_SPECIAL_LAYER_NEW_LAYER(t){return Oe(this.SPECIAL_LAYER_NEW_LAYER,t)}static get_SPECIAL_LAYER_NEW_LAYER(){return m(this.SPECIAL_LAYER_NEW_LAYER)}static SPECIAL_LAYER_SELECTED_LAYER="### Selected Layer ###";static is_SPECIAL_LAYER_SELECTED_LAYER(t){return Oe(this.SPECIAL_LAYER_SELECTED_LAYER,t)}static get_SPECIAL_LAYER_SELECTED_LAYER(){return m(this.SPECIAL_LAYER_SELECTED_LAYER)}static SPECIAL_LAYER_PREVIEW_DOCUMENT="_SDPPP_PSD_";static is_SPECIAL_LAYER_PREVIEW_DOCUMENT(t){return Oe(this.SPECIAL_LAYER_PREVIEW_DOCUMENT,t)}static get_SPECIAL_LAYER_PREVIEW_DOCUMENT(){return m(this.SPECIAL_LAYER_PREVIEW_DOCUMENT)}static getSpecialDocumentCurrent(){return m(e.SPECIAL_DOCUMENT_CURRENT)}static getSpecialLayerForGet(){return[m(e.SPECIAL_LAYER_USE_CANVAS),m(e.SPECIAL_LAYER_SELECTED_LAYER)]}static getSpecialLayerForSend(){return[m(e.SPECIAL_LAYER_NEW_LAYER),m(e.SPECIAL_LAYER_SELECTED_LAYER)]}static getSpecialDocumentForPreview(){return m(e.SPECIAL_LAYER_PREVIEW_DOCUMENT)}static fixI18n(t){return this.is_SPECIAL_DOCUMENT_CURRENT(t)?this.SPECIAL_DOCUMENT_CURRENT:this.is_SPECIAL_LAYER_NEW_LAYER(t)?this.SPECIAL_LAYER_NEW_LAYER:this.is_SPECIAL_LAYER_PREVIEW_DOCUMENT(t)?this.SPECIAL_LAYER_PREVIEW_DOCUMENT:this.is_SPECIAL_LAYER_USE_CANVAS(t)?this.SPECIAL_LAYER_USE_CANVAS:this.is_SPECIAL_LAYER_SELECTED_LAYER(t)?this.SPECIAL_LAYER_SELECTED_LAYER:t}};function We(){let e=ge.app.activeDocument?.activeLayers?.[0];return e?Se(e.id,e.name):E.get_SPECIAL_LAYER_USE_CANVAS()}function uo(e,t,r,o,n){let i=r.left,s=r.top,a=r.right,u=r.bottom,d=a-i,p=u-s,h=o.left,c=o.top,l=o.right,f=o.bottom,g=l-h,y=f-c,P=Math.max(i,h),S=Math.max(s,c),D=Math.min(a,l),U=Math.min(u,f),oe=D-P,it=U-S,z=g*y*n;if(t.length!==z)throw new Error(`toImageDataArray.length(${t.length}) !== toLength(${z})`);let Q=oe*it*n;if(e.length!==Q)throw new Error(`fromImageDataArray.length(${e.length}) !== fromLength(${Q})`);for(let Ne=0;Ne<z;Ne+=n){let st=Ne/n%g+h,It=Math.floor(Ne/n/g)+c;if(st>=i&&st<a&&It>=s&&It<u){let $n=((It-S)*oe+(st-P))*n;for(let Lt=0;Lt<n;Lt++)t[Ne+Lt]=e[$n+Lt]}}return t}function co(e){if(typeof e!="string")throw new Error("not a invalid identifer: "+e);let r=e.split("(id:").pop();if(!r)throw new Error(m("invalid name: {0}",e));return parseInt(r.trim().slice(0,-1))}function ii(e){return E.is_SPECIAL_DOCUMENT_CURRENT(e)?-1:co(e)}function ne(e,t){return E.is_SPECIAL_LAYER_USE_CANVAS(t)?0:E.is_SPECIAL_LAYER_SELECTED_LAYER(t)?e.activeLayers.length>0?e.activeLayers[0].id:0:E.is_SPECIAL_LAYER_NEW_LAYER(t)?-2:co(t)}function Pr(e,t=0,r=""){return e?.layers?e.layers.reduce((o,n)=>{let i=t==0?`/${n.name}`:`${r}/${n.name}`;return o.push({layer:n,path:i,level:t}),o.concat(Pr(n,t+1,i))},[]):[]}function de(e,t){if(!e.layers)return null;for(let r=0;r<e.layers.length;r++){if(e.layers[r].id===t)return e.layers[r];let o=de(e.layers[r],t);if(o)return o}return null}async function Rt(e,t){if(t<=0)return[null,!1];let r=de(e,t);if(!r)throw new Error(m("layer not found {0}",t));if(r.kind==ge.constants.LayerKind.GROUP){let o=await si(r,e);if(!o)throw new Error(m("merge group failed"));return[o,!0]}else if(r.kind==ge.constants.LayerKind.GRADIENTFILL){let o=await r.duplicate(e);return await o?.rasterize(ge.constants.RasterizeType.ENTIRELAYER),[o,!0]}return[r,!1]}async function si(e,t){let r=!0;e.visible||(e.visible=!0,r=!1);let n=await(await e.duplicate(t))?.merge();return r||(e.visible=!1),n||null}function V(e){return(E.is_SPECIAL_DOCUMENT_CURRENT(e)?ge.app.activeDocument:ge.app.documents.find(t=>t.id==ii(e)))||null}function lo(e,t){return{name:t.name,opacity:t.opacity/100,boundary:{left:t.bounds?.left||0,top:t.bounds?.top||0,right:e.width-(t.bounds?.right||0),bottom:e.height-(t.bounds?.bottom||0),width:t.bounds?.width||0,height:t.bounds?.height||0},isGroup:t.kind==ge.constants.LayerKind.GROUP}}function fo(){let e=localStorage.getItem("sdppp_uid");return(!e||e.length!=3)&&(e=ut(3),localStorage.setItem("sdppp_uid",e)),e}function ut(e){let t="",r="abcdefghijklmnopqrstuvwxyz0123456789",o=r.length,n=0;for(;n<e;)t+=r.charAt(Math.floor(Math.random()*o)),n+=1;return t}var xt=class{storeMap=new Map;storeCount(){return this.storeMap.size}getStore(t){return this.storeMap.get(t)}getAllStore(){return Object.fromEntries(this.storeMap.entries())}subscribers=[];subscribersWithoutKey=new WeakMap;subscribe(t,r){this.subscribers.push([t,r]);let o={};this.subscribersWithoutKey.set(r,o),this.storeMap.forEach((n,i)=>{o[i]=r.bind(this,i),n.subscribe(t,o[i])})}unsubscribe(t){this.subscribers=this.subscribers.filter(([o,n])=>n!=t);let r=this.subscribersWithoutKey.get(t);r&&this.storeMap.forEach((o,n)=>{o.unsubscribe(r[n])})}addStore(t,r,o){let n=this.createStore(r,o);this.storeMap.set(t,n),this.subscribers.forEach(([i,s])=>{let a=this.subscribersWithoutKey.get(s);a||(a={},this.subscribersWithoutKey.set(s,a)),a[t]=s.bind(this,t),n.subscribe(i,a[t]),i=="/"&&s(t,r,null)})}removeStore(t){let r=this.storeMap.get(t);r&&(this.subscribers.forEach(([o,n])=>{let i=this.subscribersWithoutKey.get(n);i&&(r.unsubscribe(i[t]),o=="/"&&n(t,null,r.data))}),this.storeMap.delete(t))}sync(t){if(t instanceof Array){let r=Array.from(this.storeMap.keys()),o=t.filter(i=>!r.includes(i)),n=r.filter(i=>!t.includes(i));o.forEach(i=>this.addStore(i,{},0)),n.forEach(i=>this.removeStore(i))}else{Array.from(this.storeMap.keys()).filter(o=>!Object.keys(t).includes(o)).forEach(o=>this.removeStore(o));for(let o in t){let{data:n,version:i}=t[o];this.storeMap.has(o)?this.storeMap.get(o)?.sync(n,i):this.addStore(o,n,i)}}}};var Sr={};gr(Sr,{JsonPatchError:()=>x,_areEquals:()=>dt,applyOperation:()=>Me,applyPatch:()=>He,applyReducer:()=>di,deepClone:()=>ci,getValueByPointer:()=>Ue,validate:()=>mo,validator:()=>Ut});var ai=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,n){o.__proto__=n}||function(o,n){for(var i in n)n.hasOwnProperty(i)&&(o[i]=n[i])},e(t,r)};return function(t,r){e(t,r);function o(){this.constructor=t}t.prototype=r===null?Object.create(r):(o.prototype=r.prototype,new o)}}(),ui=Object.prototype.hasOwnProperty;function Ot(e,t){return ui.call(e,t)}function Wt(e){if(Array.isArray(e)){for(var t=new Array(e.length),r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(e);var o=[];for(var n in e)Ot(e,n)&&o.push(n);return o}function R(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Mt(e){for(var t=0,r=e.length,o;t<r;){if(o=e.charCodeAt(t),o>=48&&o<=57){t++;continue}return!1}return!0}function fe(e){return e.indexOf("/")===-1&&e.indexOf("~")===-1?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function ct(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Nt(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(var t=0,r=e.length;t<r;t++)if(Nt(e[t]))return!0}else if(typeof e=="object"){for(var o=Wt(e),n=o.length,i=0;i<n;i++)if(Nt(e[o[i]]))return!0}}return!1}function po(e,t){var r=[e];for(var o in t){var n=typeof t[o]=="object"?JSON.stringify(t[o],null,2):t[o];typeof n<"u"&&r.push(o+": "+n)}return r.join(`
`)}var lt=function(e){ai(t,e);function t(r,o,n,i,s){var a=this.constructor,u=e.call(this,po(r,{name:o,index:n,operation:i,tree:s}))||this;return u.name=o,u.index=n,u.operation=i,u.tree=s,Object.setPrototypeOf(u,a.prototype),u.message=po(r,{name:o,index:n,operation:i,tree:s}),u}return t}(Error);var x=lt,ci=R,Ge={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var o=e[t];return delete e[t],{newDocument:r,removed:o}},replace:function(e,t,r){var o=e[t];return e[t]=this.value,{newDocument:r,removed:o}},move:function(e,t,r){var o=Ue(r,this.path);o&&(o=R(o));var n=Me(r,{op:"remove",path:this.from}).removed;return Me(r,{op:"add",path:this.path,value:n}),{newDocument:r,removed:o}},copy:function(e,t,r){var o=Ue(r,this.from);return Me(r,{op:"add",path:this.path,value:R(o)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:dt(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}},li={add:function(e,t,r){return Mt(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){var o=e.splice(t,1);return{newDocument:r,removed:o[0]}},replace:function(e,t,r){var o=e[t];return e[t]=this.value,{newDocument:r,removed:o}},move:Ge.move,copy:Ge.copy,test:Ge.test,_get:Ge._get};function Ue(e,t){if(t=="")return e;var r={op:"_get",path:t};return Me(e,r),r.value}function Me(e,t,r,o,n,i){if(r===void 0&&(r=!1),o===void 0&&(o=!0),n===void 0&&(n=!0),i===void 0&&(i=0),r&&(typeof r=="function"?r(t,0,e,t.path):Ut(t,0)),t.path===""){var s={newDocument:e};if(t.op==="add")return s.newDocument=t.value,s;if(t.op==="replace")return s.newDocument=t.value,s.removed=e,s;if(t.op==="move"||t.op==="copy")return s.newDocument=Ue(e,t.from),t.op==="move"&&(s.removed=e),s;if(t.op==="test"){if(s.test=dt(e,t.value),s.test===!1)throw new x("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s.newDocument=e,s}else{if(t.op==="remove")return s.removed=e,s.newDocument=null,s;if(t.op==="_get")return t.value=e,s;if(r)throw new x("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return s}}else{o||(e=R(e));var a=t.path||"",u=a.split("/"),d=e,p=1,h=u.length,c=void 0,l=void 0,f=void 0;for(typeof r=="function"?f=r:f=Ut;;){if(l=u[p],l&&l.indexOf("~")!=-1&&(l=ct(l)),n&&(l=="__proto__"||l=="prototype"&&p>0&&u[p-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&c===void 0&&(d[l]===void 0?c=u.slice(0,p).join("/"):p==h-1&&(c=t.path),c!==void 0&&f(t,0,e,c)),p++,Array.isArray(d)){if(l==="-")l=d.length;else{if(r&&!Mt(l))throw new x("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);Mt(l)&&(l=~~l)}if(p>=h){if(r&&t.op==="add"&&l>d.length)throw new x("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);var s=li[t.op].call(t,d,l,e);if(s.test===!1)throw new x("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s}}else if(p>=h){var s=Ge[t.op].call(t,d,l,e);if(s.test===!1)throw new x("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s}if(d=d[l],r&&p<h&&(!d||typeof d!="object"))throw new x("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function He(e,t,r,o,n){if(o===void 0&&(o=!0),n===void 0&&(n=!0),r&&!Array.isArray(t))throw new x("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");o||(e=R(e));for(var i=new Array(t.length),s=0,a=t.length;s<a;s++)i[s]=Me(e,t[s],r,!0,n,s),e=i[s].newDocument;return i.newDocument=e,i}function di(e,t,r){var o=Me(e,t);if(o.test===!1)throw new x("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return o.newDocument}function Ut(e,t,r,o){if(typeof e!="object"||e===null||Array.isArray(e))throw new x("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(Ge[e.op]){if(typeof e.path!="string")throw new x("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new x('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new x("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new x("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if((e.op==="add"||e.op==="replace"||e.op==="test")&&Nt(e.value))throw new x("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r){if(e.op=="add"){var n=e.path.split("/").length,i=o.split("/").length;if(n!==i+1&&n!==i)throw new x("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==o)throw new x("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if(e.op==="move"||e.op==="copy"){var s={op:"_get",path:e.from,value:void 0},a=mo([s],r);if(a&&a.name==="OPERATION_PATH_UNRESOLVABLE")throw new x("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}}else throw new x("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r)}function mo(e,t,r){try{if(!Array.isArray(e))throw new x("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)He(R(t),R(e),r||!0);else{r=r||Ut;for(var o=0;o<e.length;o++)r(e[o],o,t,void 0)}}catch(n){if(n instanceof x)return n;throw n}}function dt(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var r=Array.isArray(e),o=Array.isArray(t),n,i,s;if(r&&o){if(i=e.length,i!=t.length)return!1;for(n=i;n--!==0;)if(!dt(e[n],t[n]))return!1;return!0}if(r!=o)return!1;var a=Object.keys(e);if(i=a.length,i!==Object.keys(t).length)return!1;for(n=i;n--!==0;)if(!t.hasOwnProperty(a[n]))return!1;for(n=i;n--!==0;)if(s=a[n],!dt(e[s],t[s]))return!1;return!0}return e!==e&&t!==t}var Er={};gr(Er,{compare:()=>Ft,generate:()=>br,observe:()=>wi,unobserve:()=>yi});var vr=new WeakMap,fi=function(){function e(t){this.observers=new Map,this.obj=t}return e}(),pi=function(){function e(t,r){this.callback=t,this.observer=r}return e}();function mi(e){return vr.get(e)}function hi(e,t){return e.observers.get(t)}function gi(e,t){e.observers.delete(t.callback)}function yi(e,t){t.unobserve()}function wi(e,t){var r=[],o,n=mi(e);if(!n)n=new fi(e),vr.set(e,n);else{var i=hi(n,t);o=i&&i.observer}if(o)return o;if(o={},n.value=R(e),t){o.callback=t,o.next=null;var s=function(){br(o)},a=function(){clearTimeout(o.next),o.next=setTimeout(s)};typeof window<"u"&&(window.addEventListener("mouseup",a),window.addEventListener("keyup",a),window.addEventListener("mousedown",a),window.addEventListener("keydown",a),window.addEventListener("change",a))}return o.patches=r,o.object=e,o.unobserve=function(){br(o),clearTimeout(o.next),gi(n,o),typeof window<"u"&&(window.removeEventListener("mouseup",a),window.removeEventListener("keyup",a),window.removeEventListener("mousedown",a),window.removeEventListener("keydown",a),window.removeEventListener("change",a))},n.observers.set(t,new pi(t,o)),o}function br(e,t){t===void 0&&(t=!1);var r=vr.get(e.object);Dr(r.value,e.object,e.patches,"",t),e.patches.length&&He(r.value,e.patches);var o=e.patches;return o.length>0&&(e.patches=[],e.callback&&e.callback(o)),o}function Dr(e,t,r,o,n){if(t!==e){typeof t.toJSON=="function"&&(t=t.toJSON());for(var i=Wt(t),s=Wt(e),a=!1,u=!1,d=s.length-1;d>=0;d--){var p=s[d],h=e[p];if(Ot(t,p)&&!(t[p]===void 0&&h!==void 0&&Array.isArray(t)===!1)){var c=t[p];typeof h=="object"&&h!=null&&typeof c=="object"&&c!=null&&Array.isArray(h)===Array.isArray(c)?Dr(h,c,r,o+"/"+fe(p),n):h!==c&&(a=!0,n&&r.push({op:"test",path:o+"/"+fe(p),value:R(h)}),r.push({op:"replace",path:o+"/"+fe(p),value:R(c)}))}else Array.isArray(e)===Array.isArray(t)?(n&&r.push({op:"test",path:o+"/"+fe(p),value:R(h)}),r.push({op:"remove",path:o+"/"+fe(p)}),u=!0):(n&&r.push({op:"test",path:o,value:e}),r.push({op:"replace",path:o,value:t}),a=!0)}if(!(!u&&i.length==s.length))for(var d=0;d<i.length;d++){var p=i[d];!Ot(e,p)&&t[p]!==void 0&&r.push({op:"add",path:o+"/"+fe(p),value:R(t[p])})}}}function Ft(e,t,r){r===void 0&&(r=!1);var o=[];return Dr(e,t,o,"",r),o}var ws=Object.assign({},Sr,Er,{JsonPatchError:lt,deepClone:R,escapePathComponent:fe,unescapePathComponent:ct});var Bt=Symbol("STORE_MUTATIONS"),Ar=class{_data;_mutationRecords=[];storedMinVersion=0;_version=0;get version(){return this._version}flush(){return{operations:this._mutationRecords.slice(0),fromVersion:this.storedMinVersion,toVersion:this.version}}flushDone(t){this._mutationRecords=this._mutationRecords.slice(t-this.storedMinVersion),this.storedMinVersion=t}patchVersionAcceptable(t){return this._version!=-1&&t<=this._version}patchData(t){let r=R(this._data);He(this._data,t),this._version+=t.length,this.storedMinVersion=this._version,this.dispatch(t,r)}get data(){return R(this._data)}static[Bt]=[];constructor(t){this._data=R(t)}sync(t,r){let o=this._data,n=Ft(o,t);Object.assign(this._data,t),this.storedMinVersion=this._version=r,this.dispatch(n,o)}subscribers=[];subscribe(t,r){this.subscribers.push([t,r])}unsubscribe(t){this.subscribers=this.subscribers.filter(([r,o])=>o!=t)}dispatch(t,r){let o=new Map;t.forEach(n=>{this.subscribers.forEach(([i,s])=>{n.path.startsWith(i)&&!o.has(i)&&o.set(i,JSON.stringify(i==="/"?r:Ue(r,i)))})}),o.forEach((n,i)=>{let s=i==="/"?this._data:Ue(this._data,i);n!==JSON.stringify(s)&&this.subscribers.filter(([a,u])=>a===i).forEach(([a,u])=>{let d={};try{d=u(s,JSON.parse(n||{}))}catch(p){console.error(p.stack||p.message||p)}d instanceof Promise&&d.catch(p=>{console.error(p.stack||p.message||p)})})})}};function N(e,t,r){return e.constructor[Bt]||(e.constructor[Bt]=[]),e.constructor[Bt].push(t),{value:function(...o){let n=R(this._data);r.value.apply(this,o);let i=Ft(n,this._data);i.length!=0&&(this._mutationRecords.push(...i),this._version+=i.length,this.dispatch(i,n))}}}var Fe=class extends Ar{constructor(t){super(Object.assign({sid:"",ssid:""},t||{}))}setSID(t){this._data.sid=t,this._data.ssid=t.slice(0,4)}};T([N],Fe.prototype,"setSID",1);var pe=class extends Fe{constructor(t,r){super(t||{uname:"",comfyUserToken:"",activeDocumentID:0,documents:{},canvasStateID:0,selectionStateID:"",historyStateID:0}),this._version=r||0}setUName(t){this._data.uname="PS_"+t}setDocument(t,r){this._data.activeDocumentID=t,this._data.documents=r}setCanvasStateID(t){this._data.canvasStateID=t}setSelectionStateID(t){this._data.selectionStateID=t}setHistoryStateID(t){this._data.historyStateID=t}setComfyUserToken(t){this._data.comfyUserToken=t}};T([N],pe.prototype,"setUName",1),T([N],pe.prototype,"setDocument",1),T([N],pe.prototype,"setCanvasStateID",1),T([N],pe.prototype,"setSelectionStateID",1),T([N],pe.prototype,"setHistoryStateID",1),T([N],pe.prototype,"setComfyUserToken",1);var G=class extends Fe{constructor(t,r){super(t||{title:"",webviewFromSid:location.search.match(/webview_fromsid=([^&]+)/)?.[1]||"",progress:0,lastError:"",queueSize:0,executingNodeTitle:"",widgetTableStructure:{widgetTablePath:"",widgetTablePersisted:!1,widgetTableID:"",nodes:{},groups:{},nodeIndexes:[]},widgetTableValue:{},widgetTableErrors:{},hasPSDNodes:!1,maxImageWH:60606,comfyUserToken:""}),this._version=r||0}setWebviewFromSid(t){this._data.webviewFromSid=t}setTitle(t){this._data.title=t}setProgress(t){this._data.progress=t}setLastError(t){this._data.lastError=t}setQueueSize(t){this._data.queueSize=t}setExecutingNodeTitle(t){this._data.executingNodeTitle=t}setWidgetTableStructure(t){this._data.widgetTableStructure=JSON.parse(JSON.stringify(t))}setWidgetTableValue(t){this._data.widgetTableValue=JSON.parse(JSON.stringify(t))}setWidgetTableErrors(t){this._data.widgetTableErrors=JSON.parse(JSON.stringify(t))}setHasPSDNodes(t){this._data.hasPSDNodes=t}setMaxImageWH(t){this._data.maxImageWH=t}setComfyUserToken(t){this._data.comfyUserToken=t}};T([N],G.prototype,"setWebviewFromSid",1),T([N],G.prototype,"setTitle",1),T([N],G.prototype,"setProgress",1),T([N],G.prototype,"setLastError",1),T([N],G.prototype,"setQueueSize",1),T([N],G.prototype,"setExecutingNodeTitle",1),T([N],G.prototype,"setWidgetTableStructure",1),T([N],G.prototype,"setWidgetTableValue",1),T([N],G.prototype,"setWidgetTableErrors",1),T([N],G.prototype,"setHasPSDNodes",1),T([N],G.prototype,"setMaxImageWH",1),T([N],G.prototype,"setComfyUserToken",1);var Cr=class extends xt{createStore(t,r){return new G(t,r)}},_=new Cr,v=new pe;(async()=>{v.setUName(fo()),qt()})().catch(console.error);W.action.addNotificationListener(["historyStateChanged"],e=>{Pi(),(e.commandID==5004||e.commandID==5002)&&ft()});W.action.addNotificationListener(["toolModalStateChanged"],(e,t)=>{t.state._value=="exit"&&t.kind._value=="paint"&&ft()});W.action.addNotificationListener(["modalStateChanged"],(e,t)=>{t.state._value=="exit"&&ft()});W.action.addNotificationListener(["show","hide","transform","fill","crop"],()=>{ft()});W.action.addNotificationListener(["delete","move","copyToLayer"],()=>{qt(),ft()});W.action.addNotificationListener(["newDocument","open","close","make","modalJavaScriptScopeExit"],qt);function ft(){let e=W.app.activeDocument?.historyStates;e&&v.setCanvasStateID(e[e.length-1].id)}function Pi(){let e=W.app.activeDocument?.historyStates;e&&v.setHistoryStateID(e[e.length-1].id)}function ho(){v.setSelectionStateID(go+"_"+Vt+"_"+Qt)}var Vt=W.app.activeDocument?.id,Qt=W.app.activeDocument?.activeLayers.map(e=>e.id).join(","),go=0;W.action.addNotificationListener(["set"],(e,t)=>{t._target[0]._property=="selection"&&(go++,ho())});function yo(){let e=W.app.activeDocument?.activeLayers.map(t=>t.id).join(",");Vt!=W.app.activeDocument?.id||Qt!=e?(Vt=W.app.activeDocument?.id,Qt=e,ho()):(Vt=W.app.activeDocument?.id,Qt=e),requestAnimationFrame(yo)}requestAnimationFrame(yo);setInterval(qt,5e3);function qt(){try{if(!W.app.activeDocument)return;v.setDocument(W.app.activeDocument.id,W.app.documents.reduce((e,t)=>(e[t.id]={name:t.name,id:t.id,identify:he(t.id,t.name),layers:Pr(t).map(r=>({level:r.level,id:r.layer.id,name:r.layer.name,identify:Se(r.layer.id,r.layer.name,r.level),fullPath:r.path}))},e),{}))}catch(e){console.error(e)}}var Xe=w(A(),1);var O=w(A(),1);var I=w(A(),1);var Do=w(b(),1),bo=(0,I.createContext)(null);function vo({children:e}){let t=Si();return(0,I.useEffect)(()=>{window.addEventListener("message",o=>{o.data.action==="webview-connect"&&o.source?.postMessage({action:"webview-connect",payload:{webviewFromSid:v.data.sid}})});let r="";_.subscribe("/",(o,n,i)=>{n?.webviewFromSid==v.data.sid&&(t.setWebviewAgentSID(n?.sid),r||(r=n?.sid)),!n&&i.webviewFromSid==v.data.sid&&t.setWebviewAgentSID(r)})},[]),(0,Do.jsx)(bo.Provider,{value:{webviewAgentSID:t.webviewAgentSID,prevWebviewAgentSID:t.prevWebviewAgentSID,setWebviewAgentSID:t.setWebviewAgentSID,toggleWebviewDialog:t.toggleWebviewDialog,setSrc:t.setSrc,resetWebview:t.resetWebview},children:e})}function be(){let e=(0,I.useContext)(bo);if(!e)throw new Error("useSDPPPWebview must be used within a SDPPPWebviewProvider");return e}function Si(){let[e,t]=(0,I.useState)(null),[r,o]=(0,I.useState)(null),[n,i]=(0,I.useState)(null),[s,a]=(0,I.useState)(!1),[u,d]=(0,I.useState)(""),[p,h]=(0,I.useState)(""),[c,l]=(0,I.useState)(""),[f,g]=(0,I.useState)(!1),[y,P]=(0,I.useState)(!1),S=(0,I.useRef)(null);(0,I.useEffect)(()=>{let z=()=>{a(!1),h(c),oe()};return n?.addEventListener("close",z),()=>{n?.removeEventListener("close",z)}},[n,c,h,a]),(0,I.useEffect)(()=>{l(p)},[p]),(0,I.useEffect)(()=>{bi(i,o);let z=So();return t(z),S.current&&clearTimeout(S.current),g(!1),P(!1),S.current=setTimeout(()=>{g(!0)},5e3),z.addEventListener("loadstop",()=>{P(!0)}),()=>{S.current&&clearTimeout(S.current),n?.parentElement?.removeChild(n)}},[]);let[D,U]=(0,I.useState)("");(0,I.useEffect)(()=>{u&&(U(u),D===u?oe():(e?.setAttribute("src",u),r?.setAttribute("src",u)))},[u]);let oe=(0,I.useCallback)(()=>{e?.parentElement?.removeChild(e),a(!1),n?.close();let z=So();t(z);let Q=u;d(""),U(""),setTimeout(()=>{d(Q)},300)},[e,u]),it=(0,I.useCallback)(()=>{s?(n?.close(),a(!1)):(n?.show(),a(!0))},[n,s]);return{dialogShowing:s,toggleWebviewDialog:it,setSrc:d,webviewAgentSID:p,setWebviewAgentSID:h,prevWebviewAgentSID:c,setPrevWebviewAgentSID:l,resetWebview:oe,anyWebviewLoaded:y,timeoutError:(0,I.useMemo)(()=>f&&!y,[f,y])}}function bi(e,t){let r=document.createElement("dialog");r.className="sdppp-webview",r.style.padding="0",r.style.margin="0",r.style.width="1024px",r.style.height="768px",document.body.appendChild(r),e(r);let o=document.createElement("webview");return o.style.position="relative",o.style.width="1024px",o.style.height="768px",r.appendChild(o),t(o),r}var ye=null;function So(){ye||(ye=document.createElement("div"),ye.style.position="absolute",ye.style.width="100px",ye.style.height="100px",ye.style.right="0",ye.style.bottom="-10000px",document.body.appendChild(ye));let e=document.createElement("webview");return e.style.width="100px",e.style.height="100px",ye?.appendChild(e),e}var Lo=w(Ao(),1);var Co=`504
`;var Io=Co.trim();var Ir=class{socket;constructor(t){let r="/"+[t.split("/").slice(3).filter(o=>o).join("/"),"sd-ppp/"].filter(o=>o).join("/");t=t.split("/").slice(0,3).join("/"),this.socket=(0,Lo.io)(t,{transports:["websocket"],path:r,query:{api_level:Io},rejectUnauthorized:!1,autoConnect:!1}),this.socket.on("connect",()=>{this.socket.io.engine.binaryType="blob"})}get id(){return this.socket.id}connect(){this.socket.connect()}close(){this.socket.close(),this.socket.removeAllListeners()}};function _o(...e){return e.reduce((t,r)=>r(t),Ir)}var Gt=class{flushing=Promise.resolve();newFlushPending=!1;constructor(t){this.doFlush=t,this.pause()}doFlush;runFlush(){this.newFlushPending||(this.newFlushPending=!0,this.flushing=this.flushing.then(async()=>{await new Promise(t=>requestAnimationFrame(t)),this.newFlushPending=!1,await this.doFlush()}))}pause(){this.flushing=this.flushing.then(t=>new Promise(r=>{this.resume=r})).then(()=>{this.resume=()=>{}})}resume=()=>{}};function ko(e,t){return function(r){return class extends r{constructor(o){super(o),this.socket.on("store_request",(i,s)=>{s({data:e.data,version:e.version})});let n=new Gt(async()=>{let{operations:i,fromVersion:s,toVersion:a}=e.flush();await new Promise(u=>{let d=!1;setTimeout(()=>{d||(console.warn("flush timeout"),u())},5e3),this.socket.emit("store_flush",{operations:i,fromVersion:s},p=>{d=!0,u(),p?.error?console.error("flush error",p.error):e.flushDone(a)})})});e.subscribe("/",()=>{n.runFlush()}),this.socket.on("disconnect",()=>{n.pause()}),this.socket.on("connect",()=>{e.setSID(this.socket.id),requestAnimationFrame(()=>{this.socket.emit("sdppp_init",{type:t,data:e.data,version:e.version})})}),this.socket.on("sdppp_inited",i=>{n.resume()})}}}}function To(e,t){return function(r){return class extends r{constructor(o){super(o),this.socket.on("store_flush",n=>{if(n.type!==t)return;let i=e.getStore(n.sid);if(i)i.patchVersionAcceptable(n.fromVersion)?i.patchData(n.operations):(console.warn("patch version not acceptable from",n.fromVersion,"current version is",i.version),this.socket.emit("store_request",{type:t},s=>{e.sync(s)}));else return this.socket.emit("store_request",{sid:n.sid},s=>{e.addStore(s.sid,s.data,s.version)})}),this.socket.on("store_remove",n=>{e.removeStore(n.sid)}),this.socket.on("sdppp_inited",n=>{this.socket.emit("store_request",{type:t},i=>{e.sync(i)})})}}}}async function Lr(e){let t=e.document_identify,r=V(t);if(!r)throw new Error(m("document {0} not found",t));let o=r.selection,n=o&&o.bounds?{left:o.bounds.left,top:o.bounds.top,right:r.width-o.bounds.right,bottom:r.height-o.bounds.bottom,width:o.bounds.width,height:o.bounds.height}:null,i={left:0,top:0,right:0,bottom:0,width:r.width,height:r.height};return{document_boundary:i,selection_boundary:n||i}}var ht=k("photoshop");var ve=k("photoshop"),_r=class{promise;restore;constructor(){this.restore=()=>{},this.promise=new Promise(t=>{this.restore=t})}add(t){this.promise.then(t)}};ve.core.setExecutionMode({enableErrorStacktraces:!0});var pt=Promise.resolve();async function F(e,t){let r=t.dontRecoverSelection||!1,o=new _r,n=!1,i=[],s=[],a=t.commandName;r||(ve.app.activeDocument.activeLayers.forEach(h=>i.push(h)),t.document&&ve.app.activeDocument.id!=t.document.id&&t.document.activeLayers.forEach(h=>i.push(h)),s=i.map(h=>h.visible),o.add(()=>{i.forEach(h=>{h.selected||(h.selected=!0,n=!0)}),i.forEach((h,c)=>{h.visible=s[c]})}));let u=null;pt=pt.catch(h=>h).then(()=>new Promise(h=>{c();function c(){ve.core.isModal()?requestAnimationFrame(c):h()}})).then(()=>ve.core.executeAsModal(async function(h,...c){u=t.document?await h.hostControl.suspendHistory({documentID:t.document.id,name:a}):null,o.add(async()=>{await new Promise(requestAnimationFrame),n||u&&h.hostControl.resumeHistory(u)});try{let l=await e(o,h,...c);return o.restore(!0),l}catch(l){throw o.restore(!1),l}},{commandName:a,interactive:!0}));let d=null,p=null;try{await pt}catch(h){p=h}if(n&&(pt=ve.core.executeAsModal(async h=>{i.forEach((c,l)=>{c.visible=s[l]}),u&&h.hostControl.resumeHistory(u)},{commandName:a,interactive:!0}),await pt),p)throw p;return d}var Ye=w(mt(),1);function Di(e,t){for(let r=0,o=e.length/4;r<o;r++){let n=t?t[r]/255:1;e[4*r+3]=n*e[4*r+3],e[4*r+3]||(e[4*r]=e[4*r+1]=e[4*r+2]=0)}return e}function Ei(e){if(e.dataFromAPI.length!=e.width*e.height*3)throw new Error(m("unsupported channel counts: {0}",e.dataFromAPI.length/(e.width*e.height)));let t=new Uint8Array(e.width*e.height*4);for(let r=0;r<e.width*e.height;r++)t[r*4]=e.dataFromAPI[r*3],t[r*4+1]=e.dataFromAPI[r*3+1],t[r*4+2]=e.dataFromAPI[r*3+2],t[r*4+3]=255;return{dataFromAPI:t,width:e.width,height:e.height}}function Ht(e){if(e.dataFromAPI instanceof Uint8Array)return e;let{dataFromAPI:t,width:r,height:o}=e,n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)if(t instanceof Uint16Array)t[i]==32768?n[i]=255:n[i]=Math.floor(t[i]/128);else throw new Error("32-bit color not supported");return{dataFromAPI:n,width:r,height:o}}function Yt(e,t,r,o=4){if(e.width==r.width&&e.height==r.height&&e.dataFromAPI.length==r.width*r.height*o)return e.dataFromAPI;let n=new Uint8Array(r.width*r.height*o);return uo(e.dataFromAPI,n,t,r,o),n}async function Ai(e,t,r){let o={documentID:e.id,applyAlpha:!1,hasAlpha:!0,sourceBounds:r,colorSpace:"RGB"};e.mode!==ht.constants.DocumentMode.RGB&&Object.assign(o,{colorProfile:"sRGB IEC61966-2.1"}),t&&(o.layerID=t.id);let i=(await ht.imaging.getPixels(o)).imageData,s=await i.getData({});return Promise.resolve().then(()=>{i.dispose()}),{dataFromAPI:s,width:i.width,height:i.height}}async function Ci(e,t,r){if(!t)return null;let o={documentID:e.id,sourceBounds:r,layerID:t.id},n=null;try{n=await ht.imaging.getLayerMask(o)}catch(a){return console.warn(a),null}let i=n.imageData;if(!i)return null;let s=await i.getData({});return Promise.resolve().then(()=>{i.dispose()}),{dataFromAPI:s,width:i.width,height:i.height}}async function xo(e){let t=e.document_identify,r=V(t);if(!r)throw new Error(m("document {0} not found",t));let o=e.layer_identify,n=ne(r,o);if(e.boundary&&e.boundary.right+e.boundary.left+e.boundary.bottom+e.boundary.top+e.boundary.width+e.boundary.height!=r.width+r.height)throw new Error("The boundary is not for this document");let i=e.boundary?{left:e.boundary.left,top:e.boundary.top,right:r.width-e.boundary.right,bottom:r.height-e.boundary.bottom,width:e.boundary.width,height:e.boundary.height}:{left:0,top:0,right:r.width,bottom:r.height,width:r.width,height:r.height},s={pixelData:null,width:0,height:0},a=null,u,d,p={left:0,top:0,right:r.width,bottom:r.height},h=!1;if(await F(async f=>{let[g,y]=await Rt(r,n);y&&(a=g),a!=null&&f.add(()=>{a.delete()}),[u,d]=await Promise.all([Ai(r,g,i),Ci(r,g,i)]),p=g?.bounds??p,h=!1,g?h=g.transparentPixelsLocked:E.is_SPECIAL_LAYER_USE_CANVAS(o)&&(h=r.layers.every(P=>P.transparentPixelsLocked))},{commandName:m("get content of layer {0}",o),document:r}),!u)throw new Error(m("get pixel of {0} failed",o));u=Ht(u),h&&(u=Ei(u)),s.pixelData=Yt(u,p,i);let c=null;d&&(d=Ht(d),c=Yt(d,p,i,1)),s.pixelData=Di(s.pixelData,c),s.width=i.width,s.height=i.height;let l=new Ye.Jimp({data:Buffer.from(s.pixelData),width:i.width,height:i.height});if(e.max_wh&&(i.width>e.max_wh||i.height>e.max_wh)){let f=e.max_wh/Math.max(i.width,i.height);l.scale(f)}return l}async function No(e){let t=await xo(e),r=t.bitmap.width,o=t.bitmap.height,n=new Uint8Array(r*o);for(let a=0;a<r*o;a++)n[a]=t.bitmap.data[a*4+3];let i=new Ye.Jimp({width:r,height:o});for(let a=0;a<r*o;a++)i.bitmap.data[a*4+3]=t.bitmap.data[a*4+3];return{jpegData:new Uint8Array(await t.getBuffer(Ye.JimpMime.jpeg,{quality:e.quality})),alphaData:new Uint8Array(await i.getBuffer(Ye.JimpMime.png))}}No.getJimpImage=xo;var Kt=No;async function gt(e){let t=e.document_identify,r=V(t);if(!r)throw new Error(m("document {0} not found",t));if(!e.layer_identify)throw new Error(m("get_layer_info: layer_identify required"));let o={name:"",opacity:0,boundary:{left:0,right:0,top:0,bottom:0,width:r.width,height:r.height},isGroup:!1,identify:""};return await F(async n=>{let i=null,s=e.layer_identify,a=!1;if(e.layer_identify){s=e.layer_identify;let u=ne(r,s);if(E.is_SPECIAL_LAYER_USE_CANVAS(s))return o={name:"",opacity:1,boundary:{left:0,right:0,top:0,bottom:0,width:r.width,height:r.height},isGroup:!0,identify:s},o;[i,a]=await Rt(r,u),n.add(()=>{i&&a&&i.delete()})}if(!i)throw new Error(m("layer not found: {0}",e.layer_identify));o=Object.assign({isGroup:a,identify:s||""},lo(r,i))},{commandName:m("get layer info"),document:r}),o}var zt=k("photoshop");async function kr(e,t,r){let o=e.select||"all",n=e.document_identify,i=V(n);if(!i)throw new Error(m("document {0} not found",n));let s=e.layer_identifies,a=await Promise.all(s.map(async d=>{let p=ne(i,d);if(E.is_SPECIAL_LAYER_USE_CANVAS(d))throw new Error(m("layer not found: {0}",d));let h=de(i,p);if(!h)throw new Error(m("layer not found {0}",d));r(h);let c=t(h);if(o==="first"&&c.length===0)throw new Error(m("no first related layer in {0}",d));let l=c.filter((f,g)=>o==="first"?g===0:o==="text"?f.kind===zt.constants.LayerKind.TEXT:o==="image"?f.kind===zt.constants.LayerKind.NORMAL:!0).map(f=>Se(f.id,f.name));return{layer_identifies:l,layer_infos:await Promise.all(l.map(f=>gt({document_identify:n,layer_identify:f})))}})),u={layer_identifies:[],layer_boundaries:[],layer_infos:[]};return a.forEach(({layer_identifies:d,layer_infos:p})=>{u.layer_identifies.push(...d),u.layer_boundaries.push(...p.map(h=>h.boundary)),u.layer_infos.push(...p)}),u}async function Tr(e){return kr(e,t=>t.layers||[],t=>{if(t.kind!=zt.constants.LayerKind.GROUP)throw new Error(m("layer {0} is not a group",t.name));if(!t.layers)throw new Error(m("layer {0} is not a group",t.name))})}async function Rr(e){return kr(e,t=>t.linkedLayers||[],t=>{if(!t.linkedLayers)throw new Error(m("no linked layer for {0}",t.name))})}var Oo=k("photoshop"),Wo=k("uxp");async function Ii(e,t){let r={documentID:e.id,sourceBounds:t},n=(await Oo.imaging.getSelection(r)).imageData,i=await n.getData({});return Promise.resolve().then(()=>{n.dispose()}),{dataFromAPI:i,width:n.width,height:n.height}}async function yt(e){let t=e.document_identify,r=V(t);if(!r)throw new Error(m("document {0} not found",t));let o=parseInt(Wo.host.version.split(".")[0]);if(!isNaN(o)&&o<25)throw new Error(m("GetSelection need Photoshop version 25+"));let n=e.boundary?{left:e.boundary.left,top:e.boundary.top,right:r.width-e.boundary.right,bottom:r.height-e.boundary.bottom,width:e.boundary.width,height:e.boundary.height}:{left:0,top:0,right:r.width,bottom:r.height,width:r.width,height:r.height};if(!r.selection?.bounds){let s=new Uint8Array(n.width*n.height);return s.fill(255),{blob:s,width:n.width,height:n.height}}let i=null;return await F(async s=>{let a=await Ii(r,n);a=Ht(a);let u=r.selection.bounds||{left:0,top:0,right:r.width,bottom:r.height};i=a&&Yt(a,u,n,1)},{document:r,commandName:"SDPPP getSelection"}),{blob:i,width:n.width,height:n.height}}var ie=k("photoshop");async function xr(e){let{identifier:t}=e;if(E.is_SPECIAL_DOCUMENT_CURRENT(t)){if(!ie.app.activeDocument){if(e.width&&e.height){let r=await Li(e.width,e.height);if(r)return{value:he(r.id,r.name)}}throw new Error(m("document {0} not found",t))}return{value:he(ie.app.activeDocument.id,ie.app.activeDocument.name)}}else if(E.is_SPECIAL_LAYER_SELECTED_LAYER(t)){if(!ie.app.activeDocument)return{error:m("document {0} not found","current")};let r=ie.app.activeDocument.activeLayers[0];return r?{value:Se(r.id,r.name)}:{error:m("layer not found {0}",t)}}}async function Li(e,t){if(ie.app.activeDocument)return ie.app.activeDocument;let r=null;return await F(async()=>{r=await ie.app.createDocument({width:e,height:t,resolution:72,mode:ie.constants.NewDocumentMode.RGB,fill:ie.constants.DocumentFill.TRANSPARENT})},{document:null,commandName:m("create document for sent images")}),r}var Mo=k("photoshop");async function Nr(e){let t=e.document_identify,r=V(t);if(!r)throw new Error(m("document {0} not found",t));let o=e.layer_identify,n=ne(r,o),i={text:""},s=de(r,n);if(!s||s.kind!=Mo.constants.LayerKind.TEXT)throw new Error(m('only layer kind "TEXT" is supported, invalid layer: {0}',o));return i.text=s.textItem.contents,{text:i.text}}var $=k("photoshop"),Ke=k("uxp");var jt=0,Uo=0,_i=5e3;async function Or(e){let t=e.document_identify,r=t?V(t):null;if(e.action==="get"){let o;return await F(async function(n){if(r||(r=await ki()),!r)throw new Error(m("create document failed"));r=await r.duplicate(),n.add(async()=>{r?.close()});let s=await(await Ke.storage.localFileSystem.getTemporaryFolder()).createEntry("sdppp.psd",{overwrite:!0});await r.saveAs.psd(s,{maximizeCompatibility:!1,typename:"PhotoshopSaveOptions"}),o=await s.read({format:Ke.storage.formats.binary})},{commandName:m("sdppp get PSD"),document:r}),o?{data:o}:{error:"save Document failed"}}else if(e.action==="extract"){if(Date.now()-Uo<_i||jt>2||!confirm(m("{0} wants to extract a PSD file to Photoshop, are you sure?",e.fromSSID))){jt++,jt==3&&(confirm(m("should sdppp refuse extracting PSD to Photoshop in this session anymore?"))||jt--);return}Uo=Date.now();let o=e.data;await F(async function(){if(r||(r=await $.app.createDocument({width:512,height:512,resolution:72,mode:$.constants.NewDocumentMode.RGB,fill:$.constants.DocumentFill.TRANSPARENT})),!r)throw new Error(m("document {0} not found",t));$.app.activeDocument=r,r.selection?.deselect();let n=await o.arrayBuffer(),s=await(await Ke.storage.localFileSystem.getTemporaryFolder()).createEntry("sdppp.psd",{overwrite:!0});await s.write(n,{format:Ke.storage.formats.binary});let a=Ke.storage.localFileSystem.createSessionToken(s),u=await r.createLayer($.constants.LayerKind.NORMAL,{name:"sdppp"});if(!u)throw new Error(m("create layer failed"));u.move(r.layers[0],$.constants.ElementPlacement.PLACEBEFORE),await $.action.batchPlay([{_obj:"placeEvent",null:{_kind:"local",_path:a},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},{_obj:"placedLayerConvertToLayers"},{_obj:"ungroupLayersEvent",_target:[{_enum:"ordinal",_ref:"layer"}]}],{synchronousExecution:!0})},{commandName:m("sdppp extract PSD"),document:r,dontRecoverSelection:!0})}else throw new Error(m("invalid action: {0}",e.action))}async function ki(){return await $.app.createDocument({width:512,height:512,resolution:72,mode:$.constants.NewDocumentMode.RGB,fill:$.constants.DocumentFill.TRANSPARENT})}var Wr=k("photoshop");async function Mr(e){let{action_set:t,action:r}=e,o=Wr.app.actionTree.find(i=>i.name===t);if(!o)throw new Error(m("Action set {0} not found",t));let n=o.actions.find(i=>i.name===r);if(!n)throw new Error(m("Action {0} not found",r));return await F(async()=>{await n.play()},{commandName:m("sdppp Run Photoshop Action"),document:Wr.app.activeDocument}),{result:{success:!0}}}var Ur=w(mt(),1),X=k("photoshop");globalThis.sdpppX=globalThis.sdpppX||{};var we=globalThis.sdpppX;async function Ti(e,t){let r=X.app.documents.find(o=>o.name==E.getSpecialDocumentForPreview());if(r)return(r.width<e||r.height<t)&&await F(async()=>{await r.resizeCanvas(Math.max(r.width,e),Math.max(r.height,t))},{document:null,commandName:m("resize document for preview")}),r;{let o=null;return await F(async()=>{o=await X.app.createDocument({width:e,height:t,resolution:72,mode:X.constants.NewDocumentMode.RGB,fill:X.constants.DocumentFill.TRANSPARENT,name:E.getSpecialDocumentForPreview()})},{document:null,commandName:m("create document for preview")}),o}}var Fo=0;async function Fr(e){Fo++;let t=e.image_blobs?.length?e.image_blobs:null,r=e.image_urls?.length?e.image_urls:null,o=e.document_identify,n=e.layer_identifies,i=(await Promise.all((r||t||[]).map(async(h,c)=>{if(r)return await Ur.Jimp.read(r[c]);if(t)return await Ur.Jimp.read(await t[c].pngData.arrayBuffer())}))).filter(h=>h),s=V(o);if(E.is_SPECIAL_LAYER_PREVIEW_DOCUMENT(o)&&(s=await Ti(i[0].bitmap.width,i[0].bitmap.height)),!s)throw new Error(m("document {0} not found"));let a=s,u=i.map((h,c)=>{if(e.boundaries&&e.boundaries[c])return{width:e.boundaries[c].width,height:e.boundaries[c].height,top:e.boundaries[c].top,left:e.boundaries[c].left};let l=1;return(h.bitmap.height>a.height||h.bitmap.width>a.width)&&(l=Math.min(a.height/h.bitmap.height,a.width/h.bitmap.width)),{width:h.bitmap.width*l,height:h.bitmap.height*l,top:(a.height-h.bitmap.height*l)/2,left:(a.width-h.bitmap.width*l)/2,bottom:(a.height-h.bitmap.height*l)/2,right:(a.width-h.bitmap.width*l)/2}});i.forEach((h,c)=>{let l=u[c];if(h.bitmap.width!=l.width||h.bitmap.height!=l.height){let f={w:l.width,h:l.height};h.resize(f)}});let d=await Promise.all(i.map(async h=>{let c=h.bitmap.data;if(a.bitsPerChannel=="bitDepth16"){let f=new Uint16Array(c.length);for(let g=0;g<c.length;g+=4)f[g]=(c[g]<<7)+f[g],f[g+1]=(c[g+1]<<7)+f[g+1],f[g+2]=(c[g+2]<<7)+f[g+2],f[g+3]=c[g+3]<<7;c=f}else if(a.bitsPerChannel=="bitDepth32"){let l=new Float32Array(c.length);for(let f=0;f<c.length;f+=4)l[f]=c[f]/255,l[f+1]=c[f+1]/255,l[f+2]=c[f+2]/255,l[f+3]=c[f+3]/255;c=l}return await X.imaging.createImageDataFromBuffer(c,{width:h.bitmap.width,height:h.bitmap.height,components:4,colorProfile:"sRGB IEC61966-2.1",colorSpace:"RGB"})})),p=[];return await F(async h=>{let c=null,l=await Promise.all(i.map(async(f,g)=>{let y=n.length==1?n[0]:n[g];if(!E.is_SPECIAL_LAYER_NEW_LAYER(y)){let P=ne(a,y);c=de(a,P)}if(c&&c.kind!=X.constants.LayerKind.GROUP)return c;{let P=e.new_layer_name||"SDPPP Images";typeof we.handleSendLayerName=="function"&&(P=await we.handleSendLayerName(P));let S=await a.createLayer(X.constants.LayerKind.NORMAL,{name:`${P} ${Fo}${i.length>1?`_${g+1}`:""}`});if(!S)throw new Error(m("create layer failed"));return p.push(S),c?S.move(c,X.constants.ElementPlacement.PLACEINSIDE):S.move(a.layers[0],X.constants.ElementPlacement.PLACEBEFORE),S}}));p.length&&h.add(f=>{f?p.forEach((g,y)=>{g.selected=!1}):p.forEach(g=>g.delete())}),await Promise.all(l.map(async(f,g)=>{await X.imaging.putPixels({documentID:a.id,layerID:f.id,replace:!1,imageData:d[g],targetBounds:u[g]})}))},{commandName:m("show sent images"),document:a}),{}}var Bo=k("photoshop");async function Br(e){let t=e.document_identify,r=V(t);if(!r)throw new Error(m("document {0} not found",t));let o=e.layer_identify,n=ne(r,o),i=de(r,n);if(!i||i.kind!=Bo.constants.LayerKind.TEXT)throw new Error(m('only layer kind "TEXT" is supported, invalid layer: {0}',o));let s=!1;return await F(async()=>{console.log(e.text),i.textItem.contents=e.text,s=!0},{document:r,commandName:m("set text to layer")}),{success:s}}function Vo(e){return class extends e{constructor(t){super(t),this.socket.on("B_photoshop",async(r,o)=>{let{action:n,params:i}=r,s;try{console.log("B_photoshop start",n);let a=Date.now();n==="psd"?s=await Or(i):n==="getImage"?s=await Kt(i):n==="sendImages"?s=await Fr(i):n==="getSelection"?s=await yt(i):n==="getText"?s=await Nr(i):n==="sendText"?s=await Br(i):n==="getLayerInfo"?s=await gt(i):n==="getDocumentInfo"?s=await Lr(i):n==="getLinkedLayers"?s=await Rr(i):n==="getLayersInGroup"?s=await Tr(i):n==="runPhotoshopAction"?s=await Mr(i):n==="getSpecialIdentifierValue"&&(s=await xr(i));let u=Date.now();console.log("B_photoshop end",n,u-a)}catch(a){console.error(a),o({error:a.stack||a.message||a});return}o(s)})}async callForPSDExtract(t,r){return new Promise((o,n)=>{this.socket.emit("F_photoshop",{action:"extractPSD",sid:t,params:{from_sid:r.from_sid}},i=>{if(i.error)return n(new Error(i.error));o(i)})})}async uploadImage(t,r){return new Promise((o,n)=>{this.socket.emit("F_photoshop",{action:"uploadImage",sid:t,params:r},i=>{if(i.error)return n(new Error(i.error));o(i)})})}}}function Qo(e){return class extends e{constructor(t){super(t),this.socket.on("B_workflow",(r,o)=>{if(r.action=="getStoredWidgetValue"){let{widgetTableID:n,widgetTablePath:i,widgetTablePersisted:s}=r.params,a=`${n}_${i}_${s}`,u=Ri(a),d=[];u&&Object.keys(u||{}).forEach(p=>{Object.keys(u[p]||{}).forEach(h=>{d.push({nodeID:p,widgetIndex:h,value:u[p][h].value,outputType:u[p][h].outputType})})}),o({values:d})}})}async setNodeTitle(t,r,o){await new Promise((n,i)=>{this.socket.emit("F_workflow",{action:"setNodeTitle",sid:t,params:{node_id:r,title:o}},s=>{if(s?.error)return i(new Error(s.error));n(s)})})}async pageInstanceRun(t,r,o=1){await new Promise((n,i)=>{this.socket.emit("F_workflow",{action:"run",sid:t,params:{size:o,from_sid:r}},s=>{if(s?.error)return i(new Error(s.error));n(s)})})}async setWidgetValue(t,r){t&&await new Promise((o,n)=>{this.socket.emit("F_workflow",{action:"setWidgetValue",sid:t.data.sid,params:r},i=>{if(i?.error)return n(new Error(i.error));o(i)})})}async openWorkflow(t,r){t&&await new Promise((o,n)=>{this.socket.emit("F_workflow",{action:"open",sid:t.data.sid,params:r},i=>{if(i?.error)return n(new Error(i.error));o(i)})})}async saveWorkflow(t,r){t&&await new Promise((o,n)=>{this.socket.emit("F_workflow",{action:"save",sid:t.data.sid,params:r},i=>{if(i?.error)return n(new Error(i.error));o(i)})})}async listWorkflows(t){return t?await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"list",sid:t.data.sid},n=>{r(n)})}):[]}async logout(t){t&&await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"logout",sid:t.data.sid},n=>{if(n?.error)return o(new Error(n.error));r(n)})})}async interrupt(t){await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"interrupt",sid:t},n=>{r(n)})})}async clearQueue(t){await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"clearQueue",sid:t},n=>{r(n)})})}async reboot(t){return await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"reboot",sid:t},n=>{r(n)})})}}}function Ri(e){let t=localStorage.getItem(`widgetValue_${e}`);return t?JSON.parse(t):null}var Jt=class extends _o(ko(v,"photoshop"),To(_,"comfy"),Qo,Vo){constructor(t,{setConnectState:r,setLastErrorMessage:o,setBackendURL:n,setComfyMultiUser:i}){super(t),this.socket.on("connect_error",async s=>{if(this.socket.active){let a=s.message;try{let u=new AbortController,d=setTimeout(()=>u.abort(),1500),p=await fetch(t+this.socket._opts.path,{method:"GET",signal:u.signal});clearTimeout(d),p.status==502?a=m("502: Maybe the server is not running"):p.status==404&&(a=m("404: Maybe SDPPP is not installed or failed to run in ComfyUI"))}catch(u){u.message=="Network request failed"&&(a=m("Timeout, Maybe the URL is wrong"))}o(m("{0}. reconnecting...",a)),r("connecting")}else o(s.message),r("disconnected")}),this.socket.on("sdppp_inited",s=>{n(t),r("connected"),s.multi_user&&i(s.multi_user)}),this.socket.on("disconnect",(...s)=>{r("disconnected"),i(!1),v.setComfyUserToken("")})}};var Ho=w(b(),1),$t="http://127.0.0.1:8188",qo=(0,O.createContext)(null);function Go({children:e}){let{setSrc:t,webviewAgentSID:r,prevWebviewAgentSID:o}=be(),[n,i]=(0,O.useState)("disconnected"),[s,a]=(0,O.useState)(""),[u,d]=(0,O.useState)(localStorage.getItem("backendURL")||$t),[p,h]=(0,O.useState)(null),[c,l]=(0,O.useState)(""),[f,g]=(0,O.useState)(!1),[y,P]=(0,O.useState)(null),[S,D]=(0,O.useState)([]);function U(Q){d(Q.split("?")[0].split("#")[0].trim())}(0,O.useEffect)(()=>{localStorage.setItem("backendURL",u)},[u]),(0,O.useEffect)(()=>{n==="connected"?(a(""),t(`${u}`)):t("")},[n]);function oe(){if(n==="connected"||n==="connecting")y&&(y.close(),P(null),i("disconnected"));else try{let Q=y;y||(Q=new Jt(u||$t,{setConnectState:i,setLastErrorMessage:a,setBackendURL:U,setComfyMultiUser:g}),P(Q)),Q.connect(),i("connecting")}catch(Q){a(Q.stack||Q.message||Q)}}(0,O.useEffect)(()=>{let Q=(Ne,st,It)=>{c&&(!st&&Ne==c||!(c in _.getAllStore()))&&l("")};return _.subscribe("/",Q),()=>{_.unsubscribe(Q)}},[c]),(0,O.useEffect)(()=>{!c&&r&&l(r)},[c,r]),(0,O.useEffect)(()=>{r&&(!c||c==o)&&l(r)},[r,o,c,l]);let[it,z]=(0,O.useState)(null);return(0,O.useEffect)(()=>{z(c?_.getAllStore()[c]:null)},[c]),(0,Ho.jsx)(qo.Provider,{value:{socket:y,backendURL:u,setBackendURL:U,connectState:n,doConnectOrDisconnect:oe,lastErrorMessage:s,setLastErrorMessage:a,autoRunning:p,setAutoRunning:h,comfyMultiUser:f,setComfyMultiUser:g,workflowAgent:it,workflowAgentSID:c,setWorkflowAgentSID:l,beforeWorkflowRunHooks:S,setBeforeWorkflowRunHooks:D},children:e})}function L(){let e=(0,O.useContext)(qo);if(!e)throw new Error("useSDPPPInternalContext must be used within a SDPPPInternalContextProvider");return e}var Yo=w(A(),1);var Ko=w(b(),1),Be=class extends Yo.default.Component{state={hasError:!1,errorMessage:""};constructor(t){super(t)}static getDerivedStateFromError(t){return{hasError:!0,errorMessage:t.toString()}}componentDidCatch(t,r){console.log(t,r)}render(){return this.state.hasError?(0,Ko.jsx)("p",{className:"list-error-label",children:m("Error {0}... please contact me via Discord/Github",this.state.errorMessage)}):this.props.children}};var De=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){return this.listeners.add(e),this.onSubscribe(),()=>{this.listeners.delete(e),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}};var Ee=typeof window>"u"||"Deno"in globalThis;function j(){}function Jo(e,t){return typeof e=="function"?e(t):e}function $o(e){return typeof e=="number"&&e>=0&&e!==1/0}function Xo(e,t){return Math.max(e+(t||0)-Date.now(),0)}function Qr(e,t){return typeof e=="function"?e(t):e}function Zo(e,t){return typeof e=="function"?e(t):e}function qr(e,t){let{type:r="all",exact:o,fetchStatus:n,predicate:i,queryKey:s,stale:a}=e;if(s){if(o){if(t.queryHash!==wt(s,t.options))return!1}else if(!je(t.queryKey,s))return!1}if(r!=="all"){let u=t.isActive();if(r==="active"&&!u||r==="inactive"&&u)return!1}return!(typeof a=="boolean"&&t.isStale()!==a||n&&n!==t.state.fetchStatus||i&&!i(t))}function Gr(e,t){let{exact:r,status:o,predicate:n,mutationKey:i}=e;if(i){if(!t.options.mutationKey)return!1;if(r){if(ze(t.options.mutationKey)!==ze(i))return!1}else if(!je(t.options.mutationKey,i))return!1}return!(o&&t.state.status!==o||n&&!n(t))}function wt(e,t){return(t?.queryKeyHashFn||ze)(e)}function ze(e){return JSON.stringify(e,(t,r)=>Vr(r)?Object.keys(r).sort().reduce((o,n)=>(o[n]=r[n],o),{}):r)}function je(e,t){return e===t?!0:typeof e!=typeof t?!1:e&&t&&typeof e=="object"&&typeof t=="object"?Object.keys(t).every(r=>je(e[r],t[r])):!1}function en(e,t){if(e===t)return e;let r=zo(e)&&zo(t);if(r||Vr(e)&&Vr(t)){let o=r?e:Object.keys(e),n=o.length,i=r?t:Object.keys(t),s=i.length,a=r?[]:{},u=0;for(let d=0;d<s;d++){let p=r?d:i[d];(!r&&o.includes(p)||r)&&e[p]===void 0&&t[p]===void 0?(a[p]=void 0,u++):(a[p]=en(e[p],t[p]),a[p]===e[p]&&e[p]!==void 0&&u++)}return n===s&&u===n?e:a}return t}function zo(e){return Array.isArray(e)&&e.length===Object.keys(e).length}function Vr(e){if(!jo(e))return!1;let t=e.constructor;if(t===void 0)return!0;let r=t.prototype;return!(!jo(r)||!r.hasOwnProperty("isPrototypeOf")||Object.getPrototypeOf(e)!==Object.prototype)}function jo(e){return Object.prototype.toString.call(e)==="[object Object]"}function tn(e){return new Promise(t=>{setTimeout(t,e)})}function rn(e,t,r){return typeof r.structuralSharing=="function"?r.structuralSharing(e,t):r.structuralSharing!==!1?en(e,t):t}function on(e,t,r=0){let o=[...e,t];return r&&o.length>r?o.slice(1):o}function nn(e,t,r=0){let o=[t,...e];return r&&o.length>r?o.slice(0,-1):o}var Pt=Symbol();function Xt(e,t){return!e.queryFn&&t?.initialPromise?()=>t.initialPromise:!e.queryFn||e.queryFn===Pt?()=>Promise.reject(new Error(`Missing queryFn: '${e.queryHash}'`)):e.queryFn}var xi=class extends De{#e;#t;#r;constructor(){super(),this.#r=e=>{if(!Ee&&window.addEventListener){let t=()=>e();return window.addEventListener("visibilitychange",t,!1),()=>{window.removeEventListener("visibilitychange",t)}}}}onSubscribe(){this.#t||this.setEventListener(this.#r)}onUnsubscribe(){this.hasListeners()||(this.#t?.(),this.#t=void 0)}setEventListener(e){this.#r=e,this.#t?.(),this.#t=e(t=>{typeof t=="boolean"?this.setFocused(t):this.onFocus()})}setFocused(e){this.#e!==e&&(this.#e=e,this.onFocus())}onFocus(){let e=this.isFocused();this.listeners.forEach(t=>{t(e)})}isFocused(){return typeof this.#e=="boolean"?this.#e:globalThis.document?.visibilityState!=="hidden"}},Zt=new xi;var Ni=class extends De{#e=!0;#t;#r;constructor(){super(),this.#r=e=>{if(!Ee&&window.addEventListener){let t=()=>e(!0),r=()=>e(!1);return window.addEventListener("online",t,!1),window.addEventListener("offline",r,!1),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",r)}}}}onSubscribe(){this.#t||this.setEventListener(this.#r)}onUnsubscribe(){this.hasListeners()||(this.#t?.(),this.#t=void 0)}setEventListener(e){this.#r=e,this.#t?.(),this.#t=e(this.setOnline.bind(this))}setOnline(e){this.#e!==e&&(this.#e=e,this.listeners.forEach(r=>{r(e)}))}isOnline(){return this.#e}},Je=new Ni;function sn(){let e,t,r=new Promise((n,i)=>{e=n,t=i});r.status="pending",r.catch(()=>{});function o(n){Object.assign(r,n),delete r.resolve,delete r.reject}return r.resolve=n=>{o({status:"fulfilled",value:n}),e(n)},r.reject=n=>{o({status:"rejected",reason:n}),t(n)},r}function Oi(e){return Math.min(1e3*2**e,3e4)}function Hr(e){return(e??"online")==="online"?Je.isOnline():!0}var an=class extends Error{constructor(e){super("CancelledError"),this.revert=e?.revert,this.silent=e?.silent}};function er(e){return e instanceof an}function tr(e){let t=!1,r=0,o=!1,n,i=sn(),s=g=>{o||(c(new an(g)),e.abort?.())},a=()=>{t=!0},u=()=>{t=!1},d=()=>Zt.isFocused()&&(e.networkMode==="always"||Je.isOnline())&&e.canRun(),p=()=>Hr(e.networkMode)&&e.canRun(),h=g=>{o||(o=!0,e.onSuccess?.(g),n?.(),i.resolve(g))},c=g=>{o||(o=!0,e.onError?.(g),n?.(),i.reject(g))},l=()=>new Promise(g=>{n=y=>{(o||d())&&g(y)},e.onPause?.()}).then(()=>{n=void 0,o||e.onContinue?.()}),f=()=>{if(o)return;let g,y=r===0?e.initialPromise:void 0;try{g=y??e.fn()}catch(P){g=Promise.reject(P)}Promise.resolve(g).then(h).catch(P=>{if(o)return;let S=e.retry??(Ee?0:3),D=e.retryDelay??Oi,U=typeof D=="function"?D(r,P):D,oe=S===!0||typeof S=="number"&&r<S||typeof S=="function"&&S(r,P);if(t||!oe){c(P);return}r++,e.onFail?.(r,P),tn(U).then(()=>d()?void 0:l()).then(()=>{t?c(P):f()})})};return{promise:i,cancel:s,continue:()=>(n?.(),i),cancelRetry:a,continueRetry:u,canStart:p,start:()=>(p()?f():l().then(f),i)}}var Wi=e=>setTimeout(e,0);function Mi(){let e=[],t=0,r=a=>{a()},o=a=>{a()},n=Wi,i=a=>{t?e.push(a):n(()=>{r(a)})},s=()=>{let a=e;e=[],a.length&&n(()=>{o(()=>{a.forEach(u=>{r(u)})})})};return{batch:a=>{let u;t++;try{u=a()}finally{t--,t||s()}return u},batchCalls:a=>(...u)=>{i(()=>{a(...u)})},schedule:i,setNotifyFunction:a=>{r=a},setBatchNotifyFunction:a=>{o=a},setScheduler:a=>{n=a}}}var M=Mi();var rr=class{#e;destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),$o(this.gcTime)&&(this.#e=setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(e){this.gcTime=Math.max(this.gcTime||0,e??(Ee?1/0:5*60*1e3))}clearGcTimeout(){this.#e&&(clearTimeout(this.#e),this.#e=void 0)}};var un=class extends rr{#e;#t;#r;#n;#o;#s;#a;constructor(e){super(),this.#a=!1,this.#s=e.defaultOptions,this.setOptions(e.options),this.observers=[],this.#n=e.client,this.#r=this.#n.getQueryCache(),this.queryKey=e.queryKey,this.queryHash=e.queryHash,this.#e=Fi(this.options),this.state=e.state??this.#e,this.scheduleGc()}get meta(){return this.options.meta}get promise(){return this.#o?.promise}setOptions(e){this.options={...this.#s,...e},this.updateGcTime(this.options.gcTime)}optionalRemove(){!this.observers.length&&this.state.fetchStatus==="idle"&&this.#r.remove(this)}setData(e,t){let r=rn(this.state.data,e,this.options);return this.#i({data:r,type:"success",dataUpdatedAt:t?.updatedAt,manual:t?.manual}),r}setState(e,t){this.#i({type:"setState",state:e,setStateOptions:t})}cancel(e){let t=this.#o?.promise;return this.#o?.cancel(e),t?t.then(j).catch(j):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.#e)}isActive(){return this.observers.some(e=>Zo(e.options.enabled,this)!==!1)}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===Pt||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStale(){return this.state.isInvalidated?!0:this.getObserversCount()>0?this.observers.some(e=>e.getCurrentResult().isStale):this.state.data===void 0}isStaleByTime(e=0){return this.state.isInvalidated||this.state.data===void 0||!Xo(this.state.dataUpdatedAt,e)}onFocus(){this.observers.find(t=>t.shouldFetchOnWindowFocus())?.refetch({cancelRefetch:!1}),this.#o?.continue()}onOnline(){this.observers.find(t=>t.shouldFetchOnReconnect())?.refetch({cancelRefetch:!1}),this.#o?.continue()}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.#r.notify({type:"observerAdded",query:this,observer:e}))}removeObserver(e){this.observers.includes(e)&&(this.observers=this.observers.filter(t=>t!==e),this.observers.length||(this.#o&&(this.#a?this.#o.cancel({revert:!0}):this.#o.cancelRetry()),this.scheduleGc()),this.#r.notify({type:"observerRemoved",query:this,observer:e}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.#i({type:"invalidate"})}fetch(e,t){if(this.state.fetchStatus!=="idle"){if(this.state.data!==void 0&&t?.cancelRefetch)this.cancel({silent:!0});else if(this.#o)return this.#o.continueRetry(),this.#o.promise}if(e&&this.setOptions(e),!this.options.queryFn){let a=this.observers.find(u=>u.options.queryFn);a&&this.setOptions(a.options)}let r=new AbortController,o=a=>{Object.defineProperty(a,"signal",{enumerable:!0,get:()=>(this.#a=!0,r.signal)})},n=()=>{let a=Xt(this.options,t),u={client:this.#n,queryKey:this.queryKey,meta:this.meta};return o(u),this.#a=!1,this.options.persister?this.options.persister(a,u,this):a(u)},i={fetchOptions:t,options:this.options,queryKey:this.queryKey,client:this.#n,state:this.state,fetchFn:n};o(i),this.options.behavior?.onFetch(i,this),this.#t=this.state,(this.state.fetchStatus==="idle"||this.state.fetchMeta!==i.fetchOptions?.meta)&&this.#i({type:"fetch",meta:i.fetchOptions?.meta});let s=a=>{er(a)&&a.silent||this.#i({type:"error",error:a}),er(a)||(this.#r.config.onError?.(a,this),this.#r.config.onSettled?.(this.state.data,a,this)),this.scheduleGc()};return this.#o=tr({initialPromise:t?.initialPromise,fn:i.fetchFn,abort:r.abort.bind(r),onSuccess:a=>{if(a===void 0){s(new Error(`${this.queryHash} data is undefined`));return}try{this.setData(a)}catch(u){s(u);return}this.#r.config.onSuccess?.(a,this),this.#r.config.onSettled?.(a,this.state.error,this),this.scheduleGc()},onError:s,onFail:(a,u)=>{this.#i({type:"failed",failureCount:a,error:u})},onPause:()=>{this.#i({type:"pause"})},onContinue:()=>{this.#i({type:"continue"})},retry:i.options.retry,retryDelay:i.options.retryDelay,networkMode:i.options.networkMode,canRun:()=>!0}),this.#o.start()}#i(e){let t=r=>{switch(e.type){case"failed":return{...r,fetchFailureCount:e.failureCount,fetchFailureReason:e.error};case"pause":return{...r,fetchStatus:"paused"};case"continue":return{...r,fetchStatus:"fetching"};case"fetch":return{...r,...Ui(r.data,this.options),fetchMeta:e.meta??null};case"success":return{...r,data:e.data,dataUpdateCount:r.dataUpdateCount+1,dataUpdatedAt:e.dataUpdatedAt??Date.now(),error:null,isInvalidated:!1,status:"success",...!e.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};case"error":let o=e.error;return er(o)&&o.revert&&this.#t?{...this.#t,fetchStatus:"idle"}:{...r,error:o,errorUpdateCount:r.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:r.fetchFailureCount+1,fetchFailureReason:o,fetchStatus:"idle",status:"error"};case"invalidate":return{...r,isInvalidated:!0};case"setState":return{...r,...e.state}}};this.state=t(this.state),M.batch(()=>{this.observers.forEach(r=>{r.onQueryUpdate()}),this.#r.notify({query:this,type:"updated",action:e})})}};function Ui(e,t){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:Hr(t.networkMode)?"fetching":"paused",...e===void 0&&{error:null,status:"pending"}}}function Fi(e){let t=typeof e.initialData=="function"?e.initialData():e.initialData,r=t!==void 0,o=r?typeof e.initialDataUpdatedAt=="function"?e.initialDataUpdatedAt():e.initialDataUpdatedAt:0;return{data:t,dataUpdateCount:0,dataUpdatedAt:r?o??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:r?"success":"pending",fetchStatus:"idle"}}var cn=class extends De{constructor(e={}){super(),this.config=e,this.#e=new Map}#e;build(e,t,r){let o=t.queryKey,n=t.queryHash??wt(o,t),i=this.get(n);return i||(i=new un({client:e,queryKey:o,queryHash:n,options:e.defaultQueryOptions(t),state:r,defaultOptions:e.getQueryDefaults(o)}),this.add(i)),i}add(e){this.#e.has(e.queryHash)||(this.#e.set(e.queryHash,e),this.notify({type:"added",query:e}))}remove(e){let t=this.#e.get(e.queryHash);t&&(e.destroy(),t===e&&this.#e.delete(e.queryHash),this.notify({type:"removed",query:e}))}clear(){M.batch(()=>{this.getAll().forEach(e=>{this.remove(e)})})}get(e){return this.#e.get(e)}getAll(){return[...this.#e.values()]}find(e){let t={exact:!0,...e};return this.getAll().find(r=>qr(t,r))}findAll(e={}){let t=this.getAll();return Object.keys(e).length>0?t.filter(r=>qr(e,r)):t}notify(e){M.batch(()=>{this.listeners.forEach(t=>{t(e)})})}onFocus(){M.batch(()=>{this.getAll().forEach(e=>{e.onFocus()})})}onOnline(){M.batch(()=>{this.getAll().forEach(e=>{e.onOnline()})})}};var ln=class extends rr{#e;#t;#r;constructor(e){super(),this.mutationId=e.mutationId,this.#t=e.mutationCache,this.#e=[],this.state=e.state||Bi(),this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options=e,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(e){this.#e.includes(e)||(this.#e.push(e),this.clearGcTimeout(),this.#t.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.#e=this.#e.filter(t=>t!==e),this.scheduleGc(),this.#t.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.#e.length||(this.state.status==="pending"?this.scheduleGc():this.#t.remove(this))}continue(){return this.#r?.continue()??this.execute(this.state.variables)}async execute(e){let t=()=>{this.#n({type:"continue"})};this.#r=tr({fn:()=>this.options.mutationFn?this.options.mutationFn(e):Promise.reject(new Error("No mutationFn found")),onFail:(n,i)=>{this.#n({type:"failed",failureCount:n,error:i})},onPause:()=>{this.#n({type:"pause"})},onContinue:t,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#t.canRun(this)});let r=this.state.status==="pending",o=!this.#r.canStart();try{if(r)t();else{this.#n({type:"pending",variables:e,isPaused:o}),await this.#t.config.onMutate?.(e,this);let i=await this.options.onMutate?.(e);i!==this.state.context&&this.#n({type:"pending",context:i,variables:e,isPaused:o})}let n=await this.#r.start();return await this.#t.config.onSuccess?.(n,e,this.state.context,this),await this.options.onSuccess?.(n,e,this.state.context),await this.#t.config.onSettled?.(n,null,this.state.variables,this.state.context,this),await this.options.onSettled?.(n,null,e,this.state.context),this.#n({type:"success",data:n}),n}catch(n){try{throw await this.#t.config.onError?.(n,e,this.state.context,this),await this.options.onError?.(n,e,this.state.context),await this.#t.config.onSettled?.(void 0,n,this.state.variables,this.state.context,this),await this.options.onSettled?.(void 0,n,e,this.state.context),n}finally{this.#n({type:"error",error:n})}}finally{this.#t.runNext(this)}}#n(e){let t=r=>{switch(e.type){case"failed":return{...r,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...r,isPaused:!0};case"continue":return{...r,isPaused:!1};case"pending":return{...r,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:e.isPaused,status:"pending",variables:e.variables,submittedAt:Date.now()};case"success":return{...r,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...r,data:void 0,error:e.error,failureCount:r.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"}}};this.state=t(this.state),M.batch(()=>{this.#e.forEach(r=>{r.onMutationUpdate(e)}),this.#t.notify({mutation:this,type:"updated",action:e})})}};function Bi(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}var dn=class extends De{constructor(e={}){super(),this.config=e,this.#e=new Set,this.#t=new Map,this.#r=0}#e;#t;#r;build(e,t,r){let o=new ln({mutationCache:this,mutationId:++this.#r,options:e.defaultMutationOptions(t),state:r});return this.add(o),o}add(e){this.#e.add(e);let t=or(e);if(typeof t=="string"){let r=this.#t.get(t);r?r.push(e):this.#t.set(t,[e])}this.notify({type:"added",mutation:e})}remove(e){if(this.#e.delete(e)){let t=or(e);if(typeof t=="string"){let r=this.#t.get(t);if(r)if(r.length>1){let o=r.indexOf(e);o!==-1&&r.splice(o,1)}else r[0]===e&&this.#t.delete(t)}}this.notify({type:"removed",mutation:e})}canRun(e){let t=or(e);if(typeof t=="string"){let o=this.#t.get(t)?.find(n=>n.state.status==="pending");return!o||o===e}else return!0}runNext(e){let t=or(e);return typeof t=="string"?this.#t.get(t)?.find(o=>o!==e&&o.state.isPaused)?.continue()??Promise.resolve():Promise.resolve()}clear(){M.batch(()=>{this.#e.forEach(e=>{this.notify({type:"removed",mutation:e})}),this.#e.clear(),this.#t.clear()})}getAll(){return Array.from(this.#e)}find(e){let t={exact:!0,...e};return this.getAll().find(r=>Gr(t,r))}findAll(e={}){return this.getAll().filter(t=>Gr(e,t))}notify(e){M.batch(()=>{this.listeners.forEach(t=>{t(e)})})}resumePausedMutations(){let e=this.getAll().filter(t=>t.state.isPaused);return M.batch(()=>Promise.all(e.map(t=>t.continue().catch(j))))}};function or(e){return e.options.scope?.id}function Yr(e){return{onFetch:(t,r)=>{let o=t.options,n=t.fetchOptions?.meta?.fetchMore?.direction,i=t.state.data?.pages||[],s=t.state.data?.pageParams||[],a={pages:[],pageParams:[]},u=0,d=async()=>{let p=!1,h=f=>{Object.defineProperty(f,"signal",{enumerable:!0,get:()=>(t.signal.aborted?p=!0:t.signal.addEventListener("abort",()=>{p=!0}),t.signal)})},c=Xt(t.options,t.fetchOptions),l=async(f,g,y)=>{if(p)return Promise.reject();if(g==null&&f.pages.length)return Promise.resolve(f);let P={client:t.client,queryKey:t.queryKey,pageParam:g,direction:y?"backward":"forward",meta:t.options.meta};h(P);let S=await c(P),{maxPages:D}=t.options,U=y?nn:on;return{pages:U(f.pages,S,D),pageParams:U(f.pageParams,g,D)}};if(n&&i.length){let f=n==="backward",g=f?Vi:fn,y={pages:i,pageParams:s},P=g(o,y);a=await l(y,P,f)}else{let f=e??i.length;do{let g=u===0?s[0]??o.initialPageParam:fn(o,a);if(u>0&&g==null)break;a=await l(a,g),u++}while(u<f)}return a};t.options.persister?t.fetchFn=()=>t.options.persister?.(d,{client:t.client,queryKey:t.queryKey,meta:t.options.meta,signal:t.signal},r):t.fetchFn=d}}}function fn(e,{pages:t,pageParams:r}){let o=t.length-1;return t.length>0?e.getNextPageParam(t[o],t,r[o],r):void 0}function Vi(e,{pages:t,pageParams:r}){return t.length>0?e.getPreviousPageParam?.(t[0],t,r[0],r):void 0}var Kr=class{#e;#t;#r;#n;#o;#s;#a;#i;constructor(e={}){this.#e=e.queryCache||new cn,this.#t=e.mutationCache||new dn,this.#r=e.defaultOptions||{},this.#n=new Map,this.#o=new Map,this.#s=0}mount(){this.#s++,this.#s===1&&(this.#a=Zt.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#e.onFocus())}),this.#i=Je.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#e.onOnline())}))}unmount(){this.#s--,this.#s===0&&(this.#a?.(),this.#a=void 0,this.#i?.(),this.#i=void 0)}isFetching(e){return this.#e.findAll({...e,fetchStatus:"fetching"}).length}isMutating(e){return this.#t.findAll({...e,status:"pending"}).length}getQueryData(e){let t=this.defaultQueryOptions({queryKey:e});return this.#e.get(t.queryHash)?.state.data}ensureQueryData(e){let t=this.defaultQueryOptions(e),r=this.#e.build(this,t),o=r.state.data;return o===void 0?this.fetchQuery(e):(e.revalidateIfStale&&r.isStaleByTime(Qr(t.staleTime,r))&&this.prefetchQuery(t),Promise.resolve(o))}getQueriesData(e){return this.#e.findAll(e).map(({queryKey:t,state:r})=>{let o=r.data;return[t,o]})}setQueryData(e,t,r){let o=this.defaultQueryOptions({queryKey:e}),i=this.#e.get(o.queryHash)?.state.data,s=Jo(t,i);if(s!==void 0)return this.#e.build(this,o).setData(s,{...r,manual:!0})}setQueriesData(e,t,r){return M.batch(()=>this.#e.findAll(e).map(({queryKey:o})=>[o,this.setQueryData(o,t,r)]))}getQueryState(e){let t=this.defaultQueryOptions({queryKey:e});return this.#e.get(t.queryHash)?.state}removeQueries(e){let t=this.#e;M.batch(()=>{t.findAll(e).forEach(r=>{t.remove(r)})})}resetQueries(e,t){let r=this.#e;return M.batch(()=>(r.findAll(e).forEach(o=>{o.reset()}),this.refetchQueries({type:"active",...e},t)))}cancelQueries(e,t={}){let r={revert:!0,...t},o=M.batch(()=>this.#e.findAll(e).map(n=>n.cancel(r)));return Promise.all(o).then(j).catch(j)}invalidateQueries(e,t={}){return M.batch(()=>(this.#e.findAll(e).forEach(r=>{r.invalidate()}),e?.refetchType==="none"?Promise.resolve():this.refetchQueries({...e,type:e?.refetchType??e?.type??"active"},t)))}refetchQueries(e,t={}){let r={...t,cancelRefetch:t.cancelRefetch??!0},o=M.batch(()=>this.#e.findAll(e).filter(n=>!n.isDisabled()).map(n=>{let i=n.fetch(void 0,r);return r.throwOnError||(i=i.catch(j)),n.state.fetchStatus==="paused"?Promise.resolve():i}));return Promise.all(o).then(j)}fetchQuery(e){let t=this.defaultQueryOptions(e);t.retry===void 0&&(t.retry=!1);let r=this.#e.build(this,t);return r.isStaleByTime(Qr(t.staleTime,r))?r.fetch(t):Promise.resolve(r.state.data)}prefetchQuery(e){return this.fetchQuery(e).then(j).catch(j)}fetchInfiniteQuery(e){return e.behavior=Yr(e.pages),this.fetchQuery(e)}prefetchInfiniteQuery(e){return this.fetchInfiniteQuery(e).then(j).catch(j)}ensureInfiniteQueryData(e){return e.behavior=Yr(e.pages),this.ensureQueryData(e)}resumePausedMutations(){return Je.isOnline()?this.#t.resumePausedMutations():Promise.resolve()}getQueryCache(){return this.#e}getMutationCache(){return this.#t}getDefaultOptions(){return this.#r}setDefaultOptions(e){this.#r=e}setQueryDefaults(e,t){this.#n.set(ze(e),{queryKey:e,defaultOptions:t})}getQueryDefaults(e){let t=[...this.#n.values()],r={};return t.forEach(o=>{je(e,o.queryKey)&&Object.assign(r,o.defaultOptions)}),r}setMutationDefaults(e,t){this.#o.set(ze(e),{mutationKey:e,defaultOptions:t})}getMutationDefaults(e){let t=[...this.#o.values()],r={};return t.forEach(o=>{je(e,o.mutationKey)&&Object.assign(r,o.defaultOptions)}),r}defaultQueryOptions(e){if(e._defaulted)return e;let t={...this.#r.queries,...this.getQueryDefaults(e.queryKey),...e,_defaulted:!0};return t.queryHash||(t.queryHash=wt(t.queryKey,t)),t.refetchOnReconnect===void 0&&(t.refetchOnReconnect=t.networkMode!=="always"),t.throwOnError===void 0&&(t.throwOnError=!!t.suspense),!t.networkMode&&t.persister&&(t.networkMode="offlineFirst"),t.queryFn===Pt&&(t.enabled=!1),t}defaultMutationOptions(e){return e?._defaulted?e:{...this.#r.mutations,...e?.mutationKey&&this.getMutationDefaults(e.mutationKey),...e,_defaulted:!0}}clear(){this.#e.clear(),this.#t.clear()}};var St=w(A(),1),pn=w(b(),1),mn=St.createContext(void 0);var zr=({client:e,children:t})=>(St.useEffect(()=>(e.mount(),()=>{e.unmount()}),[e]),(0,pn.jsx)(mn.Provider,{value:e,children:t}));var Ce=w(A(),1);var J=w(A(),1);var nr=w(A(),1);function hn(){let{workflowAgent:e,socket:t}=L();return{setWidgetValue:(0,nr.useCallback)(async(o,n,i)=>{if(!e)throw new Error("workflowAgent not found");await t?.setWidgetValue(e,{values:[{nodeID:o,widgetIndex:n,value:i}]});let s=e.data.widgetTableStructure.widgetTableID,a=e.data.widgetTableStructure.widgetTablePath,u=e.data.widgetTableStructure.widgetTablePersisted,d=`${s}_${a}_${u}`,p=e.data.widgetTableStructure.nodes[o].widgets[n].outputType;Qi(d,o,n,i,p)},[e,t])}}function $e(){let{beforeWorkflowRunHooks:e,setBeforeWorkflowRunHooks:t}=L(),r=(0,nr.useCallback)(n=>(t(i=>[...i,n]),()=>{t(i=>i.filter(a=>a!==n))}),[t]),o=(0,nr.useCallback)(async()=>{for(let n=0;n<e.length;n++)await e[n]()},[e]);return{addBeforeWorkflowRunHook:r,triggerBeforeWorkflowRun:o}}function Qi(e,t,r,o,n){let i=localStorage.getItem(`widgetValue_${e}`),s=i?JSON.parse(i):{};s[t]=s[t]||[],s[t][r]={value:o,outputType:n},localStorage.setItem(`widgetValue_${e}`,JSON.stringify(s))}var jr=k("photoshop");function se(){let{socket:e}=L(),{workflowAgentSID:t}=Ae(),{triggerBeforeWorkflowRun:r}=$e(),o=(0,J.useCallback)(async(y,P,S=!1)=>{let D=_.getStore(y);if(!D)throw new Error("workflowAgent not found");try{await e?.openWorkflow(D,{workflow_path:P,from_sid:v.data.sid,reset:S})}catch{}},[e]),n=(0,J.useCallback)(async y=>{let P=_.getStore(y);if(!P||!P.data.widgetTableStructure.widgetTablePath)throw new Error("workflow not found");if(!P.data.widgetTableStructure.widgetTablePersisted)throw new Error("workflow is not savable");await o(y,P.data.widgetTableStructure.widgetTablePath,!0)},[o]),i=(0,J.useCallback)((y,P=1)=>{e?.pageInstanceRun(y,v.data.sid,P)},[e]),s=(0,J.useCallback)(async y=>{let P=_.getStore(y);if(!P)throw new Error("workflowAgent not found");if(!P.data.widgetTableStructure.widgetTablePath)throw new Error("workflow not found");await e?.saveWorkflow(P,{workflow_path:P.data.widgetTableStructure.widgetTablePath,from_sid:v.data.sid})},[e]),a=(0,J.useCallback)(async y=>{await e?.callForPSDExtract(y,{from_sid:v.data.sid})},[e]),u=(0,J.useCallback)(async y=>{let P=_.getStore(y);if(!P)throw new Error("workflowAgent not found");await e?.logout(P)},[e]),d=(0,J.useCallback)(async(y,P)=>await e?.uploadImage(v.data.sid,{image:y,filename:P,overwrite:!0}),[e]);globalThis.sdppp_action_run=async(y,{workflowPath:P})=>{P?await c(P):await h()};let p=(0,J.useCallback)(async(y,P=1)=>{!y&&!t||(await r(),await i(y||t,P))},[i,t,r]),h=(0,J.useCallback)(async(y,P=1)=>{await p(y||t,P),jr.action.recordAction?.({name:"sdppp_run",methodName:"sdppp_action_run"},{})},[p]),c=(0,J.useCallback)(async(y,P,S=1)=>{!P&&!t||(await o(P||t,y),await p(P||t,S),jr.action.recordAction?.({name:"sdppp_run_"+y,methodName:"sdppp_action_run"},{workflowPath:y}))},[o,h,t]),l=(0,J.useCallback)(async()=>{t&&await e?.interrupt(t)},[e,t]),f=(0,J.useCallback)(async()=>{t&&await e?.clearQueue(t)},[e,t]),g=(0,J.useCallback)(async()=>{if(t)return await e?.reboot(t)},[e,t]);return{openWorkflow:o,reopenWorkflow:n,saveWorkflow:s,runPage:h,runWorkflow:c,callForPSDExtract:a,logout:u,uploadImage:d,interrupt:l,clearQueue:f,reboot:g}}function ir(){let[e,t]=(0,Ce.useState)(!1),[r,o]=(0,Ce.useState)(!1),n=(0,Ce.useRef)(null),{autoRunning:i,workflowAgent:s}=L(),{runWorkflow:a,runPage:u}=se();return(0,Ce.useEffect)(()=>{if(i&&e&&!r){if(t(!1),i.type=="workflow")s&&!s.data.executingNodeTitle&&(a(i.value,s.data.sid,1),n.current=setTimeout(()=>{o(!1)},1e3));else if(i.type=="page"){let d=_.getStore(i.value);d&&!d.data.executingNodeTitle&&(o(!0),u(i.value),n.current=setTimeout(()=>{o(!1)},1e3))}}},[e,r,i,s,a,u]),(0,Ce.useEffect)(()=>()=>{n.current&&clearTimeout(n.current)},[]),{setShouldTriggerLivePainting:t}}var ae=w(A(),1);var wn=w(b(),1),qi=15e3,gn=(0,ae.createContext)({});function yn({children:e,loginAppID:t,loginStyle:r,loginBannerTop:o,loginBannerBottom:n}){let[i,s]=(0,ae.useState)(!t),a=(0,ae.useCallback)(async(c,l="sdppp123456")=>{try{let f=await fetch("https://api.authing.cn/api/v3/signin",{method:"POST",headers:{"Content-Type":"application/json","x-authing-app-id":t,"x-authing-sdk-version":"web:3.0.0"},body:JSON.stringify({connection:"PASSWORD",passwordPayload:{username:c,password:l}})}),g=await f.json();if(f.ok){if(g.statusCode===200)return{success:!0,token:g.data.access_token};if(g.statusCode===403)return{success:!1,message:m("Verification Error")}}else return{success:!1,message:JSON.stringify(g)}}catch(f){return{success:!1,message:f.toString()}}return{success:!1,message:"\u767B\u5F55\u5931\u8D25"}},[]),u=(0,ae.useCallback)(async c=>{if(!c)throw new Error("Token is required");let l="access_token",f="https://api.authing.cn/oidc/token/introspection",g=`token=${encodeURIComponent(c)}&token_type_hint=${encodeURIComponent(l)}&client_id=${encodeURIComponent(t)}`;try{let y=await fetch(f,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:g});if(!y.ok)throw new Error(`Verification failed with status: ${y.status}`);return await y.json()}catch(y){throw console.error("Token verification error:",y),y}},[]),d=(0,ae.useCallback)(async c=>{try{let f=await(await fetch("https://api.authing.cn/api/v3/get-profile",{method:"GET",headers:{Authorization:`Bearer ${c}`,"x-authing-app-id":t}})).json();return f.statusCode===200?{data:f.data,success:!0}:{message:f.message,success:!1}}catch(l){return{success:!1,message:l}}},[]);async function p(c,l="sdppp123456"){let f=await a(c,l);if(f.success){let g=await d(f.token);g.success&&(localStorage.setItem("token",f.token),localStorage.setItem("lastLogin",new Date(g.data.lastLogin).getTime().toString()),s(!0))}return f}async function h(c){if(!localStorage.getItem("lastLogin"))return!1;if((await u(c)).active){let f=await d(c);if(f.success){let g=new Date(f.data.lastLogin).getTime().toString(),y=localStorage.getItem("lastLogin");return g===y}else return!1}return!1}return(0,ae.useEffect)(()=>{if(i){if(t){let c=setInterval(()=>{let l=localStorage.getItem("token");l&&h(l).then(f=>{f||s(!1)})},qi);return()=>{clearInterval(c)}}}else{let c=localStorage.getItem("token");if(!c)return;h(c).then(l=>{l&&s(!0)})}},[i]),(0,wn.jsx)(gn.Provider,{value:{loginStyle:r||"none",loginBannerBottom:n||null,loginBannerTop:o||null,isLogin:i,logout:()=>{localStorage.removeItem("token"),s(!1)},login:p},children:e})}function Ie(){let e=(0,ae.useContext)(gn);if(!e)throw new Error("useSDPPPLogin must be used within a SDPPPLoginProvider");return e}var Le=w(b(),1),Pn=(0,Xe.createContext)({});function Sn({children:e,loginAppID:t,loginStyle:r,loginBannerTop:o,loginBannerBottom:n}){let i=new Kr;return(0,Le.jsx)(zr,{client:i,children:(0,Le.jsx)(Be,{children:(0,Le.jsx)(vo,{children:(0,Le.jsx)(yn,{loginAppID:t,loginStyle:r,loginBannerTop:o,loginBannerBottom:n,children:(0,Le.jsx)(Go,{children:(0,Le.jsx)(Gi,{children:e})})})})})})}function Ae(){let e=(0,Xe.useContext)(Pn);if(!e)throw new Error("SDPPPExternalContext not found");return e}function Gi({children:e}){let t=be(),r=L(),{logout:o}=Ie();we.registerTestCase&&(globalThis.sdppp_debugPhotoshopInternalContext=r,globalThis.sdppp_debugPhotoshopWebviewContext=t);let{toggleWebviewDialog:n,webviewAgentSID:i}=t,{autoRunning:s,setAutoRunning:a,workflowAgent:u,setWorkflowAgentSID:d,doConnectOrDisconnect:p,lastErrorMessage:h}=r,{setShouldTriggerLivePainting:c}=ir();return(0,Xe.useEffect)(()=>{let l=()=>{c(!0)};return v.subscribe("/canvasStateID",l),()=>{v.unsubscribe(l)}},[c]),(0,Le.jsx)(Pn.Provider,{value:{logout:o,connectOrDisconnect:p,lastConnectErrorMessage:h,setAutoRunning:a,autoRunning:s,photoshopSID:v.data.sid,webviewAgentSID:i,workflowAgentSID:u?.data.sid||"",setWorkflowAgentSID:d,toggleWebviewDialog:n},children:e})}var sr=w(A(),1);var Ze=w(A(),1);function ue(e,t){let[r,o]=(0,Ze.useState)(e?{...e.data}:null),[n,i]=(0,Ze.useState)(e?{...e.data}:null),s=Array.isArray(t)?t:[t];return(0,Ze.useEffect)(()=>{e&&o({...e.data})},[e]),(0,Ze.useEffect)(()=>{if(!e)return;let a=s.map(u=>{let d=()=>{i(r),o(e.data)};return e.subscribe(u,d),d});return()=>{a.forEach(u=>{e.unsubscribe(u)})}},[e,t]),{state:r||null,prevState:n||null}}function bn(){let[e,t]=(0,sr.useState)({}),{state:r}=ue(v,"/comfyUserToken"),o=r?.comfyUserToken;return(0,sr.useEffect)(()=>{let n=!1,i=(s,a,u)=>{n||t(d=>{let p={...d};return a==null?delete p[s]:p[s]=a,p})};return _.subscribe("/",i),()=>{n=!0,_.unsubscribe(i)}},[]),{pageInstances:Object.entries(e).map(([n,i])=>({sid:n,ssid:n.slice(0,4),title:i.title,lastError:i.lastError,isWebview:!!i.webviewFromSid,isCurrentUser:!i.comfyUserToken||i.comfyUserToken==o})).filter(n=>!n.isWebview&&(!o||n.isCurrentUser))}}var ce=w(A(),1);function Hi(e,t,r){let{state:o}=ue(v,["/comfyUserToken"]),{socket:n,workflowAgentSID:i}=L(),[s,a]=(0,ce.useState)({}),[u,d]=(0,ce.useState)(!1),[p,h]=(0,ce.useState)(null),c=(0,ce.useCallback)(async l=>{if(!l&&!i){a({});return}d(!0);let f=_.getStore(l||i);try{let g=await n?.listWorkflows(f||null)||[];if("error"in g){h(new Error(g.error)),d(!1);return}d(!1),a(g.reduce((y,P)=>(y[P]={path:P,content:null,error:""},y),{}))}catch(g){d(!1),h(g)}},[n,i]);return(0,ce.useEffect)(()=>{e&&c()},[e]),(0,ce.useEffect)(()=>{o?.comfyUserToken&&c()},[o]),{data:s,isLoading:u,error:p,refetch:c}}function vn(){let{backendURL:e,comfyMultiUser:t,workflowAgent:r}=L(),{workflowAgentSID:o}=Ae(),[n,i]=(0,ce.useState)(!0),[s,a]=(0,ce.useState)(""),{data:u,isLoading:d,error:p,refetch:h}=Hi(e,t,r);(0,ce.useEffect)(()=>{if(o)h(),i(!1);else{i(!0);let f=setTimeout(()=>{i(!1)},4e3);return()=>clearTimeout(f)}},[o]);let c=[];!d&&!p&&u&&(Object.keys(u).forEach(f=>{f.startsWith(s)&&(f.slice(s.length).indexOf("/")==-1?c.push({path:f,isDir:!1}):c.unshift({path:f.slice(0,f.lastIndexOf("/")+1),isDir:!0}))}),c=c.filter((f,g,y)=>y.findIndex(P=>P.path==f.path)===g));let l="";return p&&(l=p.message),c.length||(l=m("Workflow list is empty, please save a workflow by Comfy's lastest UI")),p&&(l=m("Workflow list loading failed: {0}",p.message)),!we.MU&&t&&(l=m("Workflow List of ComfyUI with --multi-user is only available for sponsors")),d&&(l="Loading"),{workflows:u,isLoadingWorkflows:d,workflowsError:l,refetchWorkflows:h,afterPropsUpdate4s:n,currentViewingDirectory:s,setCurrentViewingDirectory:a,showingList:c}}function Dn(e){let t=_.getStore(e),{state:r}=ue(t,["/"]);return r?{sid:e,ssid:r.ssid,title:r.title,lastError:r.lastError,isWebview:!!r.webviewFromSid,isCurrentUser:!r.comfyUserToken||r.comfyUserToken==v.data.comfyUserToken,progress:r.progress,executingNodeTitle:r.executingNodeTitle,queueSize:r.queueSize}:{sid:"",ssid:"",title:"",lastError:"",isWebview:!1,isCurrentUser:!1,progress:0,executingNodeTitle:"",queueSize:0}}var Hn=w(A(),1);var et=w(A(),1);var Xr=w(A(),1),Jr={LICENSE:{name:"SD-PPP",url:{en:"https://github.com/zombieyang/sd-ppp",zhcn:"https://github.com/zombieyang/sd-ppp"}},sponsors:[{name:"\u56DB\u559CAI",url:"https://v.douyin.com/hD2X7S717uw/"},{name:"\u6C90\u6C90AI",url:"https://v.douyin.com/k6yKDEcVgP8/"}],links:[{name:"\u732B\u54AA\u8001\u5E08Reimagined",url:"https://www.xiaohongshu.com/user/profile/59f1fcc411be101aba7f048f"},{name:"\u6765\u771F\u7684",url:"https://space.bilibili.com/590784254"},{name:"\u54D1\u72D7Egao",url:"https://space.bilibili.com/284721975"}],community:{en:[{name:"Github",url:"https://github.com/zombieyang/sd-ppp"},{name:"Discord",url:"https://discord.gg/9HeGjDvEmn"},{name:"Youtube",url:"https://www.youtube.com/@Github-Zombeeyang/videos"}],zhcn:[{name:"Github",url:"https://github.com/zombieyang/sd-ppp"},{name:"QQ\u9891\u9053",url:"https://pd.qq.com/s/5m42umo28"},{name:"Bilibili",url:"https://space.bilibili.com/44908313"}]},cloud:{en:[],zhcn:[{name:"Cephalon",url:"https://cephalon.cloud/share/register-landing?invite_id=m95SDj",icon:"https://cephalon.cloud/favicon.ico",color:"#000000"},{name:"\u6668\u7FBD\u667A\u4E91",url:"https://www.chenyu.cn/console/login?invitationCode=BUD913",icon:"https://www.chenyu.cn/favicon.ico",color:"#f3ac40"}]}},In="sponsorData",En={GITEE:"https://gitee.com/zombieyang/sd-ppp/raw/main/sponsors.json",GITHUB:"https://raw.githubusercontent.com/zombieyang/sd-ppp/refs/heads/main/sponsors.json"},Yi=15e3;function $r(){try{let e=localStorage.getItem(In);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to parse sponsor data from localStorage:",e)}return null}function An(e){try{localStorage.setItem(In,JSON.stringify(e))}catch(t){console.warn("Failed to save sponsor data to localStorage:",t)}}function ur(e){try{if(!e||typeof e!="object")return console.warn("Invalid sponsor data: not an object"),!1;if(!e.LICENSE||typeof e.LICENSE!="object")return console.warn("Invalid sponsor data: LICENSE is not an object"),!1;if(!e.LICENSE.name)return console.warn("Invalid sponsor data: LICENSE.name is missing"),!1;if(!e.LICENSE.url||typeof e.LICENSE.url!="object")return console.warn("Invalid sponsor data: LICENSE.url is not an object"),!1;if(!e.LICENSE.url.en)return console.warn("Invalid sponsor data: LICENSE.url.en is missing"),!1;if(!e.LICENSE.url.zhcn)return console.warn("Invalid sponsor data: LICENSE.url.zhcn is missing"),!1;if(!Array.isArray(e.sponsors))return console.warn("Invalid sponsor data: sponsors is not an array"),!1;if(!Array.isArray(e.links))return console.warn("Invalid sponsor data: links is not an array"),!1;if(!e.community||typeof e.community!="object")return console.warn("Invalid sponsor data: community is not an object"),!1;if(!Array.isArray(e.community.en)||!Array.isArray(e.community.zhcn))return console.warn("Invalid sponsor data: community.en or community.zhcn is not an array"),!1;if(!e.cloud||typeof e.cloud!="object")return console.warn("Invalid sponsor data: cloud is not an object"),!1;if(!Array.isArray(e.cloud.en)||!Array.isArray(e.cloud.zhcn))return console.warn("Invalid sponsor data: cloud.en or cloud.zhcn is not an array"),!1;for(let t of e.cloud.zhcn)if(!t.name||!t.url||!t.icon||!t.color)return console.warn("Invalid sponsor data: cloud.zhcn item missing required properties"),!1;return!0}catch(t){return console.warn("Error validating sponsor data:",t),!1}}async function Cn(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`Fetch failed with status: ${t.status}`);let r=await t.json();return ur(r)?r:null}catch(t){return console.warn(`Failed to fetch from ${e}:`,t),null}}var ar=null;function cr(){if(!ar){let r=$r();ar=new Promise(o=>{let n=!1;Cn(En.GITEE).then(i=>{!n&&i&&(n=!0,An(i),o(i))}),Cn(En.GITHUB).then(i=>{!n&&i&&(n=!0,An(i),o(i))}),setTimeout(()=>{n||(n=!0,r&&ur(r)?o(r):(console.warn("Using default data as fallback"),o(Jr)))},Yi)})}let[e,t]=Xr.default.useState(()=>{let r=$r();return r&&ur(r)?r:Jr});return Xr.default.useEffect(()=>{ar&&ar.then(r=>{t(r)}).catch(r=>{console.error("Error in useSponsor:",r);let o=$r();t(o&&ur(o)?o:Jr)})},[]),{data:e}}var C=w(b(),1),Ki=0,bt=0;function Ln(){let e=(0,et.useRef)(null),{loginStyle:t}=Ie(),{data:r}=cr();(0,et.useEffect)(()=>{let n=1/0,i=1/0,s=!1;if(e.current){let p=function(h){bt||(bt=Date.now())};var u=p;let d=document.createElement("webview");d.addEventListener("loadstart",p),d.addEventListener("loadstop",p),d.addEventListener("loaderror",p),d.setAttribute("src","./_.html"),d.style.width="1px",d.style.height="1px",e.current.appendChild(d)}function a(){let d=e.current?.parentElement?.parentElement?.getBoundingClientRect();d?.height&&d?.width&&(n=Math.min(n,d.height),i=Math.min(i,d.width)),s||requestAnimationFrame(a)}return requestAnimationFrame(a),()=>{s=!0,bt&&(Ki+=Date.now()-bt,bt=0)}},[e]);let o=(0,et.useMemo)(()=>r.community[at()=="zhcn"?"zhcn":"en"],[r]);return(0,C.jsxs)("div",{className:"about-card",style:{position:"relative"},children:[t==="none"?(0,C.jsxs)(C.Fragment,{children:[(0,C.jsx)("div",{className:"about-card-sections about-card-title",children:(0,C.jsxs)("a",{href:r.LICENSE.url[at()=="zhcn"?"zhcn":"en"],children:[m("LICENSE:")," ",r.LICENSE.name]})}),(0,C.jsx)("sp-divider",{}),(0,C.jsx)("h2",{children:m("Sponsors")}),(0,C.jsx)("div",{className:"about-card-sections about-card-sponsors",children:r.sponsors.map(n=>(0,C.jsx)("a",{href:n.url,children:n.name},n.name))}),(0,C.jsx)("sp-divider",{}),(0,C.jsx)("h2",{children:m("Links")}),(0,C.jsx)("div",{className:"about-card-sections about-card-friends-links",children:r.links.map(n=>(0,C.jsx)("a",{href:n.url,children:n.name},n.name))}),(0,C.jsx)("sp-divider",{}),(0,C.jsxs)("h2",{children:["SD-PPP ",m("Community")]})]}):(0,C.jsxs)(C.Fragment,{children:[(0,C.jsx)("div",{className:"about-card-sections about-card-title",children:(0,C.jsx)("h4",{children:m("This plugin is based on sd-ppp")})}),(0,C.jsx)("div",{className:"about-card-sections about-card-title",children:(0,C.jsx)("h6",{children:m("And follows its open source license:")})}),(0,C.jsx)("div",{className:"about-card-sections about-card-title",children:(0,C.jsx)("a",{href:"https://github.com/zombieyang/sd-ppp/blob/main/LICENSE",children:"LICENSE: BSD3-Clause"})})]}),(0,C.jsxs)("div",{className:"about-card-sections about-card-links",children:[o.map(n=>(0,C.jsx)("a",{href:n.url,children:n.name},n.name)),(0,C.jsx)("div",{style:{width:1,height:1,position:"absolute",right:0,bottom:0,opacity:.1},ref:e,className:"persistent-div"})]})]})}var tt=w(A(),1);var Ve=w(b(),1);function _n(){let{backendURL:e,setBackendURL:t,connectState:r,doConnectOrDisconnect:o}=L(),n=r==="connected"||r==="connecting"?{disabled:!0}:{};(0,tt.useEffect)(()=>{e&&r==="disconnected"&&setTimeout(()=>{o()},1e3)},[]);let i=(0,tt.useRef)(!1);return(0,tt.useEffect)(()=>()=>{i.current=!0},[]),(0,tt.useEffect)(()=>()=>{r==="connected"&&i.current&&o()},[r]),(0,Ve.jsxs)(Ve.Fragment,{children:[(0,Ve.jsx)("sp-textfield",{id:"url-bar",label:"backendURL",onInput:s=>{t(s.currentTarget.value)},...n,value:e||"",placeholder:$t}),(0,Ve.jsx)("sp-action-button",{id:"connect-btn",onClick:()=>{o()},children:r!=="disconnected"?"\u2297":"\u2192"})]})}var Rn=w(A(),1);var _e=class{static makeDocumentDataOptions(t){let r=t.data,o=[`${E.getSpecialDocumentCurrent()}`];return Object.keys(r.documents).forEach(n=>{let i=r.documents[n];o.push(i.identify)}),o}static findDocumentData(t,r){let o=E.is_SPECIAL_DOCUMENT_CURRENT(r)?t.data.activeDocumentID:so(r).id;return t.data.documents[o]}static makeLayerOptions(t,r){return r.concat(t.layers.map(n=>n.identify))}};var Tn=w(A(),1);var kn=w(A(),1);function ke(e){return{flex:`${e} 0 calc(${e/12*100}% - 10px)`,maxWidth:"100%"}}var rt=class extends Tn.Component{computeUIWeightCSS(t){return ke(t)}};var Qe=w(b(),1),Te=class extends rt{state={filter:""};handleSelectUpdate=(t,r)=>{this.props.onSelectUpdate(t,r),this.setState({filter:""})};render(){let{options:t,value:r,name:o}=this.props;return(0,Qe.jsxs)("div",{style:{display:"flex",alignItems:"center",...this.computeUIWeightCSS(this.props.uiWeight)},children:[o&&(0,Qe.jsx)("sp-label",{style:{flex:1},children:o}),(0,Qe.jsx)("sp-picker",{class:"sdppp-dropdown-widget",size:"s",style:this.props.name?{flex:2}:{width:"100%"},children:(0,Qe.jsx)("sp-menu",{slot:"options",children:t.map((n,i)=>this.state.filter&&!n.includes(this.state.filter)?"":(0,Qe.jsx)("sp-menu-item",{...lr(n)===lr(r)?{selected:!0}:{},onClick:()=>this.handleSelectUpdate(n,i),children:lr(n)},lr(n)))})})]})}};function lr(e){return typeof e=="string"?e:e.content}var xn=w(b(),1),dr=class e extends Rn.default.Component{state={options:_e.makeDocumentDataOptions(v)};constructor(t){super(t),v.subscribe("/documents",this.updateOptions)}updateOptions=()=>{let t=_e.makeDocumentDataOptions(v);this.setState({options:t})};componentwillUnmount(){v.unsubscribe(this.updateOptions)}static getValueIfIsValidOptionOrCurrent(t,r){return!r||r.includes(t)?t:E.getSpecialDocumentCurrent()}static getDerivedStateFromProps(t,r){let o=t.value;if(o){let n=o.split("/"),i=e.getValueIfIsValidOptionOrCurrent(n.slice(1).join("/"),r.options);return E.is_SPECIAL_DOCUMENT_CURRENT(i)?o=E.getSpecialDocumentCurrent():o=i,n[0]!=v.data.uname&&t.onSelectUpdate(v.data.uname+"/"+o,0),Object.assign(r,{value:o})}return null}render(){let t=e.getValueIfIsValidOptionOrCurrent(this.props.value,this.state.options);return(0,xn.jsx)(Te,{uiWeight:this.props.uiWeight,options:this.state.options,onSelectUpdate:(r,o)=>{this.props.onSelectUpdate(v.data.uname+"/"+r,o)},value:t})}};var On=w(A(),1);var Nn=w(b(),1);function le(e){return(0,Nn.jsx)("a",{onClick:e.onClick,children:e.label})}var Pe=w(b(),1),Re=class extends On.default.Component{state={options:[]};constructor(t){super(t),v.subscribe("/documents",this.updataOptionsAfterDocumentChange)}componentwillUnmount(){v.unsubscribe(this.updataOptionsAfterDocumentChange)}componentDidMount(){this.updateOptions(this.props.documentValue||E.getSpecialDocumentCurrent())}shouldComponentUpdate(t,r){return t.documentValue!=this.props.documentValue&&t.documentValue&&this.updateOptions(t.documentValue),!0}updataOptionsAfterDocumentChange=()=>{this.updateOptions(this.props.documentValue||E.getSpecialDocumentCurrent())};updateOptions=t=>{t=t||this.props.documentValue||E.getSpecialDocumentCurrent();let r=_e.findDocumentData(v,t);if(!r){this.setState({options:[]});return}let o=_e.makeLayerOptions(r,E.getSpecialLayerForGet());this.setState({options:o})};render(){let t=this.props.value;if(t)try{t=m(t)}catch{}return(0,Pe.jsxs)("div",{className:"sdppp-layer-widget",style:ke(this.props.uiWeight),children:[(0,Pe.jsx)("div",{className:"sdppp-layer-widget-dropdown",children:(0,Pe.jsx)(Te,{uiWeight:12,options:this.state.options,onSelectUpdate:this.props.onSelectUpdate,value:t})}),(0,Pe.jsxs)("div",{className:"sdppp-layer-widget-quick-set",children:[(0,Pe.jsxs)("sp-label",{children:[m("Quick Set"),":"]}),(0,Pe.jsx)(le,{onClick:async()=>{let r=We();this.props.onSelectUpdate(r,this.state.options.indexOf(r))},label:m("Selected Layer")}),(0,Pe.jsx)(le,{onClick:async()=>{this.props.onSelectUpdate(E.get_SPECIAL_LAYER_USE_CANVAS(),this.state.options.indexOf(E.get_SPECIAL_LAYER_USE_CANVAS()))},label:m("Canvas")})]})]})}};var Et=w(mt(),1),ot=k("photoshop"),te=w(A(),1);var Zr=w(mt(),1),fr=k("photoshop"),ee=w(A(),1);var vt=w(b(),1);function Dt({mode:e,setMode:t}){let r=o=>{t(o)};return(0,vt.jsxs)("div",{className:"widget-mode-selection",children:[(0,vt.jsx)("button",{className:`widget-mode-selection-button ${e==="manual"?"selected":""}`,onClick:()=>r("manual"),children:m("Manual")}),(0,vt.jsx)("button",{className:`widget-mode-selection-button ${e==="auto"?"selected":""}`,onClick:()=>r("auto"),children:m("Auto")})]})}var Z=w(b(),1);function Wn(e){let[t,r]=(0,ee.useState)(""),[o,n]=(0,ee.useState)(""),[i,s]=(0,ee.useState)("manual"),[a,u]=(0,ee.useState)(!1),[d,p]=(0,ee.useState)(null),{backendURL:h}=L(),{uploadImage:c}=se(),{addBeforeWorkflowRunHook:l}=$e(),f=(0,ee.useRef)(null),g=(0,ee.useCallback)(async()=>{if(i==="manual"&&!a&&d){await e.onValueChange(d);return}try{if(i==="auto"&&await P(t),f.current){let S=await f.current.getBuffer(Zr.JimpMime.jpeg),D=await c(S,ut(6)+".jpeg");D?.name&&(p(D.subfolder+"/"+D.name),u(!1),await e.onValueChange(D.subfolder+"/"+D.name))}}catch(S){console.error(S)}},[i,a,d,e.onValueChange]);(0,ee.useEffect)(()=>{let D=l(g);return()=>{D()}},[g]);let y=o;if(!y&&(d||e.value)){let S=d||e.value,D=S.split("/").slice(0,-1).join("/");y=h+(h.endsWith("/")?"":"/")+`api/view?filename=${S}&type=input&subfolder=${D}&rand=`+Math.random()}let P=(0,ee.useCallback)(async S=>{let D=await eo(S);if(!D)return;f.current=D;let U=await zi(D);r(S),n(U),u(!0)},[]);return(0,Z.jsxs)("div",{className:"image-widget",children:[(0,Z.jsx)("div",{className:"image-widget-left",children:(0,Z.jsx)("img",{src:y,className:"image-widget-image"+(y?"":" image-widget-image-empty")})}),(0,Z.jsxs)("div",{className:"image-widget-right",children:[(0,Z.jsx)(Dt,{mode:i,setMode:s}),i==="manual"&&(0,Z.jsxs)("div",{className:"image-widget-more-quickset",children:[(0,Z.jsx)("sp-label",{children:m("Set As:")}),(0,Z.jsx)(le,{onClick:()=>{P(We())},label:m("Selected Layer")}),(0,Z.jsx)(le,{onClick:()=>{P(E.get_SPECIAL_LAYER_USE_CANVAS())},label:m("Canvas")})]}),i=="auto"&&(0,Z.jsx)("div",{className:"image-widget-layer-widget-container",children:(0,Z.jsx)(Re,{onSelectUpdate:P,uiWeight:10,value:t})})]})]})}async function eo(e){if(!fr.app.activeDocument)return null;try{return await Kt.getJimpImage({document_identify:he(fr.app.activeDocument.id,fr.app.activeDocument.name),layer_identify:e})}catch(t){throw console.error(t),t}}async function zi(e){let t=100/Math.max(e.width,e.height);return e=e.clone(),e.scale(t),await e.getBase64(Zr.JimpMime.jpeg)}var H=w(b(),1);function Un(e){let[t,r]=(0,te.useState)(""),[o,n]=(0,te.useState)(""),[i,s]=(0,te.useState)("manual"),[a,u]=(0,te.useState)(!1),[d,p]=(0,te.useState)(null),{backendURL:h}=L(),{uploadImage:c}=se(),{addBeforeWorkflowRunHook:l}=$e(),f=(0,te.useRef)(null),g=(0,te.useCallback)(async()=>{if(i==="manual"&&!a&&d){await e.onValueChange(d);return}try{if(i==="auto"&&await P(t),f.current){let S=await f.current.getBuffer(Et.JimpMime.png),D=await c(S,ut(6)+".png");D?.name&&(p(D.subfolder+"/"+D.name),u(!1),await e.onValueChange(D.subfolder+"/"+D.name))}}catch(S){console.error(S)}},[i,a,d,e.onValueChange]);(0,te.useEffect)(()=>{let S=l(g);return()=>{S()}},[g]);let y=o;if(!y&&(d||e.value)){let S=d||e.value,D=S.split("/").slice(0,-1).join("/");y=h+(h.endsWith("/")?"":"/")+`api/view?filename=${S}&type=input&subfolder=${D}&rand=`+Math.random()}let P=(0,te.useCallback)(async(S,D=!1)=>{let U=await eo(S);if(!U)return;f.current=U;let oe=await Mn(U,D);r(S),n(oe),u(!0)},[]);return(0,H.jsxs)("div",{className:"image-widget",children:[(0,H.jsx)("div",{className:"image-widget-left",children:(0,H.jsx)("img",{src:y,className:"image-widget-image"+(y?"":" image-widget-image-empty")})}),(0,H.jsxs)("div",{className:"image-widget-right",children:[(0,H.jsx)(Dt,{mode:i,setMode:S=>{s(S)}}),i==="manual"&&(0,H.jsxs)("div",{className:"image-widget-more-quickset",children:[(0,H.jsx)("sp-label",{children:m("Set As:")}),(0,H.jsx)(le,{onClick:()=>{P(We(),!1)},label:m("Selected Layer")}),(0,H.jsx)(le,{onClick:async()=>{P(We(),!0)},label:m("Selected Layer (invert)")}),(0,H.jsx)(le,{onClick:()=>{P(E.get_SPECIAL_LAYER_USE_CANVAS())},label:m("Canvas")}),(0,H.jsx)(le,{onClick:async()=>{let S=await ji();if(!S)return;f.current=S;let D=await Mn(S);r(""),n(D),u(!0)},label:m("Selection")})]}),i==="auto"&&(0,H.jsx)("div",{className:"image-widget-layer-widget-container",children:(0,H.jsx)(Re,{onSelectUpdate:S=>{P(S,!1)},uiWeight:12,value:t})})]})]})}async function ji(){if(!ot.app.activeDocument)return null;try{let e=await yt({document_identify:he(ot.app.activeDocument.id,ot.app.activeDocument.name),boundary:{left:0,top:0,right:0,bottom:0,width:ot.app.activeDocument.width,height:ot.app.activeDocument.height}});if(!e?.blob)return null;let t=e.blob,r=new Uint8Array(t.length*4);for(let o=0;o<t.length;o++)r[o*4]=127,r[o*4+1]=127,r[o*4+2]=127,r[o*4+3]=255-t[o];return new Et.Jimp({data:r,width:e.width,height:e.height})}catch(e){throw console.error(e),e}}async function Mn(e,t=!1){let r=100/Math.max(e.width,e.height);return e=e.clone(),e.scale(r),e.scan(0,0,e.bitmap.width,e.bitmap.height,function(o,n,i){let s=e.bitmap.data[i+3],a=t?s:255-s;e.bitmap.data[i]=a,e.bitmap.data[i+1]=a,e.bitmap.data[i+2]=a,e.bitmap.data[i+3]=255}),await e.getBase64(Et.JimpMime.png)}var oo=w(A(),1);var At=w(A(),1);var Y=w(b(),1);function ro({widgetTableStructure:e,widgetTableValue:t,widgetTableErrors:r,onWidgetRender:o,onWidgetChange:n,onTitleRender:i}){let s=(0,At.useMemo)(()=>e.nodeIndexes.map(u=>{let d=e.nodes[u],p=(l,f,g)=>l.keepRender?f.outputType==="error"?(l.result.push((0,Y.jsx)("span",{className:"list-error-label",children:t[d.id][g]})),l):(o?.(l,d,f,g),l):l,c=Object.values(e.groups).find(l=>l.nodeIDs.includes(d.id))?.color||"rgba(127, 127, 127, .4)";return(0,Y.jsxs)("div",{className:"workflow-edit-field",children:[(0,Y.jsx)("div",{className:"workflow-edit-field-title",title:d.title,style:{...ke(d.uiWeightSum<=8&&d.widgets.length==1?4:12),borderColor:c},children:i?i(d.title,d):(0,Y.jsx)("span",{children:d.title})}),d.widgets.reduce(p,{keepRender:!0,result:[]}).result.map((l,f)=>(0,Y.jsx)(to,{children:l},f)),r[d.id]?(0,Y.jsx)("span",{className:"list-error-label",children:r[d.id]}):""]},d.id)}),[e,t,r,o,n,i]),a=(0,At.useMemo)(()=>Object.keys(r).filter(u=>!e.nodes[parseInt(u)]),[r,e]);return(0,Y.jsxs)(Y.Fragment,{children:[a.length>0&&a.map(u=>(0,Y.jsx)("span",{className:"list-error-label",children:r[u]},u)),Object.keys(e.nodes).length?"":(0,Y.jsx)("span",{className:"list-error-label",children:m("no suitable node to control in this workflow")}),(0,Y.jsx)("div",{className:"workflow-edit-content",children:s})]})}var to=class extends At.default.Component{constructor(t){super(t),this.state={hasError:!1,error:null}}componentDidCatch(t,r){this.setState({hasError:!0,error:t})}render(){return this.state.hasError?(0,Y.jsx)("span",{className:"list-error-label",children:this.state.error?.stack||this.state.error?.message||this.state.error?.toString()}):this.props.children}};var qe=w(A(),1),Ct=w(b(),1),Fn=e=>{let{inputMin:t,inputMax:r,inputStep:o,value:n=0,onValueChange:i,name:s,uiWeight:a}=e,[u,d]=(0,qe.useState)(+n.toFixed(3));(0,qe.useEffect)(()=>{d(+n.toFixed(3))},[n]);let p=(0,qe.useCallback)(l=>{let f=+l.target.value;d(+f.toFixed(3))},[]),h=(0,qe.useCallback)(()=>{i(u)},[u,i]);return(0,Ct.jsxs)("div",{style:{...(l=>({flex:l||1}))(a),display:"flex",alignItems:"center"},children:[s&&(0,Ct.jsx)("sp-label",{style:{flex:1},children:s}),(0,Ct.jsx)("sp-textfield",{style:s?{flex:2}:{width:"100%"},onInput:p,onBlur:h,value:u})]})};var q=w(A(),1);var nt=w(b(),1);function Bn(e){let t=q.default.useRef(null),[r,o]=(0,q.useState)(0),[n,i]=(0,q.useState)(e.value??""),[s,a]=(0,q.useState)(!1);return(0,q.useEffect)(()=>{s||i(e.value??"")},[e.value]),(0,q.useEffect)(()=>{let u=setInterval(()=>{if(t.current){let d=t.current.offsetHeight;d!==r&&o(d)}},16);return()=>clearInterval(u)},[r]),(0,nt.jsxs)("div",{className:"widget-container",style:{...ke(e.uiWeight),position:"relative",height:Math.max(55,r)},children:[(0,nt.jsx)(Ji,{textAreaValue:n,setTextAreaValue:i,editing:s,setEditing:a,onValueChange:e.onValueChange,hiddenDivHeight:r}),(0,nt.jsx)("p",{ref:t,style:{fontSize:14,visibility:"hidden",whiteSpace:"pre-line"},children:n})]})}function Ji({textAreaValue:e,onValueChange:t,editing:r,setEditing:o,setTextAreaValue:n,hiddenDivHeight:i}){let[s,a]=(0,q.useState)(0),u=(0,q.useCallback)(l=>{let f=l.target.value;t(f),n(f)},[t,n]),d=(0,q.useCallback)(()=>{o(!0)},[o]),p=(0,q.useCallback)(()=>{let l={textfieldRerender:s,editing:!1};s==2&&(l.textfieldRerender=1),a(l.textfieldRerender),o(l.editing)},[s,a,o]),[h,c]=(0,q.useState)(i);return(0,q.useEffect)(()=>{i!=h&&(a(r?2:1),c(i))},[i]),(0,q.useEffect)(()=>{s==1&&Promise.resolve().then(async()=>{await new Promise(requestAnimationFrame),a(0)})},[s]),s==1?"":(0,nt.jsx)("sp-textarea",{style:{position:"absolute",height:"100%",width:"100%",top:0,left:0},value:e,onInput:u,onFocus:d,onBlur:p})}var Vn=w(b(),1),pr=class extends rt{onInput=t=>{let r=!!t.target.value;this.setState({value:r}),this.props.onValueChange(r)};render(){let t=this.props.value?{checked:!0}:{};return(0,Vn.jsx)("sp-checkbox",{label:this.props.name||"",style:{...this.computeUIWeightCSS(this.props.uiWeight)},onInput:r=>{this.props.onValueChange(r.target.checked)},...t,children:this.props.name||""})}};function Qn(e){return e.replace(/^workflows\//,"").replace(/\.json$/,"")}var K=w(b(),1);function qn(){let{callForPSDExtract:e}=se(),{workflowAgent:t}=L(),{setWidgetValue:r}=hn(),{setShouldTriggerLivePainting:o}=ir(),{state:n}=ue(t,["/widgetTableValue","/widgetTableStructure","/widgetTableErrors"]),i=!!t?.data.hasPSDNodes,s=(0,oo.useCallback)(async(h,c,l,f)=>{await r(h,c,l),o(!0)},[r,o]),a=n?.widgetTableStructure,u=n?.widgetTableValue,d=n?.widgetTableErrors,p=(0,oo.useCallback)((h,c,l,f)=>{if(l.outputType=="PS_DOCUMENT")return h.result.push((0,K.jsx)(dr,{uiWeight:l.uiWeight||12,value:u?.[c.id]?.[f]||"",onSelectUpdate:g=>{s(c.id,f,g,c)}},f)),!0;if(l.outputType=="PS_LAYER"){let g=l.options?.documentNodeID||0,y=u?.[g]?.[0]||"";return h.result.push((0,K.jsx)(Re,{uiWeight:l.uiWeight||12,value:u?.[c.id]?.[f]||"",documentValue:y?y.split("/").pop():"",onSelectUpdate:P=>{s(c.id,f,P,c)}},f)),!0}else{if(l.outputType=="IMAGE_PATH")return h.result.push((0,K.jsx)(Wn,{uiWeight:l.uiWeight||12,value:u?.[c.id]?.[f]||"",onValueChange:async g=>{await s(c.id,f,g,c)}},f)),!0;if(l.outputType=="MASK_PATH")return h.result.push((0,K.jsx)(Un,{uiWeight:l.uiWeight||12,value:u?.[c.id]?.[f]||"",onValueChange:async g=>{await s(c.id,f,g,c)}},f)),!0;if(l.outputType==="number"){let g=l.options?.min??0,y=l.options?.max??100,P=l.options?.step??1;h.result.push((0,K.jsx)(Fn,{uiWeight:l.uiWeight||12,name:l.name,inputMin:g,inputMax:y,inputStep:P,value:parseFloat(u?.[c.id]?.[f]||"0"),onValueChange:S=>{s(c.id,f,S,c)}},f))}else if(l.outputType==="combo")h.result.push((0,K.jsx)(Te,{uiWeight:l.uiWeight||12,name:l.name,options:l.options?.values||[],onSelectUpdate:g=>{s(c.id,f,g,c)},value:u?.[c.id]?.[f]||""},f));else if(l.outputType==="toggle")h.result.push((0,K.jsx)(pr,{uiWeight:l.uiWeight||12,name:l.name,value:u?.[c.id]?.[f]||"",onValueChange:g=>{s(c.id,f,g,c)}},f));else{let g=u?.[c.id]?.[f]||"";h.result.push((0,K.jsx)(Bn,{uiWeight:l.uiWeight||12,value:typeof g=="string"?g:JSON.stringify(g),onValueChange:y=>{s(c.id,f,y,c)}},f))}}return!1},[r,u]);return a?(0,K.jsxs)("div",{className:"workflow-edit",children:[(0,K.jsxs)("div",{className:"workflow-edit-title",children:[a.widgetTablePath&&(0,K.jsx)("sp-label",{style:{fontWeight:"bold"},children:Qn(a.widgetTablePath)}),i?(0,K.jsx)("a",{onClick:()=>{e(t?.data.sid||"")},children:">"+m("sample .psd")}):""]}),(0,K.jsx)(ro,{widgetTableStructure:a,widgetTableValue:u||{},widgetTableErrors:d||{},onWidgetChange:s,onWidgetRender:p})]}):null}var mr=w(A(),1);var B=w(b(),1);function Gn(){let{login:e,loginStyle:t,loginBannerTop:r,loginBannerBottom:o}=Ie(),[n,i]=(0,mr.useState)(localStorage.getItem("last-username")||""),[s,a]=(0,mr.useState)(""),[u,d]=(0,mr.useState)("");return(0,B.jsxs)("div",{className:"login-container",children:[r,(0,B.jsx)("div",{className:"login-container-login",children:(0,B.jsxs)("div",{className:"login-form",children:[t==="invitation"?(0,B.jsxs)("div",{className:"login-form-item",children:[(0,B.jsx)("label",{htmlFor:"username",children:m("Invitation Code")}),(0,B.jsx)("sp-textfield",{type:"text",id:"username",placeholder:m("Please input invitation code"),value:n,onInput:p=>i(p.target.value)})]}):(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)("div",{className:"login-form-item",children:[(0,B.jsx)("label",{htmlFor:"username",children:m("Username")}),(0,B.jsx)("sp-textfield",{type:"text",id:"username",placeholder:m("Please input username"),value:n,onInput:p=>i(p.target.value)})]}),(0,B.jsxs)("div",{className:"login-form-item",children:[(0,B.jsx)("label",{htmlFor:"password",children:m("Password")}),(0,B.jsx)("sp-textfield",{type:"password",id:"password",placeholder:m("Please input password"),value:s,onInput:p=>a(p.target.value)})]})]}),(0,B.jsx)("div",{className:"login-error-message",children:u}),(0,B.jsx)("button",{className:"login-button",onClick:async()=>{let p=await e(n,s);p.success?(d(""),localStorage.setItem("last-username",n)):d(p.message)},children:m("Login")})]})}),o]})}var xe=w(b(),1);function Yn({renderContent:e}){let{connectState:t}=L(),r=(0,Hn.useMemo)(()=>e(t,_n,qn),[t]),{isLogin:o}=Ie();return(0,xe.jsxs)(xe.Fragment,{children:[(0,xe.jsx)(Be,{children:o?r:(0,xe.jsx)(Gn,{})}),t!="connected"&&(0,xe.jsx)(Ln,{})]})}var zn=w(A(),1);var hr=w(A(),1);var me=w(b(),1);function Kn(e){let t=we.MU,{state:r}=ue(v,["/comfyUserToken"]),{logout:o}=se(),{workflowAgent:n}=L(),{workflowAgentSID:i}=Ae(),s=be(),[a,u]=(0,hr.useState)(!1);return(0,hr.useEffect)(()=>{if(!n){v.setComfyUserToken("");return}let d=(p,h)=>{let c=r?.comfyUserToken;v.setComfyUserToken(p),c==""&&a&&(s.resetWebview(),u(!1))};return n.subscribe("/comfyUserToken",d),d(n.data.comfyUserToken,""),()=>{n&&n.unsubscribe(d)}},[n,a,s.resetWebview]),t?(0,me.jsx)("div",{className:"identifier-bar-right",children:n&&r?.comfyUserToken?(0,me.jsxs)(me.Fragment,{children:[(0,me.jsx)("sp-label",{children:m("User: ")+r?.comfyUserToken.split("_")[0]}),(0,me.jsx)("sp-label",{children:(0,me.jsx)("a",{onClick:()=>{o(i),u(!1)},children:m("Logout")})})]}):(0,me.jsx)("a",{onClick:()=>{u(!0),e.onRequestLogin?.()},children:m("--multi-user activated, Not Login!")})}):""}var jn=k("uxp");var re=w(b(),1);function Jn(){let{state:e}=ue(v,["/uname","/comfyUser"]),t=L(),{toggleWebviewDialog:r}=be(),o=(0,zn.useCallback)(()=>{r()},[r]);return(0,re.jsxs)("div",{className:"promote-bar",children:[(0,re.jsx)($i,{}),(0,re.jsxs)("div",{className:"identifier-bar",children:[(0,re.jsx)("div",{className:"identifier-bar-left",children:(0,re.jsxs)("sp-label",{children:["(Photoshop ID: ",e?.uname,")"]})}),t.comfyMultiUser&&(0,re.jsx)(Kn,{onRequestLogin:o})]})]})}function $i(){let{data:e}=cr(),t=e.cloud[at()=="zhcn"?"zhcn":"en"];return!t||t.length==0?null:(0,re.jsxs)("div",{className:"cloud-promote-bar",children:[(0,re.jsx)("span",{className:"cloud-promote-bar-left",children:m("Cloud")}),(0,re.jsx)("span",{className:"cloud-promote-bar-right",children:t.map(r=>(0,re.jsxs)("span",{style:{borderColor:r.color},onClick:()=>{jn.shell.openExternal(r.url)},children:[(0,re.jsx)("img",{src:r.icon}),r.name]}))})]})}Object.assign(globalThis,{SDPPPInternal:no});})();
/*! Bundled license information:

fast-json-patch/module/helpers.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

fast-json-patch/module/duplex.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2021 Joachim Wester
   * MIT license
   *)
*/
