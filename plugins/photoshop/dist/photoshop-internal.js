"use strict";(()=>{var Ui=Object.create;var qt=Object.defineProperty;var To=Object.getOwnPropertyDescriptor;var Fi=Object.getOwnPropertyNames;var Bi=Object.getPrototypeOf,Vi=Object.prototype.hasOwnProperty;var N=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var Ye=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Br=(e,t)=>{for(var r in t)qt(e,r,{get:t[r],enumerable:!0})},Gi=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Fi(t))!Vi.call(e,n)&&n!==r&&qt(e,n,{get:()=>t[n],enumerable:!(o=To(t,n))||o.enumerable});return e};var v=(e,t,r)=>(r=e!=null?Ui(Bi(e)):{},Gi(t||!e||!e.__esModule?qt(r,"default",{value:e,enumerable:!0}):r,e));var _=(e,t,r,o)=>{for(var n=o>1?void 0:o?To(t,r):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(n=(o?s(t,r,n):s(n))||n);return o&&n&&qt(t,r,n),n};var E=Ye((Ka,Qo)=>{"use strict";Qo.exports=window.React});var jo=Ye((nc,Jo)=>{"use strict";var at=1e3,ct=at*60,ut=ct*60,Ze=ut*24,cs=Ze*7,us=Ze*365.25;Jo.exports=function(e,t){t=t||{};var r=typeof e;if(r==="string"&&e.length>0)return ls(e);if(r==="number"&&isFinite(e))return t.long?fs(e):ds(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function ls(e){if(e=String(e),!(e.length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]),o=(t[2]||"ms").toLowerCase();switch(o){case"years":case"year":case"yrs":case"yr":case"y":return r*us;case"weeks":case"week":case"w":return r*cs;case"days":case"day":case"d":return r*Ze;case"hours":case"hour":case"hrs":case"hr":case"h":return r*ut;case"minutes":case"minute":case"mins":case"min":case"m":return r*ct;case"seconds":case"second":case"secs":case"sec":case"s":return r*at;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}function ds(e){var t=Math.abs(e);return t>=Ze?Math.round(e/Ze)+"d":t>=ut?Math.round(e/ut)+"h":t>=ct?Math.round(e/ct)+"m":t>=at?Math.round(e/at)+"s":e+"ms"}function fs(e){var t=Math.abs(e);return t>=Ze?nr(e,t,Ze,"day"):t>=ut?nr(e,t,ut,"hour"):t>=ct?nr(e,t,ct,"minute"):t>=at?nr(e,t,at,"second"):e+" ms"}function nr(e,t,r,o){var n=t>=r*1.5;return Math.round(e/r)+" "+o+(n?"s":"")}});var Zo=Ye((ic,Xo)=>{"use strict";function ps(e){r.debug=r,r.default=r,r.coerce=c,r.disable=s,r.enable=n,r.enabled=a,r.humanize=jo(),r.destroy=m,Object.keys(e).forEach(d=>{r[d]=e[d]}),r.names=[],r.skips=[],r.formatters={};function t(d){let l=0;for(let f=0;f<d.length;f++)l=(l<<5)-l+d.charCodeAt(f),l|=0;return r.colors[Math.abs(l)%r.colors.length]}r.selectColor=t;function r(d){let l,f=null,u,p;function h(...w){if(!h.enabled)return;let b=h,y=Number(new Date),S=y-(l||y);b.diff=S,b.prev=l,b.curr=y,l=y,w[0]=r.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let I=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(ve,oe)=>{if(ve==="%%")return"%";I++;let k=r.formatters[oe];if(typeof k=="function"){let Q=w[I];ve=k.call(b,Q),w.splice(I,1),I--}return ve}),r.formatArgs.call(b,w),(b.log||r.log).apply(b,w)}return h.namespace=d,h.useColors=r.useColors(),h.color=r.selectColor(d),h.extend=o,h.destroy=r.destroy,Object.defineProperty(h,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(u!==r.namespaces&&(u=r.namespaces,p=r.enabled(d)),p),set:w=>{f=w}}),typeof r.init=="function"&&r.init(h),h}function o(d,l){let f=r(this.namespace+(typeof l>"u"?":":l)+d);return f.log=this.log,f}function n(d){r.save(d),r.namespaces=d,r.names=[],r.skips=[];let l=(typeof d=="string"?d:"").trim().replace(" ",",").split(",").filter(Boolean);for(let f of l)f[0]==="-"?r.skips.push(f.slice(1)):r.names.push(f)}function i(d,l){let f=0,u=0,p=-1,h=0;for(;f<d.length;)if(u<l.length&&(l[u]===d[f]||l[u]==="*"))l[u]==="*"?(p=u,h=f,u++):(f++,u++);else if(p!==-1)u=p+1,h++,f=h;else return!1;for(;u<l.length&&l[u]==="*";)u++;return u===l.length}function s(){let d=[...r.names,...r.skips.map(l=>"-"+l)].join(",");return r.enable(""),d}function a(d){for(let l of r.skips)if(i(d,l))return!1;for(let l of r.names)if(i(d,l))return!0;return!1}function c(d){return d instanceof Error?d.stack||d.message:d}function m(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}Xo.exports=ps});var sr=Ye((ne,ir)=>{"use strict";ne.formatArgs=hs;ne.save=gs;ne.load=ys;ne.useColors=ms;ne.storage=ws();ne.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();ne.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function ms(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function hs(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+ir.exports.humanize(this.diff),!this.useColors)return;let t="color: "+this.color;e.splice(1,0,t,"color: inherit");let r=0,o=0;e[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(r++,n==="%c"&&(o=r))}),e.splice(o,0,t)}ne.log=console.debug||console.log||(()=>{});function gs(e){try{e?ne.storage.setItem("debug",e):ne.storage.removeItem("debug")}catch{}}function ys(){let e;try{e=ne.storage.getItem("debug")}catch{}return!e&&typeof process<"u"&&"env"in process&&(e=process.env.DEBUG),e}function ws(){try{return localStorage}catch{}}ir.exports=Zo()(ne);var{formatters:vs}=ir.exports;vs.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}});var P=Ye((ac,rn)=>{"use strict";rn.exports=window.ReactJSXRuntime});var un=Ye((dc,cn)=>{"use strict";cn.exports=window.socketIO});var kt=Ye((Lc,gn)=>{"use strict";gn.exports=window.Jimp});var xo={};Br(xo,{Auths:()=>Ri,Promote:()=>Wi,SDPPP:()=>xi,SDPPPProvider:()=>ii,useAgentState:()=>Er,useSDPPPComfyCaller:()=>re,useSDPPPContext:()=>We,useSDPPPWebpageList:()=>Ar,useSDPPPWorkflowList:()=>si});var T=N("photoshop");var Ee=N("photoshop"),qi=N("uxp");var Vr={"SDPPP Get Document":"Get Document","SDPPP Get Layer By ID":"Get Layer","SDPPP Get Linked Layers":"Get Linked Layers","SDPPP Get Layers In Group":"Get Layers In Group","SDPPP Get Text From Layer":"Get Text From Layer","SDPPP Parse Layer Info":"Parse Layer Info","SDPPP Get Selection":"Get Selection","SDPPP Get Image From Photoshop":"Get Image From Photoshop","SDPPP Send Images To Photoshop":"Send Images To Photoshop","SDPPP Select Layer And Run PS Action":"Select Layer And Run PS Action"};var Gr={"### Active Document ###":"### \u5F53\u524D\u6587\u6863 ###","### The Canvas ###":"### \u6574\u4E2A\u753B\u5E03 ###","### New Layer ###":"### \u65B0\u56FE\u5C42 ###","### Selected Layer ###":"### \u6240\u9009\u56FE\u5C42 ###","### Keep Size or Fit Canvas ###":"### \u4FDD\u6301\u5C3A\u5BF8\u6216\u9002\u5E94\u753B\u5E03 ###",_SDPPP_PSD_:"_SDPPP_PSD_","Save and run immediately":"\u4FDD\u5B58\u5E76\u7ACB\u5373\u6267\u884C",Close:"\u5173\u95ED","Select a {0}":"\u9009\u62E9\u4E00\u4E2A {0}","How to use .ccx file":"\u5982\u4F55\u4F7F\u7528 .ccx \u6587\u4EF6","1. If you have installed Adobe Creative Cloud":"1. \u5982\u679C\u4F60\u5DF2\u7ECF\u5B89\u88C5\u4E86 Adobe Creative Cloud","Just double click the .ccx file, it will install the plugin automatically":"\u53CC\u51FB .ccx \u6587\u4EF6\uFF0C\u5B83\u4F1A\u81EA\u52A8\u5B89\u88C5","2. If you don't have Adobe Creative Cloud":"2. \u5982\u679C\u4F60\u6CA1\u6709 Adobe Creative Cloud","Rename .ccx to .zip and extract it into ":"\u5C06 .ccx \u91CD\u547D\u540D\u4E3A .zip \u5E76\u89E3\u538B\u5230",or:"\u6216","Photoshop directory":"Photoshop \u5B89\u88C5\u76EE\u5F55","Cannot connect multiple different document widgets with same value":"\u4E0D\u80FD\u8FDE\u63A5\u591A\u4E2A\u5177\u6709\u76F8\u540C\u503C\u7684\u6587\u6863\u5C0F\u90E8\u4EF6","You can only have one SDPPP Settings node in a workflow":"\u4E00\u4E2A\u5DE5\u4F5C\u6D41\u4E2D\u53EA\u80FD\u6709\u4E00\u4E2A SDPPP Settings \u8282\u70B9","convert widget {0} failed:":"\u63A7\u4EF6{0}\u8F6C\u6362\u5931\u8D25\uFF1A","hidden webview load failed: {0}, please select a browser page to continue":"\u5185\u7F6E webview \u52A0\u8F7D\u5931\u8D25: {0}\uFF0C\u8BF7\u9009\u62E9\u4E00\u4E2A\u6D4F\u89C8\u5668\u9875\u9762\u7EE7\u7EED","SDPPP Get Document":"\u83B7\u53D6\u6587\u6863(GetDocument)","SDPPP Get Layer By ID":"\u83B7\u53D6\u56FE\u5C42(GetLayer)","SDPPP Get Linked Layers":"\u83B7\u53D6\u94FE\u63A5\u56FE\u5C42(GetLinkedLayers)","SDPPP Get Layers In Group":"\u83B7\u53D6\u7EC4\u4E2D\u56FE\u5C42(GetLayersInGroup)","SDPPP Get Text From Layer":"\u83B7\u53D6\u56FE\u5C42\u6587\u672C(GetTextFromLayer)","SDPPP Parse Layer Info":"\u89E3\u6790\u56FE\u5C42\u4FE1\u606F(ParseLayerInfo)","SDPPP Get Selection":"\u83B7\u53D6\u9009\u533A(GetSelection)","SDPPP Get Image From Photoshop":"\u4ECEPS\u83B7\u53D6\u56FE\u50CF(GetImageFromPhotoshop)","SDPPP Send Images To Photoshop":"\u53D1\u9001\u56FE\u50CF\u5230PS(SendImagesToPhotoshop)","SDPPP Send Text To Layer":"\u53D1\u9001\u6587\u672C\u5230\u56FE\u5C42(SendTextToLayer)","SDPPP Select Layer And Run PS Action":"\u9009\u4E2D\u56FE\u5C42\u5E76\u8FD0\u884CPS Action(RunPhotoshopAction)","download PS plugin (.ccx)":"\u4E0B\u8F7D Photoshop \u63D2\u4EF6 (.ccx)","current ComfyUI pageid: {0}":"\u5F53\u524D ComfyUI \u9875\u9762ID: {0}","current A1111 pageid: {0}":"\u5F53\u524D A1111 \u9875\u9762ID: {0}","document linked":"\u6587\u6863\u53C2\u6570\u5DF2\u94FE\u63A5","layer linked":"\u56FE\u5C42\u53C2\u6570\u5DF2\u94FE\u63A5","bound linked":"\u8303\u56F4\u53C2\u6570\u5DF2\u94FE\u63A5",document:"\u6587\u6863",Document:"\u6587\u6863",DOCUMENT:"\u6587\u6863",document_name:"\u6587\u6863\u540D\u5B57id",layer_nameid:"\u56FE\u5C42\u540D\u5B57id",layer_name:"\u56FE\u5C42\u540D\u5B57",layer_info:"\u56FE\u5C42\u4FE1\u606F",bound_top:"\u8303\u56F4\u4E0A\u8FB9\u8DDD",bound_left:"\u8303\u56F4\u5DE6\u8FB9\u8DDD",bound_width:"\u8303\u56F4\u5BBD\u5EA6",bound_height:"\u8303\u56F4\u9AD8\u5EA6",center_x:"\u4E2D\u5FC3\u70B9x",center_y:"\u4E2D\u5FC3\u70B9y",opacity:"\u900F\u660E\u5EA6",layer:"\u56FE\u5C42",layer_or_group:"\u56FE\u5C42(\u6216\u7EC4)",Layer_or_group:"\u56FE\u5C42(\u6216\u7EC4)",bound:"\u8303\u56F4",bounds:"\u8303\u56F4","bounds [optional]":"\u8303\u56F4[\u53EF\u9009]",boundary:"\u8303\u56F4",Boundary:"\u8303\u56F4",canvas_boundary:"\u753B\u5E03\u8303\u56F4",canvas_bound:"\u753B\u5E03\u8303\u56F4",layer_boundary:"\u56FE\u5C42\u8303\u56F4",layer_bound:"\u56FE\u5C42\u8303\u56F4","Photoshop Disconnected!":"Photoshop \u672A\u8FDE\u63A5\uFF01",rgb_out:"RGB\u8F93\u51FA",alpha_out:"Alpha\u8F93\u51FA",images:"\u56FE\u50CF",text:"\u6587\u672C",ID_mode:"\u7CBE\u786EID\u6A21\u5F0F",name_mode:"\u540D\u5B57\u5339\u914D\u6A21\u5F0F",select:"\u9009\u62E9","document boundary":"\u6587\u6863\u8303\u56F4","layer boundary":"\u56FE\u5C42\u8303\u56F4","selection boundary":"\u9009\u4E2D\u8303\u56F4","save .psd to this workflow":"\u4FDD\u5B58.psd\u5230\u8FD9\u4E2A\u5DE5\u4F5C\u6D41","extract saved .psd to Photoshop":"\u63D0\u53D6\u4FDD\u5B58\u7684.psd\u5230Photoshop","sample .psd":"\u793A\u4F8B.psd",mask:"\u906E\u7F69",name:"\u540D\u79F0",quality:"\u56FE\u50CF\u8D28\u91CF",action_set:"\u52A8\u4F5C\u7EC4",action:"\u52A8\u4F5C",Runner:"\u8FD0\u884C\u8F7D\u4F53","PS Webview":"PS \u5185\u7F6E\u7F51\u9875","Browser {0}":"\u6D4F\u89C8\u5668\u9875\u9762 {0}",timeout:"\u8D85\u65F6","Loading...":"\u52A0\u8F7D\u4E2D...","--multi-user Not Login!":"--multi-user\u5DF2\u6FC0\u6D3B\uFF0C\u4F46\u672A\u767B\u5F55\uFF01",Logout:"\u767B\u51FA","User: ":"\u7528\u6237: ",connect:"\u8FDE\u63A5",connected:"\u5DF2\u8FDE\u63A5",disconnect:"\u65AD\u5F00",disconnected:"\u5DF2\u65AD\u5F00\u8FDE\u63A5","reconnecting...":"\u91CD\u8FDE\u4E2D...",connecting:"\u8FDE\u63A5\u4E2D",webpages:"\u7F51\u9875\u5217\u8868",workflows:"\u5DE5\u4F5C\u6D41",workflow:"\u5DE5\u4F5C\u6D41","auto run page [{0}] after change..":"\u66F4\u6539\u540E\u81EA\u52A8\u8FD0\u884C\u9875\u9762 {0}..","auto run workflow [{0}] after change..":"\u66F4\u6539\u540E\u81EA\u52A8\u8FD0\u884C\u5DE5\u4F5C\u6D41 {0}..","auto run workflow after change..":"\u66F4\u6539\u540E\u81EA\u52A8\u8FD0\u884C\u5DE5\u4F5C\u6D41..",selection_only:"\u4EC5\u9009\u533A","Queue:":"\u961F\u5217:","Set As:":"\u8BBE\u7F6E\u4E3A:","Error {0}... please contact me via Discord/Github":"\u51FA\u73B0\u9519\u8BEF {0}...\uFF0C\u8BF7\u901A\u8FC7 QQ/Github \u8054\u7CFB\u6211","Webview initialize failed. Please report to me via Discord/Github with your ComfyURL, Operate System":"Webview \u521D\u59CB\u5316\u5931\u8D25\uFF0C\u8BF7\u901A\u8FC7 QQ/Github \u8054\u7CFB\u6211\u5E76\u9644\u4E0A\u4F60\u7684Comfy\u5730\u5740\u3001\u64CD\u4F5C\u7CFB\u7EDF","ComfyUI with --multi-user is only available for sponsors":'\u5E26"--multi-user"\u7684ComfyUI\u4EC5\u5BF9\u8D5E\u52A9\u8005\u5F00\u653E',"Workflow Runner is loading...":"\u8FD0\u884C\u8F7D\u4F53\u5C1A\u5728\u52A0\u8F7D...","(Page ID: {0})Queue: {1}":"(\u9875\u9762ID: {0}) \u961F\u5217\u957F\u5EA6 {1}","no suitable node to control in this workflow":"\u8FD9\u4E2A\u5DE5\u4F5C\u6D41\u4E2D\u6CA1\u6709\u80FD\u63A7\u5236\u7684\u8282\u70B9",Save:"\u4FDD\u5B58",Edit:"\u7F16\u8F91","Edit in ComfyUI":"\u5728 ComfyUI \u4E2D\u7F16\u8F91","using browser page [{0}] for workflow running":"\u6B63\u63A5\u7BA1\u7F51\u9875 [{0}] \u8FD0\u884C\u5DE5\u4F5C\u6D41","workflow running by hidden webview":"\u5DE5\u4F5C\u6D41\u5728\u9690\u85CF\u7684webview\u4E2D\u8FD0\u884C","Lock Image":"\u9501\u5B9A\u56FE\u50CF","Unlock Image":"\u89E3\u9501\u56FE\u50CF","search...":"\u641C\u7D22...","disabled when running in browser page":"\u63A5\u7BA1\u7F51\u9875\u65F6\u4E0D\u53EF\u7528","only supported in Photoshop":"\u4EC5\u5728 Photoshop \u4E2D\u652F\u6301",Login:"\u767B\u5F55","Invitation Code":"\u9080\u8BF7\u7801",Username:"\u7528\u6237\u540D",Password:"\u5BC6\u7801","Please input invitation code":"\u8BF7\u8F93\u5165\u9080\u8BF7\u7801","Please input username":"\u8BF7\u8F93\u5165\u7528\u6237\u540D","Please input password":"\u8BF7\u8F93\u5165\u5BC6\u7801","Open more ComfyUI pages to see more options here":"\u6253\u5F00\u66F4\u591A ComfyUI \u9875\u9762\u4EE5\u67E5\u770B\u66F4\u591A\u9009\u9879","Comfy multi-user: ":"Comfy \u591A\u7528\u6237: ","Not Login":"\u672A\u767B\u5F55","Comfy API-Key: ":"Comfy API-Key: ","Login/Auth":"\u767B\u5F55/\u8BA4\u8BC1","Logged in by email/password":"\u5DF2\u901A\u8FC7\u90AE\u7BB1/\u5BC6\u7801\u767B\u5F55","Set API Key":"\u8BBE\u7F6E API Key","Please input API key (will reload Runner)":"\u8BF7\u8F93\u5165 API Key (\u4F1A\u91CD\u542F\u8FD0\u884C\u8F7D\u4F53)","### Active Workflow ###":"### \u5F53\u524D\u5DE5\u4F5C\u6D41 ###","### Example SDXL ###":"### \u793A\u4F8BSDXL\u5DE5\u4F5C\u6D41 ###","Open ComfyUI in the browser to see more options":"\u5728\u6D4F\u89C8\u5668\u4E2D\u6253\u5F00 ComfyUI \u4EE5\u5F97\u5230\u66F4\u591A\u9009\u9879","Webview load timeout, please switch to a different runner":"Webview \u52A0\u8F7D\u8D85\u65F6\uFF0C\u8BF7\u5207\u6362\u5230\u5176\u4ED6\u8FD0\u884C\u8F7D\u4F53","Save workflow to ComfyUI":"\u4FDD\u5B58\u5DE5\u4F5C\u6D41\u5230 ComfyUI","Reload workflow":"\u91CD\u65B0\u52A0\u8F7D\u5DE5\u4F5C\u6D41","Stop and cancel all":"\u505C\u6B62\u5E76\u53D6\u6D88\u6240\u6709","Start auto running after change":"\u66F4\u6539\u540E\u81EA\u52A8\u8FD0\u884C","Stop auto run":"\u505C\u6B62\u81EA\u52A8\u8FD0\u884C","Run workflow":"\u8FD0\u884C\u5DE5\u4F5C\u6D41","Run workflow xN":"\u8FD0\u884C\u5DE5\u4F5C\u6D41N\u6B21","Back to workflow list":"\u8FD4\u56DE\u5DE5\u4F5C\u6D41\u5217\u8868","502: Maybe the server is not running":"502: \u670D\u52A1\u5668\u53EF\u80FD\u672A\u8FD0\u884C","404: Maybe SDPPP is not installed or failed to run in ComfyUI":"404: \u53EF\u80FD\u5728ComfyUI\u4E2DSDPPP\u672A\u5B89\u88C5\u6216\u8FD0\u884C\u5931\u8D25","{0}. reconnecting...":"{0}. \u91CD\u8FDE\u4E2D...","disconnected to {0} failed {1}":"\u65AD\u5F00\u8FDE\u63A5 {0} \u9519\u8BEF {1}","version mismatch, please reinstall PS plugin":"\u7248\u672C\u4E0D\u5339\u914D\uFF0C\u8BF7\u91CD\u65B0\u5B89\u88C5 PS \u63D2\u4EF6","instance type not recognized":"\u672A\u8BC6\u522B\u7684\u8F6F\u4EF6\u7C7B\u578B","Error: {0}":"\u9519\u8BEF: {0}","Verification Error":"\u9A8C\u8BC1\u9519\u8BEF","document {0} not found":"\u627E\u4E0D\u5230\u6587\u6863: {0}",'only layer kind "TEXT" is supported, invalid layer: {0}':"\u4E0D\u652F\u6301\u975E\u6587\u672C\u56FE\u5C42: {0}","create layer failed":"\u521B\u5EFA\u56FE\u5C42\u5931\u8D25","layer not found {0}":"\u627E\u4E0D\u5230\u56FE\u5C42: {0}","no linked layer for {0}":"\u6CA1\u6709\u94FE\u63A5\u56FE\u5C42: {0}","layer {0} is not a group":"\u56FE\u5C42 {0} \u4E0D\u662F\u4E00\u4E2A\u7EC4","no layer in group {0}":"\u7EC4 {0} \u4E2D\u6CA1\u6709\u56FE\u5C42","layer not found: {0}":"\u627E\u4E0D\u5230\u56FE\u5C42: {0}","No upload_name":"\u4E0A\u4F20\u63A5\u53E3\u8FD4\u56DE\u4E86\u5931\u8D25","get pixel of {0} failed":"\u83B7\u53D6\u50CF\u7D20\u5931\u8D25: {0}","merge group failed":"\u5408\u5E76\u7EC4\u5931\u8D25","invalid name: {0}":"\u975E\u6CD5\u7684\u540D\u79F0: {0}","get_layer_info: layer_identify required":"get_layer_info: \u9700\u8981 layer_identify","invalid action: {0}":"\u65E0\u6548\u7684\u64CD\u4F5C: {0}","create document failed":"\u521B\u5EFA\u6587\u6863\u5931\u8D25","create document for preview":"\u521B\u5EFA\u9884\u89C8\u6587\u6863","resize document for preview":"\u8C03\u6574\u9884\u89C8\u6587\u6863\u5C3A\u5BF8","no first related layer in {0}":"\u7EC4 {0} \u4E2D\u6CA1\u6709\u7B2C\u4E00\u4E2A\u76F8\u5173\u56FE\u5C42","imageDataError: data length is not multiple of width * height":"\u56FE\u50CF\u6570\u636E\u6709\u8BEF: \u6570\u636E\u957F\u5EA6\u4E0D\u662F\u5BBD\u5EA6 * \u9AD8\u5EA6\u7684\u500D\u6570","imageDataError: originComponents must be 1 or 3":"\u56FE\u50CF\u6570\u636E\u6709\u8BEF: originComponents \u5FC5\u987B\u662F 1 \u6216 3","unexpected connection lost, please try to reconnect":"\u610F\u5916\u65AD\u5F00\u8FDE\u63A5\uFF0C\u8BF7\u5C1D\u8BD5\u91CD\u65B0\u8FDE\u63A5","Workflow list is empty, please save a workflow by Comfy's lastest UI":"\u5DE5\u4F5C\u6D41\u5217\u8868\u4E3A\u7A7A\uFF0C\u8BF7\u5728Comfy\u7684\u65B0\u7248UI\u4E2D\u4FDD\u5B58\u4E00\u4E2A\u5DE5\u4F5C\u6D41","No opened ComfyUI pages":"\u6CA1\u6709\u5DF2\u6253\u5F00\u7684ComfyUI\u9875\u9762","comfyAPI is not initialized, maybe comfyUI is too old":"\u65E0\u6CD5\u83B7\u53D6 ComfyAPI\uFF0C\u53EF\u80FD ComfyUI \u7248\u672C\u592A\u65E7","unsupported channel counts: {0}":"\u4E0D\u652F\u6301\u7684\u901A\u9053\u6570: {0}","Timeout, Maybe the URL is wrong":"\u8D85\u65F6\uFF0C\u53EF\u80FD comfy\u5730\u5740 \u586B\u5199\u9519\u8BEF","Workflow list loading failed: {0}":"\u5DE5\u4F5C\u6D41\u5217\u8868\u52A0\u8F7D\u5931\u8D25: {0}","Please register a user in ComfyUI":"\u8BF7\u5728 ComfyUI \u4E2D\u6CE8\u518C\u4E00\u4E2A\u7528\u6237","GetSelection need Photoshop version 25+":"GetSelection \u9700\u8981 Photoshop 25+ \u7248\u672C","Action {0} not found":"Action {0} \u672A\u627E\u5230","Action set {0} not found":"ActionSet {0} \u672A\u627E\u5230","{0} cannot be used in Photoshop Action Node":"{0} \u4E0D\u80FD\u5728 Photoshop Action \u8282\u70B9\u4E2D\u4F7F\u7528","Group layers":"\u56FE\u5C42\u7EC4","Show All Groups":"\u663E\u793A\u6240\u6709\u7EC4","create document for sent images":"\u7ED9\u53D1\u9001\u7684\u56FE\u7247\u521B\u5EFA\u6587\u6863","show sent images":"\u663E\u793A\u53D1\u9001\u7684\u56FE\u7247","fallback show sent images":"\u53D6\u6D88\u663E\u793A\u53D1\u9001\u7684\u56FE\u7247","get content of layer {0}":"\u83B7\u53D6\u56FE\u5C42 {0} \u7684\u5185\u5BB9","fallback get content of layer {0}":"\u53D6\u6D88\u83B7\u53D6\u56FE\u5C42 {0} \u7684\u5185\u5BB9","get layer info":"\u83B7\u53D6\u56FE\u5C42\u4FE1\u606F","sdppp extract PSD":"sdppp \u5BFC\u5165 PSD","sdppp get PSD":"sdppp \u83B7\u53D6 PSD","set text to layer":"\u8BBE\u7F6E\u56FE\u5C42\u7684\u6587\u672C","run Photoshop Action":"sdppp \u8FD0\u884C Photoshop Action","select layer":"sdppp \u9009\u4E2D\u56FE\u5C42","{0} wants to extract a PSD file to Photoshop, are you sure?":"{0} \u60F3\u8981\u91CA\u653E\u4E00\u4E2A.psd\u6587\u4EF6\u5230Photoshop\uFF0C\u786E\u5B9A\u5417\uFF1F","should sdppp refuse extracting PSD to Photoshop in this session anymore?":"\u662F\u5426\u8981\u8BA9 sdppp \u62D2\u7EDD\u672C\u6B21PS\u4F1A\u8BDD\u518D\u6B21\u63A5\u53D7.psd\u91CA\u653E\u8BF7\u6C42\uFF1F","Wide Mode":"\u5BBD\u5C4F\u6A21\u5F0F","Quick Set":"\u5FEB\u901F\u8BBE\u7F6E","Selected Layer":"\u9009\u4E2D\u56FE\u5C42","Selected Layer (invert)":"\u9009\u4E2D\u56FE\u5C42(\u53CD\u5411)",Canvas:"\u753B\u5E03",Selection:"\u9009\u533A",Manual:"\u624B\u52A8\u6A21\u5F0F",Auto:"\u81EA\u52A8\u6A21\u5F0F","This plugin is based on sd-ppp":"\u672C\u63D2\u4EF6\u57FA\u4E8Esd-ppp\u5F00\u53D1","And follows its open source license:":"\u5E76\u9075\u5FAA\u5176\u5F00\u6E90\u534F\u8BAE\uFF1A",Cloud:"\u4E91\u7AEF\u63A8\u8350",Sponsors:"\u8D5E\u52A9","waiting...":"\u865A\u4F4D\u4EE5\u5F85",Links:"\u53CB\u60C5\u94FE\u63A5",Community:"\u793E\u533A","LICENSE:":"\u8BB8\u53EF\u8BC1\uFF1A","Official Site":"\u5B98\u65B9\u7F51\u7AD9",upload:"\u4E0A\u4F20","Simplify Workflow":"\u7B80\u5316\u5DE5\u4F5C\u6D41",Photoshop:"Photoshop","Photoshop plugin settings":"Photoshop \u63D2\u4EF6\u8BBE\u7F6E","Photoshop plugin":"Photoshop \u63D2\u4EF6","SDPPP Settings/Misc":"SDPPP \u8BBE\u7F6E/\u6742\u9879","Sample .PSD for this workflow:":"\u793A\u4F8B.PSD","Download Example .PSD":"\u4E0B\u8F7D\u793A\u4F8B.PSD","Maximum Image Size (px):":"\u6700\u5927\u56FE\u50CF\u5C3A\u5BF8(px)",Download:"\u4E0B\u8F7D",Upload:"\u4E0A\u4F20",Reset:"\u91CD\u7F6E",Refresh:"\u5237\u65B0","Comfy URL (You can copy it to connect ComfyUI in the plugin):":"Comfy\u5730\u5740(\u4F60\u53EF\u4EE5\u590D\u5236\u5B83\u5230\u63D2\u4EF6\u4E2D\u8FDE\u63A5ComfyUI):","use slider for number widget:":"\u6570\u5B57\u63A7\u4EF6\u4F7F\u7528\u6ED1\u5757","Photoshop is not connected":"Photoshop \u672A\u8FDE\u63A5","select...":"\u8BF7\u9009\u62E9","click to edit":"\u70B9\u51FB\u7F16\u8F91","ComfyManager not found, cannot reboot":"Comfy Manager\u672A\u5B89\u88C5\uFF0C\u65E0\u6CD5\u91CD\u542F","Failed to reboot ComfyUI":"\u91CD\u542FComfyUI\u5931\u8D25"};var Ro=typeof N<"u"?N:void 0,Kt="en";typeof navigator<"u"&&navigator.language?Kt=navigator.language=="zh-CN"?"zhcn":"en":Ro&&(Kt=Ro("uxp").host.uiLocale.startsWith("zh")?"zhcn":"en");function g(e,...t){let r=Kt=="zhcn"?Gr[e]:e in Vr?Vr[e]:e;if(!r)throw new Error(`i18n key not found: ${e}`);return r.replace(/{(\d+)}/g,function(o,n){return typeof t[n]<"u"?t[n]:o})}function ze(e,t){return e==t||Gr[e]==t}function Ht(){return Kt}var C=class e{static SPECIAL_DOCUMENT_CURRENT="### Active Document ###";static is_SPECIAL_DOCUMENT_CURRENT(t){return ze(this.SPECIAL_DOCUMENT_CURRENT,t)}static get_SPECIAL_DOCUMENT_CURRENT(){return g(this.SPECIAL_DOCUMENT_CURRENT)}static SPECIAL_LAYER_KEEP_SIZE="### Keep Size or Fit Canvas ###";static is_SPECIAL_LAYER_FIT(t){return ze(this.SPECIAL_LAYER_KEEP_SIZE,t)}static get_SPECIAL_LAYER_FIT(){return g(this.SPECIAL_LAYER_KEEP_SIZE)}static SPECIAL_LAYER_USE_CANVAS="### The Canvas ###";static is_SPECIAL_LAYER_USE_CANVAS(t){return ze(this.SPECIAL_LAYER_USE_CANVAS,t)}static get_SPECIAL_LAYER_USE_CANVAS(){return g(this.SPECIAL_LAYER_USE_CANVAS)}static SPECIAL_LAYER_NEW_LAYER="### New Layer ###";static is_SPECIAL_LAYER_NEW_LAYER(t){return ze(this.SPECIAL_LAYER_NEW_LAYER,t)}static get_SPECIAL_LAYER_NEW_LAYER(){return g(this.SPECIAL_LAYER_NEW_LAYER)}static SPECIAL_LAYER_SELECTED_LAYER="### Selected Layer ###";static is_SPECIAL_LAYER_SELECTED_LAYER(t){return ze(this.SPECIAL_LAYER_SELECTED_LAYER,t)}static get_SPECIAL_LAYER_SELECTED_LAYER(){return g(this.SPECIAL_LAYER_SELECTED_LAYER)}static SPECIAL_LAYER_PREVIEW_DOCUMENT="_SDPPP_PSD_";static is_SPECIAL_LAYER_PREVIEW_DOCUMENT(t){return ze(this.SPECIAL_LAYER_PREVIEW_DOCUMENT,t)}static get_SPECIAL_LAYER_PREVIEW_DOCUMENT(){return g(this.SPECIAL_LAYER_PREVIEW_DOCUMENT)}static getSpecialDocumentCurrent(){return g(e.SPECIAL_DOCUMENT_CURRENT)}static getSpecialLayerForGet(){return[g(e.SPECIAL_LAYER_USE_CANVAS),g(e.SPECIAL_LAYER_SELECTED_LAYER)]}static getSpecialLayerForSend(){return[g(e.SPECIAL_LAYER_NEW_LAYER),g(e.SPECIAL_LAYER_SELECTED_LAYER)]}static getSpecialDocumentForPreview(){return g(e.SPECIAL_LAYER_PREVIEW_DOCUMENT)}static fixI18n(t){return this.is_SPECIAL_DOCUMENT_CURRENT(t)?this.SPECIAL_DOCUMENT_CURRENT:this.is_SPECIAL_LAYER_NEW_LAYER(t)?this.SPECIAL_LAYER_NEW_LAYER:this.is_SPECIAL_LAYER_PREVIEW_DOCUMENT(t)?this.SPECIAL_LAYER_PREVIEW_DOCUMENT:this.is_SPECIAL_LAYER_USE_CANVAS(t)?this.SPECIAL_LAYER_USE_CANVAS:this.is_SPECIAL_LAYER_SELECTED_LAYER(t)?this.SPECIAL_LAYER_SELECTED_LAYER:t}};function De(e,t,r=0){return"-".repeat(r)+`${t} (id:${e})`}function Ae(e,t){return`${t} (id:${e})`}function Qi(e){let t=e.split(" (id:");return{name:t[0],id:parseInt(t[1].slice(0,-1))}}function No(e){return Qi(e)}function $e(){let e=Ee.app.activeDocument?.activeLayers?.[0];return e?De(e.id,e.name):C.get_SPECIAL_LAYER_USE_CANVAS()}function Oo(e,t,r,o,n){let i=r.left,s=r.top,a=r.right,c=r.bottom,m=a-i,d=c-s,l=o.left,f=o.top,u=o.right,p=o.bottom,h=u-l,w=p-f,b=Math.max(i,l),y=Math.max(s,f),S=Math.min(a,u),I=Math.min(c,p),$=S-b,ve=I-y,oe=h*w*n;if(t.length!==oe)throw new Error(`toImageDataArray.length(${t.length}) !== toLength(${oe})`);let k=$*ve*n;if(e.length!==k)throw new Error(`fromImageDataArray.length(${e.length}) !== fromLength(${k})`);for(let Q=0;Q<oe;Q+=n){let Se=Q/n%h+l,Gt=Math.floor(Q/n/h)+f;if(Se>=i&&Se<a&&Gt>=s&&Gt<c){let Mi=((Gt-y)*$+(Se-b))*n;for(let Qt=0;Qt<n;Qt++)t[Q+Qt]=e[Mi+Qt]}}return t}function Wo(e){if(typeof e!="string")throw new Error("not a invalid identifer: "+e);let r=e.split("(id:").pop();if(!r)throw new Error(g("invalid name: {0}",e));return parseInt(r.trim().slice(0,-1))}function Ki(e){return C.is_SPECIAL_DOCUMENT_CURRENT(e)?-1:Wo(e)}function ee(e,t){return C.is_SPECIAL_LAYER_USE_CANVAS(t)?0:C.is_SPECIAL_LAYER_SELECTED_LAYER(t)?e.activeLayers.length>0?e.activeLayers[0].id:0:C.is_SPECIAL_LAYER_NEW_LAYER(t)?-2:Wo(t)}function Qr(e,t=0,r=""){return e?.layers?e.layers.reduce((o,n)=>{let i=t==0?`/${n.name}`:`${r}/${n.name}`;return o.push({layer:n,path:i,level:t}),o.concat(Qr(n,t+1,i))},[]):[]}function le(e,t){if(!e.layers)return null;for(let r=0;r<e.layers.length;r++){if(e.layers[r].id===t)return e.layers[r];let o=le(e.layers[r],t);if(o)return o}return null}async function Yt(e,t){if(t<=0)return[null,!1];let r=le(e,t);if(!r)throw new Error(g("layer not found {0}",t));if(r.kind==Ee.constants.LayerKind.GROUP){let o=await Hi(r,e);if(!o)throw new Error(g("merge group failed"));return[o,!0]}else if(r.kind==Ee.constants.LayerKind.GRADIENTFILL){let o=await r.duplicate(e);return await o?.rasterize(Ee.constants.RasterizeType.ENTIRELAYER),[o,!0]}return[r,!1]}async function Hi(e,t){let r=!0;e.visible||(e.visible=!0,r=!1);let n=await(await e.duplicate(t))?.merge();return r||(e.visible=!1),n||null}function F(e){return(C.is_SPECIAL_DOCUMENT_CURRENT(e)?Ee.app.activeDocument:Ee.app.documents.find(t=>t.id==Ki(e)))||null}function Mo(e,t){return{name:t.name,opacity:t.opacity/100,boundary:{left:t.bounds?.left||0,top:t.bounds?.top||0,right:e.width-(t.bounds?.right||0),bottom:e.height-(t.bounds?.bottom||0),width:t.bounds?.width||0,height:t.bounds?.height||0},isGroup:t.kind==Ee.constants.LayerKind.GROUP}}function Uo(){let e=localStorage.getItem("sdppp_uid");return(!e||e.length!=3)&&(e=St(3),localStorage.setItem("sdppp_uid",e)),e}function St(e){let t="",r="abcdefghijklmnopqrstuvwxyz0123456789",o=r.length,n=0;for(;n<e;)t+=r.charAt(Math.floor(Math.random()*o)),n+=1;return t}var zt=class{storeMap=new Map;storeCount(){return this.storeMap.size}getStore(t){return this.storeMap.get(t)}getAllStore(){return Object.fromEntries(this.storeMap.entries())}subscribers=[];subscribersWithoutKey=new WeakMap;subscribe(t,r){this.subscribers.push([t,r]);let o={};this.subscribersWithoutKey.set(r,o),this.storeMap.forEach((n,i)=>{o[i]=r.bind(this,i),n.subscribe(t,o[i])})}unsubscribe(t){this.subscribers=this.subscribers.filter(([o,n])=>n!=t);let r=this.subscribersWithoutKey.get(t);r&&this.storeMap.forEach((o,n)=>{o.unsubscribe(r[n])})}addStore(t,r,o){let n=this.createStore(r,o);this.storeMap.set(t,n),this.subscribers.forEach(([i,s])=>{let a=this.subscribersWithoutKey.get(s);a||(a={},this.subscribersWithoutKey.set(s,a)),a[t]=s.bind(this,t),n.subscribe(i,a[t]),i=="/"&&s(t,r,null)})}removeStore(t){let r=this.storeMap.get(t);r&&(this.subscribers.forEach(([o,n])=>{let i=this.subscribersWithoutKey.get(n);i&&(r.unsubscribe(i[t]),o=="/"&&n(t,null,r.data))}),this.storeMap.delete(t))}sync(t){if(t instanceof Array){let r=Array.from(this.storeMap.keys()),o=t.filter(i=>!r.includes(i)),n=r.filter(i=>!t.includes(i));o.forEach(i=>this.addStore(i,{},0)),n.forEach(i=>this.removeStore(i))}else{Array.from(this.storeMap.keys()).filter(o=>!Object.keys(t).includes(o)).forEach(o=>this.removeStore(o));for(let o in t){let{data:n,version:i}=t[o];this.storeMap.has(o)?this.storeMap.get(o)?.sync(n,i):this.addStore(o,n,i)}}}};var qr={};Br(qr,{JsonPatchError:()=>M,_areEquals:()=>It,applyOperation:()=>Je,applyPatch:()=>it,applyReducer:()=>ji,deepClone:()=>$i,getValueByPointer:()=>je,validate:()=>Bo,validator:()=>Zt});var Yi=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,n){o.__proto__=n}||function(o,n){for(var i in n)n.hasOwnProperty(i)&&(o[i]=n[i])},e(t,r)};return function(t,r){e(t,r);function o(){this.constructor=t}t.prototype=r===null?Object.create(r):(o.prototype=r.prototype,new o)}}(),zi=Object.prototype.hasOwnProperty;function Jt(e,t){return zi.call(e,t)}function jt(e){if(Array.isArray(e)){for(var t=new Array(e.length),r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(e);var o=[];for(var n in e)Jt(e,n)&&o.push(n);return o}function W(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Xt(e){for(var t=0,r=e.length,o;t<r;){if(o=e.charCodeAt(t),o>=48&&o<=57){t++;continue}return!1}return!0}function Ce(e){return e.indexOf("/")===-1&&e.indexOf("~")===-1?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function Dt(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function $t(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(var t=0,r=e.length;t<r;t++)if($t(e[t]))return!0}else if(typeof e=="object"){for(var o=jt(e),n=o.length,i=0;i<n;i++)if($t(e[o[i]]))return!0}}return!1}function Fo(e,t){var r=[e];for(var o in t){var n=typeof t[o]=="object"?JSON.stringify(t[o],null,2):t[o];typeof n<"u"&&r.push(o+": "+n)}return r.join(`
`)}var Ct=function(e){Yi(t,e);function t(r,o,n,i,s){var a=this.constructor,c=e.call(this,Fo(r,{name:o,index:n,operation:i,tree:s}))||this;return c.name=o,c.index=n,c.operation=i,c.tree=s,Object.setPrototypeOf(c,a.prototype),c.message=Fo(r,{name:o,index:n,operation:i,tree:s}),c}return t}(Error);var M=Ct,$i=W,nt={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var o=e[t];return delete e[t],{newDocument:r,removed:o}},replace:function(e,t,r){var o=e[t];return e[t]=this.value,{newDocument:r,removed:o}},move:function(e,t,r){var o=je(r,this.path);o&&(o=W(o));var n=Je(r,{op:"remove",path:this.from}).removed;return Je(r,{op:"add",path:this.path,value:n}),{newDocument:r,removed:o}},copy:function(e,t,r){var o=je(r,this.from);return Je(r,{op:"add",path:this.path,value:W(o)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:It(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}},Ji={add:function(e,t,r){return Xt(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){var o=e.splice(t,1);return{newDocument:r,removed:o[0]}},replace:function(e,t,r){var o=e[t];return e[t]=this.value,{newDocument:r,removed:o}},move:nt.move,copy:nt.copy,test:nt.test,_get:nt._get};function je(e,t){if(t=="")return e;var r={op:"_get",path:t};return Je(e,r),r.value}function Je(e,t,r,o,n,i){if(r===void 0&&(r=!1),o===void 0&&(o=!0),n===void 0&&(n=!0),i===void 0&&(i=0),r&&(typeof r=="function"?r(t,0,e,t.path):Zt(t,0)),t.path===""){var s={newDocument:e};if(t.op==="add")return s.newDocument=t.value,s;if(t.op==="replace")return s.newDocument=t.value,s.removed=e,s;if(t.op==="move"||t.op==="copy")return s.newDocument=je(e,t.from),t.op==="move"&&(s.removed=e),s;if(t.op==="test"){if(s.test=It(e,t.value),s.test===!1)throw new M("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s.newDocument=e,s}else{if(t.op==="remove")return s.removed=e,s.newDocument=null,s;if(t.op==="_get")return t.value=e,s;if(r)throw new M("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return s}}else{o||(e=W(e));var a=t.path||"",c=a.split("/"),m=e,d=1,l=c.length,f=void 0,u=void 0,p=void 0;for(typeof r=="function"?p=r:p=Zt;;){if(u=c[d],u&&u.indexOf("~")!=-1&&(u=Dt(u)),n&&(u=="__proto__"||u=="prototype"&&d>0&&c[d-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&f===void 0&&(m[u]===void 0?f=c.slice(0,d).join("/"):d==l-1&&(f=t.path),f!==void 0&&p(t,0,e,f)),d++,Array.isArray(m)){if(u==="-")u=m.length;else{if(r&&!Xt(u))throw new M("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);Xt(u)&&(u=~~u)}if(d>=l){if(r&&t.op==="add"&&u>m.length)throw new M("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);var s=Ji[t.op].call(t,m,u,e);if(s.test===!1)throw new M("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s}}else if(d>=l){var s=nt[t.op].call(t,m,u,e);if(s.test===!1)throw new M("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s}if(m=m[u],r&&d<l&&(!m||typeof m!="object"))throw new M("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function it(e,t,r,o,n){if(o===void 0&&(o=!0),n===void 0&&(n=!0),r&&!Array.isArray(t))throw new M("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");o||(e=W(e));for(var i=new Array(t.length),s=0,a=t.length;s<a;s++)i[s]=Je(e,t[s],r,!0,n,s),e=i[s].newDocument;return i.newDocument=e,i}function ji(e,t,r){var o=Je(e,t);if(o.test===!1)throw new M("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return o.newDocument}function Zt(e,t,r,o){if(typeof e!="object"||e===null||Array.isArray(e))throw new M("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(nt[e.op]){if(typeof e.path!="string")throw new M("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new M('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new M("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new M("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if((e.op==="add"||e.op==="replace"||e.op==="test")&&$t(e.value))throw new M("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r){if(e.op=="add"){var n=e.path.split("/").length,i=o.split("/").length;if(n!==i+1&&n!==i)throw new M("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==o)throw new M("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if(e.op==="move"||e.op==="copy"){var s={op:"_get",path:e.from,value:void 0},a=Bo([s],r);if(a&&a.name==="OPERATION_PATH_UNRESOLVABLE")throw new M("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}}else throw new M("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r)}function Bo(e,t,r){try{if(!Array.isArray(e))throw new M("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)it(W(t),W(e),r||!0);else{r=r||Zt;for(var o=0;o<e.length;o++)r(e[o],o,t,void 0)}}catch(n){if(n instanceof M)return n;throw n}}function It(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var r=Array.isArray(e),o=Array.isArray(t),n,i,s;if(r&&o){if(i=e.length,i!=t.length)return!1;for(n=i;n--!==0;)if(!It(e[n],t[n]))return!1;return!0}if(r!=o)return!1;var a=Object.keys(e);if(i=a.length,i!==Object.keys(t).length)return!1;for(n=i;n--!==0;)if(!t.hasOwnProperty(a[n]))return!1;for(n=i;n--!==0;)if(s=a[n],!It(e[s],t[s]))return!1;return!0}return e!==e&&t!==t}var zr={};Br(zr,{compare:()=>er,generate:()=>Kr,observe:()=>ns,unobserve:()=>os});var Hr=new WeakMap,Xi=function(){function e(t){this.observers=new Map,this.obj=t}return e}(),Zi=function(){function e(t,r){this.callback=t,this.observer=r}return e}();function es(e){return Hr.get(e)}function ts(e,t){return e.observers.get(t)}function rs(e,t){e.observers.delete(t.callback)}function os(e,t){t.unobserve()}function ns(e,t){var r=[],o,n=es(e);if(!n)n=new Xi(e),Hr.set(e,n);else{var i=ts(n,t);o=i&&i.observer}if(o)return o;if(o={},n.value=W(e),t){o.callback=t,o.next=null;var s=function(){Kr(o)},a=function(){clearTimeout(o.next),o.next=setTimeout(s)};typeof window<"u"&&(window.addEventListener("mouseup",a),window.addEventListener("keyup",a),window.addEventListener("mousedown",a),window.addEventListener("keydown",a),window.addEventListener("change",a))}return o.patches=r,o.object=e,o.unobserve=function(){Kr(o),clearTimeout(o.next),rs(n,o),typeof window<"u"&&(window.removeEventListener("mouseup",a),window.removeEventListener("keyup",a),window.removeEventListener("mousedown",a),window.removeEventListener("keydown",a),window.removeEventListener("change",a))},n.observers.set(t,new Zi(t,o)),o}function Kr(e,t){t===void 0&&(t=!1);var r=Hr.get(e.object);Yr(r.value,e.object,e.patches,"",t),e.patches.length&&it(r.value,e.patches);var o=e.patches;return o.length>0&&(e.patches=[],e.callback&&e.callback(o)),o}function Yr(e,t,r,o,n){if(t!==e){typeof t.toJSON=="function"&&(t=t.toJSON());for(var i=jt(t),s=jt(e),a=!1,c=!1,m=s.length-1;m>=0;m--){var d=s[m],l=e[d];if(Jt(t,d)&&!(t[d]===void 0&&l!==void 0&&Array.isArray(t)===!1)){var f=t[d];typeof l=="object"&&l!=null&&typeof f=="object"&&f!=null&&Array.isArray(l)===Array.isArray(f)?Yr(l,f,r,o+"/"+Ce(d),n):l!==f&&(a=!0,n&&r.push({op:"test",path:o+"/"+Ce(d),value:W(l)}),r.push({op:"replace",path:o+"/"+Ce(d),value:W(f)}))}else Array.isArray(e)===Array.isArray(t)?(n&&r.push({op:"test",path:o+"/"+Ce(d),value:W(l)}),r.push({op:"remove",path:o+"/"+Ce(d)}),c=!0):(n&&r.push({op:"test",path:o,value:e}),r.push({op:"replace",path:o,value:t}),a=!0)}if(!(!c&&i.length==s.length))for(var m=0;m<i.length;m++){var d=i[m];!Jt(e,d)&&t[d]!==void 0&&r.push({op:"add",path:o+"/"+Ce(d),value:W(t[d])})}}}function er(e,t,r){r===void 0&&(r=!1);var o=[];return Yr(e,t,o,"",r),o}var Ia=Object.assign({},qr,zr,{JsonPatchError:Ct,deepClone:W,escapePathComponent:Ce,unescapePathComponent:Dt});var tr=Symbol("STORE_MUTATIONS"),$r=class{_data;_mutationRecords=[];storedMinVersion=0;_version=0;get version(){return this._version}flush(){return{operations:this._mutationRecords.slice(0),fromVersion:this.storedMinVersion,toVersion:this.version}}flushDone(t){this._mutationRecords=this._mutationRecords.slice(t-this.storedMinVersion),this.storedMinVersion=t}patchVersionAcceptable(t){return this._version!=-1&&t<=this._version}patchData(t){let r=W(this._data);it(this._data,t),this._version+=t.length,this.storedMinVersion=this._version,this.dispatch(t,r)}get data(){return W(this._data)}static[tr]=[];constructor(t){this._data=W(t)}sync(t,r){let o=this._data,n=er(o,t);Object.assign(this._data,t),this.storedMinVersion=this._version=r,this.dispatch(n,o)}subscribers=[];subscribe(t,r){this.subscribers.push([t,r])}unsubscribe(t){this.subscribers=this.subscribers.filter(([r,o])=>o!=t)}dispatch(t,r){let o=new Map;t.forEach(n=>{this.subscribers.forEach(([i,s])=>{n.path.startsWith(i)&&!o.has(i)&&o.set(i,JSON.stringify(i==="/"?r:je(r,i)))})}),o.forEach((n,i)=>{let s=i==="/"?this._data:je(this._data,i);n!==JSON.stringify(s)&&this.subscribers.filter(([a,c])=>a===i).forEach(([a,c])=>{let m={};try{m=c(s,JSON.parse(n||{}))}catch(d){console.error(d.stack||d.message||d)}m instanceof Promise&&m.catch(d=>{console.error(d.stack||d.message||d)})})})}};function x(e,t,r){return e.constructor[tr]||(e.constructor[tr]=[]),e.constructor[tr].push(t),{value:function(...o){let n=W(this._data);r.value.apply(this,o);let i=er(n,this._data);i.length!=0&&(this._mutationRecords.push(...i),this._version+=i.length,this.dispatch(i,n))}}}var Xe=class extends $r{constructor(t){super(Object.assign({sid:"",ssid:""},t||{}))}setSID(t){this._data.sid=t,this._data.ssid=t.slice(0,4)}};_([x],Xe.prototype,"setSID",1);var de=class extends Xe{constructor(t,r){super(t||{uname:"",comfyUserToken:"",isLocal:!1,activeDocumentID:0,documents:{},actions:[],canvasStateID:0,selectionStateID:"",historyStateID:0}),this._version=r||0}setIsLocal(t){this._data.isLocal=t}setUName(t){this._data.uname="PS_"+t}setDocument(t,r){this._data.activeDocumentID=t,this._data.documents=r}setCanvasStateID(t){this._data.canvasStateID=t}setSelectionStateID(t){this._data.selectionStateID=t}setHistoryStateID(t){this._data.historyStateID=t}setComfyUserToken(t){this._data.comfyUserToken=t}setActions(t){this._data.actions=t}};_([x],de.prototype,"setIsLocal",1),_([x],de.prototype,"setUName",1),_([x],de.prototype,"setDocument",1),_([x],de.prototype,"setCanvasStateID",1),_([x],de.prototype,"setSelectionStateID",1),_([x],de.prototype,"setHistoryStateID",1),_([x],de.prototype,"setComfyUserToken",1),_([x],de.prototype,"setActions",1);var K=class extends Xe{constructor(t,r){super(t||{title:"",webviewFromSid:location.search.match(/webview_fromsid=([^&]+)/)?.[1]||"",progress:0,lastError:"",queueSize:0,executingNodeTitle:"",widgetTableStructure:{widgetTablePath:"",widgetTablePersisted:!1,widgetTableID:"",nodes:{},groups:{},nodeIndexes:[],extraOptions:{}},widgetTableValue:{},widgetTableErrors:{},useSliderForNumberWidget:!1,hasPSDNodes:!1,comfyUserToken:"",comfyOrgLoggedIn:!1,comfyOrgAPIKey:""}),this._version=r||0}setWebviewFromSid(t){this._data.webviewFromSid=t}setTitle(t){this._data.title=t}setProgress(t){this._data.progress=t}setLastError(t){this._data.lastError=t}setQueueSize(t){this._data.queueSize=t}setExecutingNodeTitle(t){this._data.executingNodeTitle=t}setWidgetTableStructure(t){this._data.widgetTableStructure=JSON.parse(JSON.stringify(t))}setWidgetTableValue(t){this._data.widgetTableValue=JSON.parse(JSON.stringify(t))}setWidgetTableErrors(t){this._data.widgetTableErrors=JSON.parse(JSON.stringify(t))}setHasPSDNodes(t){this._data.hasPSDNodes=t}setComfyUserToken(t){this._data.comfyUserToken=t}setComfyOrgLoggedIn(t){this._data.comfyOrgLoggedIn=t}setComfyOrgAPIKey(t){this._data.comfyOrgAPIKey=t}setUseSliderForNumberWidget(t){this._data.useSliderForNumberWidget=t}};_([x],K.prototype,"setWebviewFromSid",1),_([x],K.prototype,"setTitle",1),_([x],K.prototype,"setProgress",1),_([x],K.prototype,"setLastError",1),_([x],K.prototype,"setQueueSize",1),_([x],K.prototype,"setExecutingNodeTitle",1),_([x],K.prototype,"setWidgetTableStructure",1),_([x],K.prototype,"setWidgetTableValue",1),_([x],K.prototype,"setWidgetTableErrors",1),_([x],K.prototype,"setHasPSDNodes",1),_([x],K.prototype,"setComfyUserToken",1),_([x],K.prototype,"setComfyOrgLoggedIn",1),_([x],K.prototype,"setComfyOrgAPIKey",1),_([x],K.prototype,"setUseSliderForNumberWidget",1);var Jr=class extends zt{createStore(t,r){return new K(t,r)}},O=new Jr,D=new de;var Vo=e=>{let t,r=new Set,o=(m,d)=>{let l=typeof m=="function"?m(t):m;if(!Object.is(l,t)){let f=t;t=d??(typeof l!="object"||l===null)?l:Object.assign({},t,l),r.forEach(u=>u(t,f))}},n=()=>t,a={setState:o,getState:n,getInitialState:()=>c,subscribe:m=>(r.add(m),()=>r.delete(m))},c=t=e(o,n,a);return a},Go=e=>e?Vo(e):Vo;var jr=v(E(),1);var is=e=>e;function ss(e,t=is){let r=jr.default.useSyncExternalStore(e.subscribe,()=>t(e.getState()),()=>t(e.getInitialState()));return jr.default.useDebugValue(r),r}var qo=e=>{let t=Go(e),r=o=>ss(t,o);return Object.assign(r,t),r},Ko=e=>e?qo(e):qo;var Le=N("photoshop");var H=Ko((e,t)=>({canvasDirtyID:0,selectionDirtyID:0,layerDirtyIDs:new Map,documentCache:{},incrementCanvasDirtyID:()=>{e(r=>({canvasDirtyID:r.canvasDirtyID+1})),Xr()},incrementLayerDirtyID:r=>{e(o=>{let n=o.layerDirtyIDs.get(r)||0,i=new Map(o.layerDirtyIDs);return i.set(r,n+1),{layerDirtyIDs:i}}),Xr()},incrementSelectionDirtyID:()=>{e(r=>({selectionDirtyID:r.selectionDirtyID+1})),Xr()},setDocuments:r=>{e({documentCache:r}),Le.app.activeDocument&&D.setDocument(Le.app.activeDocument.id,JSON.parse(JSON.stringify(r)))},clearCanvasDirtyID:()=>{e({canvasDirtyID:0})},clearLayerDirtyIDs:()=>{e({layerDirtyIDs:new Map})},clearSelectionDirtyID:()=>{e({selectionDirtyID:0})}}));function Xr(){if(!Le.app.activeDocument)return;let e=H.getState().documentCache[Le.app.activeDocument.id];if(e){let t={...e,dirtyID:H.getState().canvasDirtyID,layers:e.layers.map(r=>{let o=H.getState().layerDirtyIDs.get(r.id);return o!==void 0?{...r,dirtyID:o}:r})};H.setState(r=>({documentCache:{...r.documentCache,[Le.app.activeDocument.id]:t}})),D.setDocument(Le.app.activeDocument.id,H.getState().documentCache)}}function st(){try{if(!Le.app.activeDocument)return;let e=Le.app.documents.reduce((t,r)=>{let o=Qr(r).map(n=>{let i=n.layer.id;return{level:n.level,id:i,name:n.layer.name,identify:De(i,n.layer.name,n.level),fullPath:n.path,dirtyID:H.getState().layerDirtyIDs.get(i)||0}});return t[r.id]={name:r.name,id:r.id,identify:Ae(r.id,r.name),layers:o,canvasDirtyID:H.getState().canvasDirtyID,selectionDirtyID:H.getState().selectionDirtyID},t},{});H.getState().setDocuments(e)}catch(e){console.error(e)}}function rr(){H.getState().incrementCanvasDirtyID()}function Re(e){Array.isArray(e)?e.forEach(t=>{H.getState().incrementLayerDirtyID(t)}):H.getState().incrementLayerDirtyID(e)}function Ho(){H.getState().clearCanvasDirtyID(),H.getState().clearLayerDirtyIDs(),st()}function Zr(){H.getState().incrementSelectionDirtyID()}(async()=>{D.setUName(Uo()),st()})().catch(console.error);T.action.addNotificationListener(["historyStateChanged"],e=>{as(),(e.commandID==5004||e.commandID==5002)&&(Et(),Re(T.app.activeDocument?.activeLayers.map(t=>t.id)))});T.action.addNotificationListener(["toolModalStateChanged"],(e,t,...r)=>{t.state._value=="exit"&&t.kind._value=="paint"&&(Et(),Re(T.app.activeDocument?.activeLayers.map(o=>o.id)))});T.action.addNotificationListener(["modalStateChanged"],(e,t)=>{t.state._value=="exit"&&(Et(),Re(T.app.activeDocument?.activeLayers.map(r=>r.id)))});T.action.addNotificationListener(["show","hide","transform","fill","crop"],()=>{Et(),Re(T.app.activeDocument?.activeLayers.map(e=>e.id))});T.action.addNotificationListener(["delete","move","copyToLayer"],()=>{st(),Et(),Re(T.app.activeDocument?.activeLayers.map(e=>e.id))});T.action.addNotificationListener(["newDocument","open","close","make","modalJavaScriptScopeExit"],()=>st());function Et(){let e=T.app.activeDocument?.historyStates;e&&D.setCanvasStateID(e[e.length-1].id),rr()}function as(){let e=T.app.activeDocument?.historyStates;e&&D.setHistoryStateID(e[e.length-1].id)}function Yo(){D.setSelectionStateID(zo+"_"+At+"_"+or)}var At=T.app.activeDocument?.id,or=T.app.activeDocument?.activeLayers.map(e=>e.id).join(","),zo=0;T.action.addNotificationListener(["set"],(e,t)=>{t._target[0]._property=="selection"&&(zo++,Yo(),Zr())});function $o(){let e=T.app.activeDocument?.activeLayers.map(r=>r.id).join(",");At!=T.app.activeDocument?.id&&Ho();let t=[];T.app.actionTree.forEach(r=>{r.actions.forEach(o=>{t.push(r.name+"/"+o.name)})}),(D.data.actions.length!=t.length||D.data.actions.some((r,o)=>r!=t[o]))&&D.setActions(t),At!=T.app.activeDocument?.id||or!=e?(At=T.app.activeDocument?.id,or=e,Yo(),Zr()):(At=T.app.activeDocument?.id,or=e),requestAnimationFrame($o)}requestAnimationFrame($o);setInterval(()=>st(),5e3);globalThis.sdpppX=globalThis.sdpppX||{};var R=globalThis.sdpppX;var en=v(sr(),1),tn=[];R.getLogs=()=>tn;localStorage.setItem("debug","sdppp:*");en.debug.log=(...e)=>{tn.push(e.join(" "))};var gt=v(E(),1);var U=v(E(),1);var L=v(E(),1);var an=v(P(),1),nn=(0,L.createContext)(null);function sn({children:e}){let t=bs();return(0,L.useEffect)(()=>{window.addEventListener("message",o=>{o.data.action==="webview-connect"&&o.source?.postMessage({action:"webview-connect",payload:{webviewFromSid:D.data.sid}})});let r="";O.subscribe("/",(o,n,i)=>{n?.webviewFromSid==D.data.sid&&(t.setWebviewAgentSID(n?.sid),r||(r=n?.sid)),!n&&i.webviewFromSid==D.data.sid&&t.setWebviewAgentSID(r)})},[]),(0,an.jsx)(nn.Provider,{value:{webviewAgentSID:t.webviewAgentSID,prevWebviewAgentSID:t.prevWebviewAgentSID,setWebviewAgentSID:t.setWebviewAgentSID,toggleWebviewDialog:t.toggleWebviewDialog,setSrc:t.setSrc,resetWebview:t.resetWebview,timeoutError:t.timeoutError,loadError:t.loadError},children:e})}function J(){let e=(0,L.useContext)(nn);if(!e)throw new Error("useSDPPPWebview must be used within a SDPPPWebviewProvider");return e}function bs(){let[e,t]=(0,L.useState)(null),[r,o]=(0,L.useState)(null),[n,i]=(0,L.useState)(null),[s,a]=(0,L.useState)(!1),[c,m]=(0,L.useState)(""),[d,l]=(0,L.useState)(""),[f,u]=(0,L.useState)(""),[p,h]=(0,L.useState)(!1),[w,b]=(0,L.useState)(!1),y=(0,L.useRef)(null),[S,I]=(0,L.useState)("");(0,L.useEffect)(()=>{let Q=()=>{a(!1),l(f),oe()};return n?.addEventListener("close",Q),()=>{n?.removeEventListener("close",Q)}},[n,f,l,a]),(0,L.useEffect)(()=>{u(d)},[d]),(0,L.useEffect)(()=>{Ps(i,o);let Q=on();return t(Q),y.current&&clearTimeout(y.current),h(!1),b(!1),y.current=setTimeout(()=>{h(!0)},5e3),Q.addEventListener("loadstop",()=>{b(!0)}),Q.addEventListener("loaderror",Se=>{I(Se.message||Se.type)}),Q.addEventListener("loadstart",()=>{I("")}),()=>{y.current&&clearTimeout(y.current),n?.parentElement?.removeChild(n)}},[]);let[$,ve]=(0,L.useState)("");(0,L.useEffect)(()=>{c&&(ve(c),$===c?oe():(e?.setAttribute("src",c),r?.setAttribute("src",c)))},[c]);let oe=(0,L.useCallback)(()=>{e?.parentElement?.removeChild(e),a(!1),n?.close();let Q=on();t(Q);let Se=c;m(""),ve(""),setTimeout(()=>{m(Se)},300)},[e,c]),k=(0,L.useCallback)(()=>{s?(n?.close(),a(!1)):(n?.show(),a(!0))},[n,s]);return{dialogShowing:s,toggleWebviewDialog:k,setSrc:m,webviewAgentSID:d,setWebviewAgentSID:l,prevWebviewAgentSID:f,setPrevWebviewAgentSID:u,resetWebview:oe,anyWebviewLoaded:w,timeoutError:(0,L.useMemo)(()=>p&&!w,[p,w]),loadError:S}}function Ps(e,t){let r=document.createElement("dialog");r.className="sdppp-webview",r.style.padding="0",r.style.margin="0",r.style.width="1024px",r.style.height="768px",document.body.appendChild(r),e(r);let o=document.createElement("webview");return o.style.position="relative",o.style.width="1024px",o.style.height="768px",r.appendChild(o),t(o),r}var ke=null;function on(){ke||(ke=document.createElement("div"),ke.style.position="absolute",ke.style.width="100px",ke.style.height="100px",ke.style.right="0",ke.style.bottom="-10000px",document.body.appendChild(ke));let e=document.createElement("webview");return e.style.width="100px",e.style.height="100px",ke?.appendChild(e),e}var fn=v(un(),1);var ln="507";var dn=ln.trim();var eo=class{socket;constructor(t){let r="/"+[t.split("/").slice(3).filter(o=>o).join("/"),"sd-ppp/"].filter(o=>o).join("/");t=t.split("/").slice(0,3).join("/"),this.socket=(0,fn.io)(t,{transports:["websocket"],path:r,query:{api_level:dn},rejectUnauthorized:!1,autoConnect:!1}),this.socket.on("connect",()=>{this.socket.io.engine.binaryType="blob"})}get id(){return this.socket.id}connect(){this.socket.connect()}close(){this.socket.close()}};function pn(...e){return e.reduce((t,r)=>r(t),eo)}var ar=class{flushing=Promise.resolve();newFlushPending=!1;constructor(t){this.doFlush=t,this.pause()}doFlush;runFlush(){this.newFlushPending||(this.newFlushPending=!0,this.flushing=this.flushing.then(async()=>{await new Promise(t=>requestAnimationFrame(t)),this.newFlushPending=!1,await this.doFlush()}))}pause(){this.flushing=this.flushing.then(t=>new Promise(r=>{this.resume=r})).then(()=>{this.resume=()=>{}})}resume=()=>{}};function mn(e,t){return function(r){return class extends r{constructor(o){super(o),this.socket.on("store_request",(i,s)=>{s({data:e.data,version:e.version})});let n=new ar(async()=>{let{operations:i,fromVersion:s,toVersion:a}=e.flush();await new Promise(c=>{let m=!1;setTimeout(()=>{m||(console.warn("flush timeout"),c())},5e3),this.socket.emit("store_flush",{operations:i,fromVersion:s},d=>{m=!0,c(),d?.error?console.error("flush error",d.error):e.flushDone(a)})})});e.subscribe("/",()=>{n.runFlush()}),this.socket.on("disconnect",()=>{n.pause()}),this.socket.on("connect",()=>{e.setSID(this.socket.id||""),requestAnimationFrame(()=>{this.socket.emit("sdppp_init",{type:t,data:e.data,version:e.version})})}),this.socket.on("sdppp_inited",i=>{n.resume()})}}}}function hn(e,t){return function(r){return class extends r{constructor(o){super(o),this.socket.on("store_flush",n=>{if(n.type!==t)return;let i=e.getStore(n.sid);if(i)i.patchVersionAcceptable(n.fromVersion)?i.patchData(n.operations):(console.warn("patch version not acceptable from",n.fromVersion,"current version is",i.version),this.socket.emit("store_request",{type:t},s=>{e.sync(s)}));else return this.socket.emit("store_request",{sid:n.sid},s=>{e.addStore(s.sid,s.data,s.version)})}),this.socket.on("store_remove",n=>{e.removeStore(n.sid)}),this.socket.on("sdppp_inited",n=>{this.socket.emit("store_request",{type:t},i=>{e.sync(i)})})}}}}async function to(e){let t=e.document_identify,r=F(t);if(!r)throw new Error(g("document {0} not found",t));let o=r.selection,n=o&&o.bounds?{left:o.bounds.left,top:o.bounds.top,right:r.width-o.bounds.right,bottom:r.height-o.bounds.bottom,width:o.bounds.width,height:o.bounds.height}:null,i={left:0,top:0,right:0,bottom:0,width:r.width,height:r.height};return{document_boundary:i,selection_boundary:n||i}}var _t=N("photoshop");var _e=N("photoshop"),ro=class{promise;restore;constructor(){this.restore=()=>{},this.promise=new Promise(t=>{this.restore=t})}add(t){this.promise.then(t)}};_e.core.setExecutionMode({enableErrorStacktraces:!0});var Lt=Promise.resolve();async function B(e,t){let r=t.dontRecoverSelection||!1,o=new ro,n=!1,i=[],s=[],a=t.commandName;r||(_e.app.activeDocument.activeLayers.forEach(l=>i.push(l)),t.document&&_e.app.activeDocument.id!=t.document.id&&t.document.activeLayers.forEach(l=>i.push(l)),s=i.map(l=>l.visible),o.add(()=>{i.forEach(l=>{l.selected||(l.selected=!0,n=!0)}),t.document==_e.app.activeDocument&&i.forEach((l,f)=>{l.visible=s[f]})}));let c=null;Lt=Lt.catch(l=>l).then(()=>new Promise(l=>{f();function f(){_e.core.isModal()?requestAnimationFrame(f):l()}})).then(()=>_e.core.executeAsModal(async function(l,...f){c=t.document?await l.hostControl.suspendHistory({documentID:t.document.id,name:a}):null,o.add(async()=>{await new Promise(requestAnimationFrame),n||c&&l.hostControl.resumeHistory(c)});try{let u=await e(o,l,...f);return o.restore(!0),u}catch(u){throw o.restore(!1),u}},{commandName:a,interactive:!0}));let m=null,d=null;try{await Lt}catch(l){d=l}if(n&&(Lt=_e.core.executeAsModal(async l=>{i.forEach((f,u)=>{f.visible=s[u]}),c&&l.hostControl.resumeHistory(c)},{commandName:a,interactive:!0}),await Lt),d)throw d;return m}var lt=v(kt(),1),yn=v(sr(),1),Ds=(0,yn.default)("sdppp:getImage");function Cs(e,t){for(let r=0,o=e.length/4;r<o;r++){let n=t?t[r]/255:1;e[4*r+3]=n*e[4*r+3],e[4*r+3]||(e[4*r]=e[4*r+1]=e[4*r+2]=0)}return e}function Is(e){if(e.dataFromAPI.length!=e.width*e.height*3)throw new Error(g("unsupported channel counts: {0}",e.dataFromAPI.length/(e.width*e.height)));let t=new Uint8Array(e.width*e.height*4);for(let r=0;r<e.width*e.height;r++)t[r*4]=e.dataFromAPI[r*3],t[r*4+1]=e.dataFromAPI[r*3+1],t[r*4+2]=e.dataFromAPI[r*3+2],t[r*4+3]=255;return{dataFromAPI:t,width:e.width,height:e.height}}function cr(e){if(e.dataFromAPI instanceof Uint8Array)return e;let{dataFromAPI:t,width:r,height:o}=e,n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)if(t instanceof Uint16Array)t[i]==32768?n[i]=255:n[i]=Math.floor(t[i]/128);else throw new Error("32-bit color not supported");return{dataFromAPI:n,width:r,height:o}}function ur(e,t,r,o=4){if(e.width==r.width&&e.height==r.height&&e.dataFromAPI.length==r.width*r.height*o)return e.dataFromAPI;let n=new Uint8Array(r.width*r.height*o);return Oo(e.dataFromAPI,n,t,r,o),n}async function As(e,t,r){let o={documentID:e.id,applyAlpha:!1,hasAlpha:!0,sourceBounds:r,colorSpace:"RGB"};(e.mode!==_t.constants.DocumentMode.RGB||e.colorProfileName!=="sRGB IEC61966-2.1")&&Object.assign(o,{colorProfile:"sRGB IEC61966-2.1"}),t&&(o.layerID=t.id);let i=(await _t.imaging.getPixels(o)).imageData,s=await i.getData({});return Promise.resolve().then(()=>{i.dispose()}),{dataFromAPI:s,width:i.width,height:i.height}}async function Es(e,t,r){if(!t)return null;let o={documentID:e.id,sourceBounds:r,layerID:t.id},n=null;try{n=await _t.imaging.getLayerMask(o)}catch(a){return console.warn(a),null}let i=n.imageData;if(!i)return null;let s=await i.getData({});return Promise.resolve().then(()=>{i.dispose()}),{dataFromAPI:s,width:i.width,height:i.height}}async function wn(e){let t=e.document_identify,r=F(t);if(!r)throw new Error(g("document {0} not found",t));let o=e.layer_identify,n=ee(r,o);if(Ds("getJimpImage",o),e.boundary&&e.boundary.right+e.boundary.left+e.boundary.bottom+e.boundary.top+e.boundary.width+e.boundary.height!=r.width+r.height)throw new Error("The boundary is not for this document");let i=e.boundary?{left:e.boundary.left,top:e.boundary.top,right:r.width-e.boundary.right,bottom:r.height-e.boundary.bottom,width:e.boundary.width,height:e.boundary.height}:{left:0,top:0,right:r.width,bottom:r.height,width:r.width,height:r.height},s={pixelData:null,width:0,height:0},a=null,c,m,d={left:0,top:0,right:r.width,bottom:r.height},l=!1;if(await B(async p=>{let[h,w]=await Yt(r,n);w&&(a=h),a!=null&&p.add(()=>{a.delete()}),[c,m]=await Promise.all([As(r,h,i),Es(r,h,i)]),d=h?.bounds??d,l=!1,h?l=h.transparentPixelsLocked:C.is_SPECIAL_LAYER_USE_CANVAS(o)&&(l=r.layers.every(b=>b.transparentPixelsLocked))},{commandName:g("get content of layer {0}",o),document:r}),!c)throw new Error(g("get pixel of {0} failed",o));c=cr(c),l&&(c=Is(c)),s.pixelData=ur(c,d,i);let f=null;return m&&(m=cr(m),f=ur(m,d,i,1)),s.pixelData=Cs(s.pixelData,f),s.width=i.width,s.height=i.height,new lt.Jimp({data:Buffer.from(s.pixelData),width:i.width,height:i.height})}async function vn(e){let t=await wn(e),r=t.bitmap.width,o=t.bitmap.height,n=new Uint8Array(r*o);for(let a=0;a<r*o;a++)n[a]=t.bitmap.data[a*4+3];let i=new lt.Jimp({width:r,height:o});for(let a=0;a<r*o;a++)i.bitmap.data[a*4+3]=t.bitmap.data[a*4+3];return{jpegData:new Uint8Array(await t.getBuffer(lt.JimpMime.jpeg,{quality:e.quality})),alphaData:new Uint8Array(await i.getBuffer(lt.JimpMime.png))}}vn.getJimpImage=wn;var lr=vn;async function xt(e){let t=e.document_identify,r=F(t);if(!r)throw new Error(g("document {0} not found",t));if(!e.layer_identify)throw new Error(g("get_layer_info: layer_identify required"));let o={name:"",opacity:0,boundary:{left:0,right:0,top:0,bottom:0,width:r.width,height:r.height},isGroup:!1,identify:""};return await B(async n=>{let i=null,s=e.layer_identify,a=!1;if(e.layer_identify){s=e.layer_identify;let c=ee(r,s);if(C.is_SPECIAL_LAYER_USE_CANVAS(s))return o={name:"",opacity:1,boundary:{left:0,right:0,top:0,bottom:0,width:r.width,height:r.height},isGroup:!0,identify:s},o;[i,a]=await Yt(r,c),n.add(()=>{i&&a&&i.delete()})}if(!i)throw new Error(g("layer not found: {0}",e.layer_identify));o=Object.assign({isGroup:a,identify:s||""},Mo(r,i))},{commandName:g("get layer info"),document:r}),o}var dr=N("photoshop");async function oo(e,t,r){let o=e.select||"all",n=e.document_identify,i=F(n);if(!i)throw new Error(g("document {0} not found",n));let s=e.layer_identifies,a=await Promise.all(s.map(async m=>{let d=ee(i,m);if(C.is_SPECIAL_LAYER_USE_CANVAS(m))throw new Error(g("layer not found: {0}",m));let l=le(i,d);if(!l)throw new Error(g("layer not found {0}",m));r(l);let f=t(l);if(o==="first"&&f.length===0)throw new Error(g("no first related layer in {0}",m));let u=f.filter((p,h)=>o==="first"?h===0:o==="text"?p.kind===dr.constants.LayerKind.TEXT:o==="image"?p.kind===dr.constants.LayerKind.NORMAL:!0).map(p=>De(p.id,p.name));return{layer_identifies:u,layer_infos:await Promise.all(u.map(p=>xt({document_identify:n,layer_identify:p})))}})),c={layer_identifies:[],layer_boundaries:[],layer_infos:[]};return a.forEach(({layer_identifies:m,layer_infos:d})=>{c.layer_identifies.push(...m),c.layer_boundaries.push(...d.map(l=>l.boundary)),c.layer_infos.push(...d)}),c}async function no(e){return oo(e,t=>t.layers||[],t=>{if(t.kind!=dr.constants.LayerKind.GROUP)throw new Error(g("layer {0} is not a group",t.name));if(!t.layers)throw new Error(g("layer {0} is not a group",t.name))})}async function io(e){return oo(e,t=>t.linkedLayers||[],t=>{if(!t.linkedLayers)throw new Error(g("no linked layer for {0}",t.name))})}var bn=N("photoshop"),Pn=N("uxp");async function Ls(e,t){let r={documentID:e.id,sourceBounds:t},n=(await bn.imaging.getSelection(r)).imageData,i=await n.getData({});return Promise.resolve().then(()=>{n.dispose()}),{dataFromAPI:i,width:n.width,height:n.height}}async function Tt(e){let t=e.document_identify,r=F(t);if(!r)throw new Error(g("document {0} not found",t));let o=parseInt(Pn.host.version.split(".")[0]);if(!isNaN(o)&&o<25)throw new Error(g("GetSelection need Photoshop version 25+"));let n=e.boundary?{left:e.boundary.left,top:e.boundary.top,right:r.width-e.boundary.right,bottom:r.height-e.boundary.bottom,width:e.boundary.width,height:e.boundary.height}:{left:0,top:0,right:r.width,bottom:r.height,width:r.width,height:r.height};if(!r.selection?.bounds){let s=new Uint8Array(n.width*n.height);return s.fill(255),{blob:s,width:n.width,height:n.height}}let i=null;return await B(async s=>{let a=await Ls(r,n);a=cr(a);let c=r.selection.bounds||{left:0,top:0,right:r.width,bottom:r.height};i=a&&ur(a,c,n,1)},{document:r,commandName:"SDPPP getSelection"}),{blob:i,width:n.width,height:n.height}}var fe=N("photoshop");async function so(e){let{identifier:t}=e;if(C.is_SPECIAL_DOCUMENT_CURRENT(t)){if(!fe.app.activeDocument){if(e.width&&e.height){let r=await ks(e.width,e.height);if(r)return{value:Ae(r.id,r.name)}}throw new Error(g("document {0} not found",t))}return{value:Ae(fe.app.activeDocument.id,fe.app.activeDocument.name)}}else if(C.is_SPECIAL_LAYER_SELECTED_LAYER(t)){if(!fe.app.activeDocument)return{error:g("document {0} not found","current")};let r=fe.app.activeDocument.activeLayers[0];return r?{value:De(r.id,r.name)}:{error:g("layer not found {0}",t)}}}async function ks(e,t){if(fe.app.activeDocument)return fe.app.activeDocument;let r=null;return await B(async()=>{r=await fe.app.createDocument({width:e,height:t,resolution:72,mode:fe.constants.NewDocumentMode.RGB,fill:fe.constants.DocumentFill.TRANSPARENT})},{document:null,commandName:g("create document for sent images")}),r}var Sn=N("photoshop");async function ao(e){let t=e.document_identify,r=F(t);if(!r)throw new Error(g("document {0} not found",t));let o=e.layer_identify,n=ee(r,o),i={text:""},s=le(r,n);if(!s||s.kind!=Sn.constants.LayerKind.TEXT)throw new Error(g('only layer kind "TEXT" is supported, invalid layer: {0}',o));return i.text=s.textItem.contents,{text:i.text}}var ie=N("photoshop"),dt=N("uxp");var fr=0,Dn=0,_s=5e3;async function co(e){let t=e.document_identify,r=t?F(t):null;if(e.action==="get"){let o;return await B(async function(n){if(r||(r=await xs()),!r)throw new Error(g("create document failed"));r=await r.duplicate(),n.add(async()=>{r?.close()});let s=await(await dt.storage.localFileSystem.getTemporaryFolder()).createEntry("sdppp.psd",{overwrite:!0});await r.saveAs.psd(s,{maximizeCompatibility:!1,typename:"PhotoshopSaveOptions"}),o=await s.read({format:dt.storage.formats.binary})},{commandName:g("sdppp get PSD"),document:r}),o?{data:o}:{error:"save Document failed"}}else if(e.action==="extract"){if(Date.now()-Dn<_s||fr>2||!confirm(g("{0} wants to extract a PSD file to Photoshop, are you sure?",e.fromSSID))){fr++,fr==3&&(confirm(g("should sdppp refuse extracting PSD to Photoshop in this session anymore?"))||fr--);return}Dn=Date.now();let o=e.data;await B(async function(){if(r||(r=await ie.app.createDocument({width:512,height:512,resolution:72,mode:ie.constants.NewDocumentMode.RGB,fill:ie.constants.DocumentFill.TRANSPARENT})),!r)throw new Error(g("document {0} not found",t));ie.app.activeDocument=r,r.selection?.deselect();let n=await o.arrayBuffer(),s=await(await dt.storage.localFileSystem.getTemporaryFolder()).createEntry("sdppp.psd",{overwrite:!0});await s.write(n,{format:dt.storage.formats.binary});let a=dt.storage.localFileSystem.createSessionToken(s),c=await r.createLayer(ie.constants.LayerKind.NORMAL,{name:"sdppp"});if(!c)throw new Error(g("create layer failed"));c.move(r.layers[0],ie.constants.ElementPlacement.PLACEBEFORE),await ie.action.batchPlay([{_obj:"placeEvent",null:{_kind:"local",_path:a},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},{_obj:"placedLayerConvertToLayers"},{_obj:"ungroupLayersEvent",_target:[{_enum:"ordinal",_ref:"layer"}]}],{synchronousExecution:!0})},{commandName:g("sdppp extract PSD"),document:r,dontRecoverSelection:!0})}else throw new Error(g("invalid action: {0}",e.action))}async function xs(){return await ie.app.createDocument({width:512,height:512,resolution:72,mode:ie.constants.NewDocumentMode.RGB,fill:ie.constants.DocumentFill.TRANSPARENT})}var pr=N("photoshop");async function uo(e){let{action:t}=e,{document_identify:r,layer_identify:o}=e,[n,i]=t.split("/")||[],s=pr.app.actionTree.find(f=>f.name===n);if(!s)throw new Error(g("Action set {0} not found",n));let a=s.actions.find(f=>f.name===i);if(!a)throw new Error(g("Action {0} not found",i));let c=F(r);if(!c)throw new Error(g("document {0} not found",r));let m=c,d=ee(m,o),l=le(m,d);return l&&await B(async()=>{m.activeLayers.forEach(f=>{f.selected=!1}),l.selected=!0},{commandName:g("select layer"),dontRecoverSelection:!0,document:pr.app.activeDocument}),await B(async()=>{await a.play()},{commandName:g("run Photoshop Action"),document:pr.app.activeDocument}),{result:{success:!0}}}var mr=v(kt(),1),se=N("photoshop");async function Ts(e,t){let r=se.app.documents.find(o=>o.name==C.getSpecialDocumentForPreview());if(r)return(r.width<e||r.height<t)&&await B(async()=>{await r.resizeCanvas(Math.max(r.width,e),Math.max(r.height,t))},{document:null,commandName:g("resize document for preview")}),r;{let o=null;return await B(async()=>{o=await se.app.createDocument({width:e,height:t,resolution:72,mode:se.constants.NewDocumentMode.RGB,fill:se.constants.DocumentFill.TRANSPARENT,name:C.getSpecialDocumentForPreview()})},{document:null,commandName:g("create document for preview")}),o}}var Cn=0;async function lo(e){Cn++;let t=e.image_blobs?.length?e.image_blobs:null,r=e.image_urls?.length?e.image_urls:null,o=e.document_identify,n=e.layer_identifies,i=(await Promise.all((r||t||[]).map(async(u,p)=>{if(r)return await mr.Jimp.read(r[p]);if(t){if("pngData"in t[p])return await mr.Jimp.read(await t[p].pngData.arrayBuffer());{let h=t[p].buffer,w=h instanceof Blob?await h.arrayBuffer():h;return new mr.Jimp({data:Buffer.from(w),width:t[p].width,height:t[p].height})}}}))).filter(u=>u),s=F(o);if(C.is_SPECIAL_LAYER_PREVIEW_DOCUMENT(o)&&(s=await Ts(i[0].bitmap.width,i[0].bitmap.height)),!s)throw new Error(g("document {0} not found",o));let a=s,c=i.map((u,p)=>{if(e.boundaries&&e.boundaries[p])return{width:e.boundaries[p].width,height:e.boundaries[p].height,top:e.boundaries[p].top,left:e.boundaries[p].left};let h=1;return(u.bitmap.height>a.height||u.bitmap.width>a.width)&&(h=Math.min(a.height/u.bitmap.height,a.width/u.bitmap.width)),{width:u.bitmap.width*h,height:u.bitmap.height*h,top:(a.height-u.bitmap.height*h)/2,left:(a.width-u.bitmap.width*h)/2,bottom:(a.height-u.bitmap.height*h)/2,right:(a.width-u.bitmap.width*h)/2}});i.forEach((u,p)=>{let h=c[p];if(u.bitmap.width!=h.width||u.bitmap.height!=h.height){let w={w:h.width,h:h.height};u.resize(w)}});let m=await Promise.all(i.map(async u=>{let p=u.bitmap.data;if(a.bitsPerChannel=="bitDepth16"){let w=new Uint16Array(p.length);for(let b=0;b<p.length;b+=4)w[b]=(p[b]<<7)+w[b],w[b+1]=(p[b+1]<<7)+w[b+1],w[b+2]=(p[b+2]<<7)+w[b+2],w[b+3]=p[b+3]<<7;p=w}else if(a.bitsPerChannel=="bitDepth32"){let h=new Float32Array(p.length);for(let w=0;w<p.length;w+=4)h[w]=p[w]/255,h[w+1]=p[w+1]/255,h[w+2]=p[w+2]/255,h[w+3]=p[w+3]/255;p=h}return await se.imaging.createImageDataFromBuffer(p,{width:u.bitmap.width,height:u.bitmap.height,components:4,colorProfile:"sRGB IEC61966-2.1",colorSpace:"RGB"})})),d=[],l=[];await B(async u=>{let p=null;l=await Promise.all(i.map(async(h,w)=>{let b=n.length==1?n[0]:n[w];if(!C.is_SPECIAL_LAYER_NEW_LAYER(b)){let y=ee(a,b);p=le(a,y)}if(p&&p.kind!=se.constants.LayerKind.GROUP)return p;{let y=e.new_layer_name||"SDPPP Images";typeof R.handleSendLayerName=="function"&&(y=await R.handleSendLayerName(y));let S=await a.createLayer(se.constants.LayerKind.NORMAL,{name:`${y} ${Cn}${i.length>1?`_${w+1}`:""}`});if(!S)throw new Error(g("create layer failed"));return d.push(S),p?S.move(p,se.constants.ElementPlacement.PLACEINSIDE):S.move(a.layers[0],se.constants.ElementPlacement.PLACEBEFORE),S}})),d.length&&u.add(h=>{h?d.forEach((w,b)=>{w.selected=!1}):d.forEach(w=>w.delete())}),await Promise.all(l.map(async(h,w)=>{await se.imaging.putPixels({documentID:a.id,layerID:h.id,replace:!1,imageData:m[w],targetBounds:c[w]})})),Re(l.map(h=>h.id)),rr()},{commandName:g("show sent images"),document:a});let f=H.getState();return{layers:l.map(u=>({identify:De(u.id,u.name),dirtyID:f.layerDirtyIDs.get(u.id)||0}))}}var In=N("photoshop");async function fo(e){let t=e.document_identify,r=F(t);if(!r)throw new Error(g("document {0} not found",t));let o=e.layer_identify,n=ee(r,o),i=le(r,n);if(!i||i.kind!=In.constants.LayerKind.TEXT)throw new Error(g('only layer kind "TEXT" is supported, invalid layer: {0}',o));let s=!1;return await B(async()=>{console.log(e.text),i.textItem.contents=e.text,s=!0},{document:r,commandName:g("set text to layer")}),{success:s}}function An(e){return class extends e{constructor(t){super(t),this.socket.on("B_photoshop",async(r,o)=>{let{action:n,params:i}=r,s;try{console.log("B_photoshop start",n);let a=Date.now();n==="psd"?s=await co(i):n==="getImage"?s=await lr(i):n==="sendImages"?s=await lo(i):n==="getSelection"?s=await Tt(i):n==="getText"?s=await ao(i):n==="sendText"?s=await fo(i):n==="getLayerInfo"?s=await xt(i):n==="getDocumentInfo"?s=await to(i):n==="getLinkedLayers"?s=await io(i):n==="getLayersInGroup"?s=await no(i):n==="runPhotoshopActionOnLayer"?s=await uo(i):n==="getSpecialIdentifierValue"&&(s=await so(i));let c=Date.now();console.log("B_photoshop end",n,c-a)}catch(a){console.error(a),o({error:a.stack||a.message||a});return}o(s)})}async callForPSDExtract(t,r){return new Promise((o,n)=>{this.socket.emit("F_photoshop",{action:"extractPSD",sid:t,params:{from_sid:r.from_sid}},i=>{if(i.error)return n(new Error(i.error));o(i)})})}async uploadImage(t,r){return new Promise((o,n)=>{this.socket.emit("F_photoshop",{action:"uploadImage",sid:t,params:r},i=>{if(i.error)return n(new Error(i.error));o(i)})})}}}function En(e){return class extends e{constructor(t){super(t),this.socket.on("B_workflow",(r,o)=>{if(r.action=="getStoredWidgetValue"){let{widgetTableID:n,widgetTablePath:i,widgetTablePersisted:s}=r.params,a=`${n}_${i}_${s}`,c=Rs(a),m=[];c&&Object.keys(c||{}).forEach(d=>{Object.keys(c[d]||{}).forEach(l=>{m.push({nodeID:d,widgetIndex:l,value:c[d][l].value,outputType:c[d][l].outputType})})}),o({values:m})}})}async setNodeTitle(t,r,o){await new Promise((n,i)=>{this.socket.emit("F_workflow",{action:"setNodeTitle",sid:t,params:{node_id:r,title:o}},s=>{if(s?.error)return i(new Error(s.error));n(s)})})}async pageInstanceRun(t,r,o=1){await new Promise((n,i)=>{this.socket.emit("F_workflow",{action:"run",sid:t,params:{size:o,from_sid:r}},s=>{if(s?.error)return i(new Error(s.error));n(s)})})}async setWidgetValue(t,r){t&&await new Promise((o,n)=>{this.socket.emit("F_workflow",{action:"setWidgetValue",sid:t.data.sid,params:r},i=>{if(i?.error)return n(new Error(i.error));o(i)})})}async openWorkflow(t,r){t&&await new Promise((o,n)=>{this.socket.emit("F_workflow",{action:"open",sid:t.data.sid,params:r},i=>{if(i?.error)return n(new Error(i.error));o(i)})})}async saveWorkflow(t,r){t&&await new Promise((o,n)=>{this.socket.emit("F_workflow",{action:"save",sid:t.data.sid,params:r},i=>{if(i?.error)return n(new Error(i.error));o(i)})})}async listWorkflows(t,r){return t?await new Promise((o,n)=>{this.socket.emit("F_workflow",{action:"list",sid:t.data.sid,params:r},i=>{o(i)})}):{workflows:[],error:"Workflow agent not found"}}async logout(t){t&&await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"logout",sid:t.data.sid},n=>{if(n?.error)return o(new Error(n.error));r(n)})})}async interrupt(t){await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"interrupt",sid:t},n=>{r(n)})})}async clearQueue(t){await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"clearQueue",sid:t},n=>{r(n)})})}async reboot(t){return await new Promise((r,o)=>{this.socket.emit("F_workflow",{action:"reboot",sid:t},n=>{r(n)})})}async setComfyOrgAPIKey(t,r){return await new Promise((o,n)=>{this.socket.emit("F_workflow",{action:"setComfyOrgAPIKey",sid:t,params:{api_key:r}},i=>{o(i)})})}}}function Rs(e){let t=localStorage.getItem(`widgetValue_${e}`);return t?JSON.parse(t):null}var hr=class extends pn(mn(D,"photoshop"),hn(O,"comfy"),En,An){constructor(t,{setConnectState:r,setLastErrorMessage:o,setBackendURL:n,setComfyMultiUser:i}){super(t);let s=()=>{this.socket.active&&this.socket.connected?r("connected"):this.socket.active?r("connecting"):r("disconnected"),requestAnimationFrame(s)};requestAnimationFrame(s),this.socket.on("connect_error",async a=>{if(this.socket.active){let c=a.message;try{let m=new AbortController,d=setTimeout(()=>m.abort(),1500),l=await fetch((t+this.socket._opts.path).replace(/(?<!:)\/\//g,"/"),{method:"GET",signal:m.signal});clearTimeout(d),l.status==502?c=g("502: Maybe the server is not running"):l.status==404?c=g("404: Maybe SDPPP is not installed or failed to run in ComfyUI"):c=`[${l.status}] ${c}`}catch(m){m.message=="Network request failed"&&(c=g("Timeout, Maybe the URL is wrong"))}o(g("{0}. reconnecting...",c))}else o(a.message)}),this.socket.on("sdppp_inited",a=>{n(t),a.multi_user&&i(a.multi_user)}),this.socket.on("disconnect",(...a)=>{i(!1),D.setComfyUserToken("")})}};var Ln=v(sr(),1),xn=v(P(),1),Ns=(0,Ln.debug)("sdppp:internal"),gr="http://127.0.0.1:8188",kn=(0,U.createContext)(null);function _n({children:e}){let{setSrc:t,webviewAgentSID:r,prevWebviewAgentSID:o}=J(),[n,i]=(0,U.useState)("disconnected"),[s,a]=(0,U.useState)(""),[c,m]=(0,U.useState)(localStorage.getItem("backendURL")||gr),[d,l]=(0,U.useState)(null),[f,u]=(0,U.useState)(""),[p,h]=(0,U.useState)(!1),[w,b]=(0,U.useState)(null),[y,S]=(0,U.useState)([]);function I(k){m(k.split("?")[0].split("#")[0].trim())}(0,U.useEffect)(()=>{localStorage.setItem("backendURL",c)},[c]),(0,U.useEffect)(()=>{if(n==="connected"){a(""),t(`${c}`);let k=!!(c.includes("localhost")||c.match(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/));Ns("setBackendURL:",c,"src:",k),D.setIsLocal(k)}else t(""),u("")},[n]);function $(){if(n==="connected"||n==="connecting")w&&(w.close(),b(null));else try{let k=w;w||(k=new hr(c||gr,{setConnectState:i,setLastErrorMessage:a,setBackendURL:I,setComfyMultiUser:h}),b(k)),k.connect()}catch(k){a(k.stack||k.message||k)}}(0,U.useEffect)(()=>{let k=(Q,Se,Gt)=>{f&&(!Se&&Q==f||!(f in O.getAllStore()))&&u("")};return O.subscribe("/",k),()=>{O.unsubscribe(k)}},[f]),(0,U.useEffect)(()=>{!f&&r&&u(r)},[f,r]),(0,U.useEffect)(()=>{r&&(!f||f==o)&&u(r)},[r,o,f,u]);let[ve,oe]=(0,U.useState)(null);return(0,U.useEffect)(()=>{oe(f?O.getAllStore()[f]:null)},[f]),(0,xn.jsx)(kn.Provider,{value:{socket:w,backendURL:c,setBackendURL:I,connectState:n,doConnectOrDisconnect:$,lastErrorMessage:s,setLastErrorMessage:a,autoRunning:d,setAutoRunning:l,comfyMultiUser:p,setComfyMultiUser:h,workflowAgent:ve,workflowAgentSID:f,setWorkflowAgentSID:u,beforeWorkflowRunHooks:y,setBeforeWorkflowRunHooks:S},children:e})}function A(){let e=(0,U.useContext)(kn);if(!e)throw new Error("useSDPPPInternalContext must be used within a SDPPPInternalContextProvider");return e}var Tn=v(E(),1);var Rn=v(P(),1),et=class extends Tn.default.Component{state={hasError:!1,errorMessage:""};constructor(t){super(t)}static getDerivedStateFromError(t){return{hasError:!0,errorMessage:t.toString()}}componentDidCatch(t,r){console.log(t,r)}render(){return this.state.hasError?(0,Rn.jsx)("p",{className:"list-error-label",children:g("Error {0}... please contact me via Discord/Github",this.state.errorMessage)}):this.props.children}};var Ne=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){return this.listeners.add(e),this.onSubscribe(),()=>{this.listeners.delete(e),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}};var Oe=typeof window>"u"||"Deno"in globalThis;function te(){}function Wn(e,t){return typeof e=="function"?e(t):e}function Mn(e){return typeof e=="number"&&e>=0&&e!==1/0}function Un(e,t){return Math.max(e+(t||0)-Date.now(),0)}function mo(e,t){return typeof e=="function"?e(t):e}function Fn(e,t){return typeof e=="function"?e(t):e}function ho(e,t){let{type:r="all",exact:o,fetchStatus:n,predicate:i,queryKey:s,stale:a}=e;if(s){if(o){if(t.queryHash!==Rt(s,t.options))return!1}else if(!pt(t.queryKey,s))return!1}if(r!=="all"){let c=t.isActive();if(r==="active"&&!c||r==="inactive"&&c)return!1}return!(typeof a=="boolean"&&t.isStale()!==a||n&&n!==t.state.fetchStatus||i&&!i(t))}function go(e,t){let{exact:r,status:o,predicate:n,mutationKey:i}=e;if(i){if(!t.options.mutationKey)return!1;if(r){if(ft(t.options.mutationKey)!==ft(i))return!1}else if(!pt(t.options.mutationKey,i))return!1}return!(o&&t.state.status!==o||n&&!n(t))}function Rt(e,t){return(t?.queryKeyHashFn||ft)(e)}function ft(e){return JSON.stringify(e,(t,r)=>po(r)?Object.keys(r).sort().reduce((o,n)=>(o[n]=r[n],o),{}):r)}function pt(e,t){return e===t?!0:typeof e!=typeof t?!1:e&&t&&typeof e=="object"&&typeof t=="object"?Object.keys(t).every(r=>pt(e[r],t[r])):!1}function Bn(e,t){if(e===t)return e;let r=Nn(e)&&Nn(t);if(r||po(e)&&po(t)){let o=r?e:Object.keys(e),n=o.length,i=r?t:Object.keys(t),s=i.length,a=r?[]:{},c=0;for(let m=0;m<s;m++){let d=r?m:i[m];(!r&&o.includes(d)||r)&&e[d]===void 0&&t[d]===void 0?(a[d]=void 0,c++):(a[d]=Bn(e[d],t[d]),a[d]===e[d]&&e[d]!==void 0&&c++)}return n===s&&c===n?e:a}return t}function Nn(e){return Array.isArray(e)&&e.length===Object.keys(e).length}function po(e){if(!On(e))return!1;let t=e.constructor;if(t===void 0)return!0;let r=t.prototype;return!(!On(r)||!r.hasOwnProperty("isPrototypeOf")||Object.getPrototypeOf(e)!==Object.prototype)}function On(e){return Object.prototype.toString.call(e)==="[object Object]"}function Vn(e){return new Promise(t=>{setTimeout(t,e)})}function Gn(e,t,r){return typeof r.structuralSharing=="function"?r.structuralSharing(e,t):r.structuralSharing!==!1?Bn(e,t):t}function Qn(e,t,r=0){let o=[...e,t];return r&&o.length>r?o.slice(1):o}function qn(e,t,r=0){let o=[t,...e];return r&&o.length>r?o.slice(0,-1):o}var Nt=Symbol();function yr(e,t){return!e.queryFn&&t?.initialPromise?()=>t.initialPromise:!e.queryFn||e.queryFn===Nt?()=>Promise.reject(new Error(`Missing queryFn: '${e.queryHash}'`)):e.queryFn}var Os=class extends Ne{#e;#t;#r;constructor(){super(),this.#r=e=>{if(!Oe&&window.addEventListener){let t=()=>e();return window.addEventListener("visibilitychange",t,!1),()=>{window.removeEventListener("visibilitychange",t)}}}}onSubscribe(){this.#t||this.setEventListener(this.#r)}onUnsubscribe(){this.hasListeners()||(this.#t?.(),this.#t=void 0)}setEventListener(e){this.#r=e,this.#t?.(),this.#t=e(t=>{typeof t=="boolean"?this.setFocused(t):this.onFocus()})}setFocused(e){this.#e!==e&&(this.#e=e,this.onFocus())}onFocus(){let e=this.isFocused();this.listeners.forEach(t=>{t(e)})}isFocused(){return typeof this.#e=="boolean"?this.#e:globalThis.document?.visibilityState!=="hidden"}},wr=new Os;var Ws=class extends Ne{#e=!0;#t;#r;constructor(){super(),this.#r=e=>{if(!Oe&&window.addEventListener){let t=()=>e(!0),r=()=>e(!1);return window.addEventListener("online",t,!1),window.addEventListener("offline",r,!1),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",r)}}}}onSubscribe(){this.#t||this.setEventListener(this.#r)}onUnsubscribe(){this.hasListeners()||(this.#t?.(),this.#t=void 0)}setEventListener(e){this.#r=e,this.#t?.(),this.#t=e(this.setOnline.bind(this))}setOnline(e){this.#e!==e&&(this.#e=e,this.listeners.forEach(r=>{r(e)}))}isOnline(){return this.#e}},mt=new Ws;function Kn(){let e,t,r=new Promise((n,i)=>{e=n,t=i});r.status="pending",r.catch(()=>{});function o(n){Object.assign(r,n),delete r.resolve,delete r.reject}return r.resolve=n=>{o({status:"fulfilled",value:n}),e(n)},r.reject=n=>{o({status:"rejected",reason:n}),t(n)},r}function Ms(e){return Math.min(1e3*2**e,3e4)}function yo(e){return(e??"online")==="online"?mt.isOnline():!0}var Hn=class extends Error{constructor(e){super("CancelledError"),this.revert=e?.revert,this.silent=e?.silent}};function vr(e){return e instanceof Hn}function br(e){let t=!1,r=0,o=!1,n,i=Kn(),s=h=>{o||(f(new Hn(h)),e.abort?.())},a=()=>{t=!0},c=()=>{t=!1},m=()=>wr.isFocused()&&(e.networkMode==="always"||mt.isOnline())&&e.canRun(),d=()=>yo(e.networkMode)&&e.canRun(),l=h=>{o||(o=!0,e.onSuccess?.(h),n?.(),i.resolve(h))},f=h=>{o||(o=!0,e.onError?.(h),n?.(),i.reject(h))},u=()=>new Promise(h=>{n=w=>{(o||m())&&h(w)},e.onPause?.()}).then(()=>{n=void 0,o||e.onContinue?.()}),p=()=>{if(o)return;let h,w=r===0?e.initialPromise:void 0;try{h=w??e.fn()}catch(b){h=Promise.reject(b)}Promise.resolve(h).then(l).catch(b=>{if(o)return;let y=e.retry??(Oe?0:3),S=e.retryDelay??Ms,I=typeof S=="function"?S(r,b):S,$=y===!0||typeof y=="number"&&r<y||typeof y=="function"&&y(r,b);if(t||!$){f(b);return}r++,e.onFail?.(r,b),Vn(I).then(()=>m()?void 0:u()).then(()=>{t?f(b):p()})})};return{promise:i,cancel:s,continue:()=>(n?.(),i),cancelRetry:a,continueRetry:c,canStart:d,start:()=>(d()?p():u().then(p),i)}}var Us=e=>setTimeout(e,0);function Fs(){let e=[],t=0,r=a=>{a()},o=a=>{a()},n=Us,i=a=>{t?e.push(a):n(()=>{r(a)})},s=()=>{let a=e;e=[],a.length&&n(()=>{o(()=>{a.forEach(c=>{r(c)})})})};return{batch:a=>{let c;t++;try{c=a()}finally{t--,t||s()}return c},batchCalls:a=>(...c)=>{i(()=>{a(...c)})},schedule:i,setNotifyFunction:a=>{r=a},setBatchNotifyFunction:a=>{o=a},setScheduler:a=>{n=a}}}var V=Fs();var Pr=class{#e;destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),Mn(this.gcTime)&&(this.#e=setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(e){this.gcTime=Math.max(this.gcTime||0,e??(Oe?1/0:5*60*1e3))}clearGcTimeout(){this.#e&&(clearTimeout(this.#e),this.#e=void 0)}};var Yn=class extends Pr{#e;#t;#r;#n;#o;#s;#a;constructor(e){super(),this.#a=!1,this.#s=e.defaultOptions,this.setOptions(e.options),this.observers=[],this.#n=e.client,this.#r=this.#n.getQueryCache(),this.queryKey=e.queryKey,this.queryHash=e.queryHash,this.#e=Vs(this.options),this.state=e.state??this.#e,this.scheduleGc()}get meta(){return this.options.meta}get promise(){return this.#o?.promise}setOptions(e){this.options={...this.#s,...e},this.updateGcTime(this.options.gcTime)}optionalRemove(){!this.observers.length&&this.state.fetchStatus==="idle"&&this.#r.remove(this)}setData(e,t){let r=Gn(this.state.data,e,this.options);return this.#i({data:r,type:"success",dataUpdatedAt:t?.updatedAt,manual:t?.manual}),r}setState(e,t){this.#i({type:"setState",state:e,setStateOptions:t})}cancel(e){let t=this.#o?.promise;return this.#o?.cancel(e),t?t.then(te).catch(te):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.#e)}isActive(){return this.observers.some(e=>Fn(e.options.enabled,this)!==!1)}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===Nt||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStale(){return this.state.isInvalidated?!0:this.getObserversCount()>0?this.observers.some(e=>e.getCurrentResult().isStale):this.state.data===void 0}isStaleByTime(e=0){return this.state.isInvalidated||this.state.data===void 0||!Un(this.state.dataUpdatedAt,e)}onFocus(){this.observers.find(t=>t.shouldFetchOnWindowFocus())?.refetch({cancelRefetch:!1}),this.#o?.continue()}onOnline(){this.observers.find(t=>t.shouldFetchOnReconnect())?.refetch({cancelRefetch:!1}),this.#o?.continue()}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.#r.notify({type:"observerAdded",query:this,observer:e}))}removeObserver(e){this.observers.includes(e)&&(this.observers=this.observers.filter(t=>t!==e),this.observers.length||(this.#o&&(this.#a?this.#o.cancel({revert:!0}):this.#o.cancelRetry()),this.scheduleGc()),this.#r.notify({type:"observerRemoved",query:this,observer:e}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.#i({type:"invalidate"})}fetch(e,t){if(this.state.fetchStatus!=="idle"){if(this.state.data!==void 0&&t?.cancelRefetch)this.cancel({silent:!0});else if(this.#o)return this.#o.continueRetry(),this.#o.promise}if(e&&this.setOptions(e),!this.options.queryFn){let a=this.observers.find(c=>c.options.queryFn);a&&this.setOptions(a.options)}let r=new AbortController,o=a=>{Object.defineProperty(a,"signal",{enumerable:!0,get:()=>(this.#a=!0,r.signal)})},n=()=>{let a=yr(this.options,t),c={client:this.#n,queryKey:this.queryKey,meta:this.meta};return o(c),this.#a=!1,this.options.persister?this.options.persister(a,c,this):a(c)},i={fetchOptions:t,options:this.options,queryKey:this.queryKey,client:this.#n,state:this.state,fetchFn:n};o(i),this.options.behavior?.onFetch(i,this),this.#t=this.state,(this.state.fetchStatus==="idle"||this.state.fetchMeta!==i.fetchOptions?.meta)&&this.#i({type:"fetch",meta:i.fetchOptions?.meta});let s=a=>{vr(a)&&a.silent||this.#i({type:"error",error:a}),vr(a)||(this.#r.config.onError?.(a,this),this.#r.config.onSettled?.(this.state.data,a,this)),this.scheduleGc()};return this.#o=br({initialPromise:t?.initialPromise,fn:i.fetchFn,abort:r.abort.bind(r),onSuccess:a=>{if(a===void 0){s(new Error(`${this.queryHash} data is undefined`));return}try{this.setData(a)}catch(c){s(c);return}this.#r.config.onSuccess?.(a,this),this.#r.config.onSettled?.(a,this.state.error,this),this.scheduleGc()},onError:s,onFail:(a,c)=>{this.#i({type:"failed",failureCount:a,error:c})},onPause:()=>{this.#i({type:"pause"})},onContinue:()=>{this.#i({type:"continue"})},retry:i.options.retry,retryDelay:i.options.retryDelay,networkMode:i.options.networkMode,canRun:()=>!0}),this.#o.start()}#i(e){let t=r=>{switch(e.type){case"failed":return{...r,fetchFailureCount:e.failureCount,fetchFailureReason:e.error};case"pause":return{...r,fetchStatus:"paused"};case"continue":return{...r,fetchStatus:"fetching"};case"fetch":return{...r,...Bs(r.data,this.options),fetchMeta:e.meta??null};case"success":return{...r,data:e.data,dataUpdateCount:r.dataUpdateCount+1,dataUpdatedAt:e.dataUpdatedAt??Date.now(),error:null,isInvalidated:!1,status:"success",...!e.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};case"error":let o=e.error;return vr(o)&&o.revert&&this.#t?{...this.#t,fetchStatus:"idle"}:{...r,error:o,errorUpdateCount:r.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:r.fetchFailureCount+1,fetchFailureReason:o,fetchStatus:"idle",status:"error"};case"invalidate":return{...r,isInvalidated:!0};case"setState":return{...r,...e.state}}};this.state=t(this.state),V.batch(()=>{this.observers.forEach(r=>{r.onQueryUpdate()}),this.#r.notify({query:this,type:"updated",action:e})})}};function Bs(e,t){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:yo(t.networkMode)?"fetching":"paused",...e===void 0&&{error:null,status:"pending"}}}function Vs(e){let t=typeof e.initialData=="function"?e.initialData():e.initialData,r=t!==void 0,o=r?typeof e.initialDataUpdatedAt=="function"?e.initialDataUpdatedAt():e.initialDataUpdatedAt:0;return{data:t,dataUpdateCount:0,dataUpdatedAt:r?o??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:r?"success":"pending",fetchStatus:"idle"}}var zn=class extends Ne{constructor(e={}){super(),this.config=e,this.#e=new Map}#e;build(e,t,r){let o=t.queryKey,n=t.queryHash??Rt(o,t),i=this.get(n);return i||(i=new Yn({client:e,queryKey:o,queryHash:n,options:e.defaultQueryOptions(t),state:r,defaultOptions:e.getQueryDefaults(o)}),this.add(i)),i}add(e){this.#e.has(e.queryHash)||(this.#e.set(e.queryHash,e),this.notify({type:"added",query:e}))}remove(e){let t=this.#e.get(e.queryHash);t&&(e.destroy(),t===e&&this.#e.delete(e.queryHash),this.notify({type:"removed",query:e}))}clear(){V.batch(()=>{this.getAll().forEach(e=>{this.remove(e)})})}get(e){return this.#e.get(e)}getAll(){return[...this.#e.values()]}find(e){let t={exact:!0,...e};return this.getAll().find(r=>ho(t,r))}findAll(e={}){let t=this.getAll();return Object.keys(e).length>0?t.filter(r=>ho(e,r)):t}notify(e){V.batch(()=>{this.listeners.forEach(t=>{t(e)})})}onFocus(){V.batch(()=>{this.getAll().forEach(e=>{e.onFocus()})})}onOnline(){V.batch(()=>{this.getAll().forEach(e=>{e.onOnline()})})}};var $n=class extends Pr{#e;#t;#r;constructor(e){super(),this.mutationId=e.mutationId,this.#t=e.mutationCache,this.#e=[],this.state=e.state||Gs(),this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options=e,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(e){this.#e.includes(e)||(this.#e.push(e),this.clearGcTimeout(),this.#t.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.#e=this.#e.filter(t=>t!==e),this.scheduleGc(),this.#t.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.#e.length||(this.state.status==="pending"?this.scheduleGc():this.#t.remove(this))}continue(){return this.#r?.continue()??this.execute(this.state.variables)}async execute(e){this.#r=br({fn:()=>this.options.mutationFn?this.options.mutationFn(e):Promise.reject(new Error("No mutationFn found")),onFail:(o,n)=>{this.#n({type:"failed",failureCount:o,error:n})},onPause:()=>{this.#n({type:"pause"})},onContinue:()=>{this.#n({type:"continue"})},retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#t.canRun(this)});let t=this.state.status==="pending",r=!this.#r.canStart();try{if(!t){this.#n({type:"pending",variables:e,isPaused:r}),await this.#t.config.onMutate?.(e,this);let n=await this.options.onMutate?.(e);n!==this.state.context&&this.#n({type:"pending",context:n,variables:e,isPaused:r})}let o=await this.#r.start();return await this.#t.config.onSuccess?.(o,e,this.state.context,this),await this.options.onSuccess?.(o,e,this.state.context),await this.#t.config.onSettled?.(o,null,this.state.variables,this.state.context,this),await this.options.onSettled?.(o,null,e,this.state.context),this.#n({type:"success",data:o}),o}catch(o){try{throw await this.#t.config.onError?.(o,e,this.state.context,this),await this.options.onError?.(o,e,this.state.context),await this.#t.config.onSettled?.(void 0,o,this.state.variables,this.state.context,this),await this.options.onSettled?.(void 0,o,e,this.state.context),o}finally{this.#n({type:"error",error:o})}}finally{this.#t.runNext(this)}}#n(e){let t=r=>{switch(e.type){case"failed":return{...r,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...r,isPaused:!0};case"continue":return{...r,isPaused:!1};case"pending":return{...r,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:e.isPaused,status:"pending",variables:e.variables,submittedAt:Date.now()};case"success":return{...r,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...r,data:void 0,error:e.error,failureCount:r.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"}}};this.state=t(this.state),V.batch(()=>{this.#e.forEach(r=>{r.onMutationUpdate(e)}),this.#t.notify({mutation:this,type:"updated",action:e})})}};function Gs(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}var Jn=class extends Ne{constructor(e={}){super(),this.config=e,this.#e=new Set,this.#t=new Map,this.#r=0}#e;#t;#r;build(e,t,r){let o=new $n({mutationCache:this,mutationId:++this.#r,options:e.defaultMutationOptions(t),state:r});return this.add(o),o}add(e){this.#e.add(e);let t=Sr(e);if(typeof t=="string"){let r=this.#t.get(t);r?r.push(e):this.#t.set(t,[e])}this.notify({type:"added",mutation:e})}remove(e){if(this.#e.delete(e)){let t=Sr(e);if(typeof t=="string"){let r=this.#t.get(t);if(r)if(r.length>1){let o=r.indexOf(e);o!==-1&&r.splice(o,1)}else r[0]===e&&this.#t.delete(t)}}this.notify({type:"removed",mutation:e})}canRun(e){let t=Sr(e);if(typeof t=="string"){let o=this.#t.get(t)?.find(n=>n.state.status==="pending");return!o||o===e}else return!0}runNext(e){let t=Sr(e);return typeof t=="string"?this.#t.get(t)?.find(o=>o!==e&&o.state.isPaused)?.continue()??Promise.resolve():Promise.resolve()}clear(){V.batch(()=>{this.#e.forEach(e=>{this.notify({type:"removed",mutation:e})}),this.#e.clear(),this.#t.clear()})}getAll(){return Array.from(this.#e)}find(e){let t={exact:!0,...e};return this.getAll().find(r=>go(t,r))}findAll(e={}){return this.getAll().filter(t=>go(e,t))}notify(e){V.batch(()=>{this.listeners.forEach(t=>{t(e)})})}resumePausedMutations(){let e=this.getAll().filter(t=>t.state.isPaused);return V.batch(()=>Promise.all(e.map(t=>t.continue().catch(te))))}};function Sr(e){return e.options.scope?.id}function wo(e){return{onFetch:(t,r)=>{let o=t.options,n=t.fetchOptions?.meta?.fetchMore?.direction,i=t.state.data?.pages||[],s=t.state.data?.pageParams||[],a={pages:[],pageParams:[]},c=0,m=async()=>{let d=!1,l=p=>{Object.defineProperty(p,"signal",{enumerable:!0,get:()=>(t.signal.aborted?d=!0:t.signal.addEventListener("abort",()=>{d=!0}),t.signal)})},f=yr(t.options,t.fetchOptions),u=async(p,h,w)=>{if(d)return Promise.reject();if(h==null&&p.pages.length)return Promise.resolve(p);let b={client:t.client,queryKey:t.queryKey,pageParam:h,direction:w?"backward":"forward",meta:t.options.meta};l(b);let y=await f(b),{maxPages:S}=t.options,I=w?qn:Qn;return{pages:I(p.pages,y,S),pageParams:I(p.pageParams,h,S)}};if(n&&i.length){let p=n==="backward",h=p?Qs:jn,w={pages:i,pageParams:s},b=h(o,w);a=await u(w,b,p)}else{let p=e??i.length;do{let h=c===0?s[0]??o.initialPageParam:jn(o,a);if(c>0&&h==null)break;a=await u(a,h),c++}while(c<p)}return a};t.options.persister?t.fetchFn=()=>t.options.persister?.(m,{client:t.client,queryKey:t.queryKey,meta:t.options.meta,signal:t.signal},r):t.fetchFn=m}}}function jn(e,{pages:t,pageParams:r}){let o=t.length-1;return t.length>0?e.getNextPageParam(t[o],t,r[o],r):void 0}function Qs(e,{pages:t,pageParams:r}){return t.length>0?e.getPreviousPageParam?.(t[0],t,r[0],r):void 0}var vo=class{#e;#t;#r;#n;#o;#s;#a;#i;constructor(e={}){this.#e=e.queryCache||new zn,this.#t=e.mutationCache||new Jn,this.#r=e.defaultOptions||{},this.#n=new Map,this.#o=new Map,this.#s=0}mount(){this.#s++,this.#s===1&&(this.#a=wr.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#e.onFocus())}),this.#i=mt.subscribe(async e=>{e&&(await this.resumePausedMutations(),this.#e.onOnline())}))}unmount(){this.#s--,this.#s===0&&(this.#a?.(),this.#a=void 0,this.#i?.(),this.#i=void 0)}isFetching(e){return this.#e.findAll({...e,fetchStatus:"fetching"}).length}isMutating(e){return this.#t.findAll({...e,status:"pending"}).length}getQueryData(e){let t=this.defaultQueryOptions({queryKey:e});return this.#e.get(t.queryHash)?.state.data}ensureQueryData(e){let t=this.defaultQueryOptions(e),r=this.#e.build(this,t),o=r.state.data;return o===void 0?this.fetchQuery(e):(e.revalidateIfStale&&r.isStaleByTime(mo(t.staleTime,r))&&this.prefetchQuery(t),Promise.resolve(o))}getQueriesData(e){return this.#e.findAll(e).map(({queryKey:t,state:r})=>{let o=r.data;return[t,o]})}setQueryData(e,t,r){let o=this.defaultQueryOptions({queryKey:e}),i=this.#e.get(o.queryHash)?.state.data,s=Wn(t,i);if(s!==void 0)return this.#e.build(this,o).setData(s,{...r,manual:!0})}setQueriesData(e,t,r){return V.batch(()=>this.#e.findAll(e).map(({queryKey:o})=>[o,this.setQueryData(o,t,r)]))}getQueryState(e){let t=this.defaultQueryOptions({queryKey:e});return this.#e.get(t.queryHash)?.state}removeQueries(e){let t=this.#e;V.batch(()=>{t.findAll(e).forEach(r=>{t.remove(r)})})}resetQueries(e,t){let r=this.#e;return V.batch(()=>(r.findAll(e).forEach(o=>{o.reset()}),this.refetchQueries({type:"active",...e},t)))}cancelQueries(e,t={}){let r={revert:!0,...t},o=V.batch(()=>this.#e.findAll(e).map(n=>n.cancel(r)));return Promise.all(o).then(te).catch(te)}invalidateQueries(e,t={}){return V.batch(()=>(this.#e.findAll(e).forEach(r=>{r.invalidate()}),e?.refetchType==="none"?Promise.resolve():this.refetchQueries({...e,type:e?.refetchType??e?.type??"active"},t)))}refetchQueries(e,t={}){let r={...t,cancelRefetch:t.cancelRefetch??!0},o=V.batch(()=>this.#e.findAll(e).filter(n=>!n.isDisabled()).map(n=>{let i=n.fetch(void 0,r);return r.throwOnError||(i=i.catch(te)),n.state.fetchStatus==="paused"?Promise.resolve():i}));return Promise.all(o).then(te)}fetchQuery(e){let t=this.defaultQueryOptions(e);t.retry===void 0&&(t.retry=!1);let r=this.#e.build(this,t);return r.isStaleByTime(mo(t.staleTime,r))?r.fetch(t):Promise.resolve(r.state.data)}prefetchQuery(e){return this.fetchQuery(e).then(te).catch(te)}fetchInfiniteQuery(e){return e.behavior=wo(e.pages),this.fetchQuery(e)}prefetchInfiniteQuery(e){return this.fetchInfiniteQuery(e).then(te).catch(te)}ensureInfiniteQueryData(e){return e.behavior=wo(e.pages),this.ensureQueryData(e)}resumePausedMutations(){return mt.isOnline()?this.#t.resumePausedMutations():Promise.resolve()}getQueryCache(){return this.#e}getMutationCache(){return this.#t}getDefaultOptions(){return this.#r}setDefaultOptions(e){this.#r=e}setQueryDefaults(e,t){this.#n.set(ft(e),{queryKey:e,defaultOptions:t})}getQueryDefaults(e){let t=[...this.#n.values()],r={};return t.forEach(o=>{pt(e,o.queryKey)&&Object.assign(r,o.defaultOptions)}),r}setMutationDefaults(e,t){this.#o.set(ft(e),{mutationKey:e,defaultOptions:t})}getMutationDefaults(e){let t=[...this.#o.values()],r={};return t.forEach(o=>{pt(e,o.mutationKey)&&Object.assign(r,o.defaultOptions)}),r}defaultQueryOptions(e){if(e._defaulted)return e;let t={...this.#r.queries,...this.getQueryDefaults(e.queryKey),...e,_defaulted:!0};return t.queryHash||(t.queryHash=Rt(t.queryKey,t)),t.refetchOnReconnect===void 0&&(t.refetchOnReconnect=t.networkMode!=="always"),t.throwOnError===void 0&&(t.throwOnError=!!t.suspense),!t.networkMode&&t.persister&&(t.networkMode="offlineFirst"),t.queryFn===Nt&&(t.enabled=!1),t}defaultMutationOptions(e){return e?._defaulted?e:{...this.#r.mutations,...e?.mutationKey&&this.getMutationDefaults(e.mutationKey),...e,_defaulted:!0}}clear(){this.#e.clear(),this.#t.clear()}};var Ot=v(E(),1),Xn=v(P(),1),Zn=Ot.createContext(void 0);var bo=({client:e,children:t})=>(Ot.useEffect(()=>(e.mount(),()=>{e.unmount()}),[e]),(0,Xn.jsx)(Zn.Provider,{value:e,children:t}));var Me=v(E(),1);var j=v(E(),1);var Dr=v(E(),1);function ei(){let{workflowAgent:e,socket:t}=A();return{setWidgetValue:(0,Dr.useCallback)(async(o,n,i)=>{if(!e)throw new Error("workflowAgent not found");await t?.setWidgetValue(e,{values:[{nodeID:o,widgetIndex:n,value:i}]});let s=e.data.widgetTableStructure.widgetTableID,a=e.data.widgetTableStructure.widgetTablePath,c=e.data.widgetTableStructure.widgetTablePersisted,m=`${s}_${a}_${c}`,d=e.data.widgetTableStructure.nodes[o].widgets[n].outputType;qs(m,o,n,i,d)},[e,t])}}function ht(){let{beforeWorkflowRunHooks:e,setBeforeWorkflowRunHooks:t}=A(),r=(0,Dr.useCallback)(n=>(t(i=>[...i,n]),()=>{t(i=>i.filter(a=>a!==n))}),[t]),o=(0,Dr.useCallback)(async()=>{for(let n=0;n<e.length;n++)await e[n]()},[e]);return{addBeforeWorkflowRunHook:r,triggerBeforeWorkflowRun:o}}function qs(e,t,r,o,n){let i=localStorage.getItem(`widgetValue_${e}`),s=i?JSON.parse(i):{};s[t]=s[t]||[],s[t][r]={value:o,outputType:n},localStorage.setItem(`widgetValue_${e}`,JSON.stringify(s))}var Po=N("photoshop");function re(){let{socket:e}=A(),{workflowAgentSID:t}=We(),{triggerBeforeWorkflowRun:r}=ht(),o=(0,j.useCallback)(async b=>{await e?.setComfyOrgAPIKey(t,b)},[e,t]),n=(0,j.useCallback)(async(b,y)=>{let S=O.getStore(b);if(!S)throw new Error("workflowAgent not found");try{await e?.openWorkflow(S,{workflow_path:y,sdpppID:R.sdpppID,sdpppToken:localStorage.getItem("token")||"",from_sid:D.data.sid,reset:!0})}catch(I){console.error(I)}},[e]),i=(0,j.useCallback)(async b=>{let y=O.getStore(b);if(!y||!y.data.widgetTableStructure.widgetTablePath)throw new Error("workflow not found");if(!y.data.widgetTableStructure.widgetTablePersisted)throw new Error("workflow is not savable");await n(b,y.data.widgetTableStructure.widgetTablePath)},[n]),s=(0,j.useCallback)((b,y=1)=>{e?.pageInstanceRun(b,D.data.sid,y)},[e]),a=(0,j.useCallback)(async b=>{let y=O.getStore(b);if(!y)throw new Error("workflowAgent not found");if(!y.data.widgetTableStructure.widgetTablePath)throw new Error("workflow not found");y.data.widgetTableStructure.widgetTablePath.indexOf("://")===-1&&await e?.saveWorkflow(y,{workflow_path:y.data.widgetTableStructure.widgetTablePath,from_sid:D.data.sid})},[e]),c=(0,j.useCallback)(async b=>{await e?.callForPSDExtract(b,{from_sid:D.data.sid})},[e]),m=(0,j.useCallback)(async b=>{let y=O.getStore(b);if(!y)throw new Error("workflowAgent not found");await e?.logout(y)},[e]),d=(0,j.useCallback)(async(b,y)=>await e?.uploadImage(D.data.sid,{image:b,filename:y,overwrite:!0}),[e]);globalThis.sdppp_action_run=async(b,{workflowPath:y})=>{y?u(y):f()};let l=(0,j.useCallback)(async(b,y=1)=>{!b&&!t||(await r(),await s(b||t,y))},[s,t,r]),f=(0,j.useCallback)(async(b,y=1)=>{await l(b||t,y),Po.action.recordAction?.({name:"sdppp_run",methodName:"sdppp_action_run"},{})},[l]),u=(0,j.useCallback)(async(b,y,S=1)=>{!y&&!t||(await n(y||t,b),l(y||t,S),Po.action.recordAction?.({name:"sdppp_run_"+b,methodName:"sdppp_action_run"},{workflowPath:b}))},[n,f,t]),p=(0,j.useCallback)(async()=>{t&&await e?.interrupt(t)},[e,t]),h=(0,j.useCallback)(async()=>{t&&await e?.clearQueue(t)},[e,t]),w=(0,j.useCallback)(async()=>{if(t)return await e?.reboot(t)},[e,t]);return{openWorkflow:n,reopenWorkflow:i,saveWorkflow:a,runPage:f,runWorkflow:u,callForPSDExtract:c,logout:m,uploadImage:d,interrupt:p,clearQueue:h,reboot:w,setComfyOrgAPIKey:o}}function Cr(){let[e,t]=(0,Me.useState)(!1),[r,o]=(0,Me.useState)(!1),n=(0,Me.useRef)(null),{autoRunning:i,workflowAgent:s}=A(),{runWorkflow:a,runPage:c}=re();return(0,Me.useEffect)(()=>{if(i&&e&&!r){if(t(!1),i.type=="workflow")s&&!s.data.executingNodeTitle&&(a(i.value,s.data.sid,1),n.current=setTimeout(()=>{o(!1)},1e3));else if(i.type=="page"){let m=O.getStore(i.value);m&&!m.data.executingNodeTitle&&(o(!0),c(i.value),n.current=setTimeout(()=>{o(!1)},1e3))}}},[e,r,i,s,a,c]),(0,Me.useEffect)(()=>()=>{n.current&&clearTimeout(n.current)},[]),{setShouldTriggerLivePainting:t}}var pe=v(E(),1);var oi=v(P(),1),Ks=15e3,ti=(0,pe.createContext)({});function ri({children:e,loginStyle:t,loginBannerTop:r,loginBannerBottom:o}){let[n,i]=(0,pe.useState)(!R.sdpppID),[s,a]=(0,pe.useState)(!1),c=(0,pe.useCallback)(async(f,u="sdppp123456")=>{try{let p=await fetch("https://sdppp.zombee.tech/api/authing/api/v3/signin",{method:"POST",headers:{"x-authing-sdk-version":"web:3.0.0","Content-Type":"application/json","x-sdppp-appid":R.sdpppID},body:JSON.stringify({connection:"PASSWORD",passwordPayload:{username:f,password:u}})}),h=await p.json();if(p.ok){if(h.statusCode===200)return{success:!0,token:h.data.access_token};if(h.statusCode===403)return{success:!1,message:g("Verification Error")}}else return{success:!1,message:JSON.stringify(h)}}catch(p){return{success:!1,message:p.toString()}}return{success:!1,message:"\u767B\u5F55\u5931\u8D25"}},[]),m=(0,pe.useCallback)(async f=>{try{let p=await(await fetch("https://sdppp.zombee.tech/api/authing/api/v3/get-profile",{method:"GET",headers:{Authorization:`Bearer ${f}`,"x-sdppp-appid":R.sdpppID}})).json();return p.statusCode===200?{data:p.data,success:!0}:{message:p.message,success:!1}}catch(u){return{success:!1,message:u}}},[]);async function d(f,u="sdppp123456"){let p=await c(f,u);if(p.success){let h=await m(p.token);h.success&&(localStorage.setItem("token",p.token),localStorage.setItem("lastLogin",new Date(h.data.lastLogin).getTime().toString()),i(!0))}return p}async function l(f){if(!localStorage.getItem("lastLogin"))return!1;let u=await m(f);if(u.success){let p=new Date(u.data.lastLogin).getTime().toString(),h=localStorage.getItem("lastLogin");return p===h}else return!1}return(0,pe.useEffect)(()=>{if(n){if(R.sdpppID){let f=setInterval(()=>{let u=localStorage.getItem("token");u&&l(u).then(p=>{p||i(!1)})},Ks);return()=>{clearInterval(f)}}}else{let f=localStorage.getItem("token");if(!f)return;l(f).then(u=>{u&&i(!0)})}},[n]),(0,oi.jsx)(ti.Provider,{value:{hasAuthingLogin:!!R.sdpppID,loginStyle:t||"none",loginBannerBottom:o||null,loginBannerTop:r||null,isLogin:n,loggedInUsername:n&&localStorage.getItem("last-username")||"",logout:()=>{localStorage.removeItem("token"),i(!1),a(!1)},login:d,setIsTrialing:a,isTrialing:s},children:e})}function me(){let e=(0,pe.useContext)(ti);if(!e)throw new Error("useSDPPPLogin must be used within a SDPPPLoginProvider");return e}var Ue=v(P(),1),ni=(0,gt.createContext)({});function ii({children:e,loginAppID:t,loginStyle:r,loginBannerTop:o,loginBannerBottom:n}){let i=new vo;return(0,Ue.jsx)(bo,{client:i,children:(0,Ue.jsx)(et,{children:(0,Ue.jsx)(sn,{children:(0,Ue.jsx)(ri,{loginAppID:t,loginStyle:r,loginBannerTop:o,loginBannerBottom:n,children:(0,Ue.jsx)(_n,{children:(0,Ue.jsx)(Hs,{children:e})})})})})})}function We(){let e=(0,gt.useContext)(ni);if(!e)throw new Error("SDPPPExternalContext not found");return e}function Hs({children:e}){let t=J(),r=A(),{logout:o,isLogin:n}=me();R.registerTestCase&&(globalThis.sdppp_debugPhotoshopInternalContext=r,globalThis.sdppp_debugPhotoshopWebviewContext=t);let{toggleWebviewDialog:i,webviewAgentSID:s}=t,{autoRunning:a,setAutoRunning:c,workflowAgent:m,setWorkflowAgentSID:d,doConnectOrDisconnect:l,lastErrorMessage:f}=r,{setShouldTriggerLivePainting:u}=Cr();return(0,gt.useEffect)(()=>{let p=()=>{u(!0)};return D.subscribe("/canvasStateID",p),()=>{D.unsubscribe(p)}},[u]),(0,Ue.jsx)(ni.Provider,{value:{logout:o,isLogin:n,connectOrDisconnect:l,lastConnectErrorMessage:f,setAutoRunning:c,autoRunning:a,photoshopSID:D.data.sid,webviewAgentSID:s,workflowAgentSID:m?.data.sid||"",setWorkflowAgentSID:d,toggleWebviewDialog:i},children:e})}var Ir=v(E(),1);var yt=v(E(),1);function he(e,t){let[r,o]=(0,yt.useState)(e?{...e.data}:null),[n,i]=(0,yt.useState)(e?{...e.data}:null),s=Array.isArray(t)?t:[t];return(0,yt.useEffect)(()=>{e&&o({...e.data})},[e]),(0,yt.useEffect)(()=>{if(!e)return;let a=s.map(c=>{let m=()=>{i(r),o(e.data)};return e.subscribe(c,m),m});return()=>{a.forEach(c=>{e.unsubscribe(c)})}},[e,t]),{state:r||null,prevState:n||null}}function Ar(){let[e,t]=(0,Ir.useState)({}),{state:r}=he(D,"/comfyUserToken"),o=r?.comfyUserToken;return(0,Ir.useEffect)(()=>{let n=!1,i=(s,a,c)=>{n||t(m=>{let d={...m};return a==null?delete d[s]:d[s]=a,d})};return O.subscribe("/",i),()=>{n=!0,O.unsubscribe(i)}},[]),{pageInstances:Object.entries(e).map(([n,i])=>({sid:n,ssid:n.slice(0,4),title:i.title,lastError:i.lastError,isWebview:!!i.webviewFromSid,isCurrentUser:!i.comfyUserToken||i.comfyUserToken==o})).filter(n=>!n.isWebview&&(!o||n.isCurrentUser))}}var ge=v(E(),1);function Ys(e){let{state:t}=he(D,["/comfyUserToken"]),{socket:r,workflowAgentSID:o}=A(),[n,i]=(0,ge.useState)({}),[s,a]=(0,ge.useState)(!1),[c,m]=(0,ge.useState)(null),d=(0,ge.useCallback)(async l=>{if(!l&&!o){i({});return}a(!0);let f=O.getStore(l||o);try{let u=await r?.listWorkflows(f||null,{listMode:R.listMode,sdpppID:R.sdpppID,sdpppToken:localStorage.getItem("token")||""})||{workflows:[],error:"Empty workflow list"};if(u.error){m(new Error(u.error)),a(!1);return}a(!1),m(null),i(u.workflows.reduce((p,h)=>(p[h]={path:h,content:null,error:""},p),{}))}catch(u){a(!1),m(u)}},[r,o]);return(0,ge.useEffect)(()=>{e&&d()},[e]),(0,ge.useEffect)(()=>{t?.comfyUserToken&&d()},[t]),{data:n,isLoading:s,error:c,refetch:d}}function si(){let{backendURL:e,comfyMultiUser:t}=A(),{workflowAgentSID:r}=We(),[o,n]=(0,ge.useState)(!0),[i,s]=(0,ge.useState)(""),{data:a,isLoading:c,error:m,refetch:d}=Ys(e);(0,ge.useEffect)(()=>{if(r)d(),n(!1);else{n(!0);let u=setTimeout(()=>{n(!1)},4e3);return()=>clearTimeout(u)}},[r]);let l=[];if(!c&&!m&&a){let u=[],p=[];Object.keys(a).forEach(h=>{if(h.startsWith(i)){let w=h.slice(i.length).split("://").pop();w&&(w.indexOf("/")==-1?u.push(h):p.push(h.slice(0,h.lastIndexOf("/")+1)))}}),l=[...p.sort((h,w)=>h.localeCompare(w)).map(h=>({path:h,isDir:!0})),...u.map(h=>({path:h,isDir:!1}))].filter((h,w,b)=>b.findIndex(y=>y.path==h.path)===w)}let f="";return m&&(f=m.message),l.length||(f=g("Workflow list is empty, please save a workflow by Comfy's lastest UI")),m&&(f=g("Workflow list loading failed: {0}",m.message)),c&&(f="Loading"),r||(f=g("Workflow Runner is loading...")),{workflows:a,isLoadingWorkflows:c,workflowsError:f,refetchWorkflows:d,afterPropsUpdate4s:o,currentViewingDirectory:i,setCurrentViewingDirectory:s,showingList:l}}function Er(e){let t=e?O.getStore(e):null,{state:r}=he(t||null,["/"]);return!r||!e?{sid:"",ssid:"",title:"",lastError:"",isWebview:!1,progress:0,executingNodeTitle:"",queueSize:0}:{sid:e,ssid:r.ssid,title:r.title,lastError:r.lastError,isWebview:!!r.webviewFromSid,progress:r.progress,executingNodeTitle:r.executingNodeTitle,queueSize:r.queueSize}}var Fe=v(E(),1);var ai={zh:`
    <style>
        #sdppp-about {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 14px;
            color: var(--uxp-host-text-color);
            word-break: break-word;
            white-space: normal;
        }
        #sdppp-about a {
            color: var(--uxp-host-text-color);
            text-align: center;
            word-break: break-word;
            white-space: normal;
            text-decoration: underline;
            margin: 0 0.5em;
        }
        #sdppp-about h2 {
            font-size: 24px;
            margin: 0.5em 0;
            color: var(--uxp-host-text-color);
            text-align: center;
            word-break: break-word;
            white-space: normal;
        }
        #sdppp-about div {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            text-align: center; 
            margin-bottom: 0.5em;
            word-break: break-word;
            white-space: normal;
        }
    </style>
    <div id="sdppp-about">
        <div>
            <a href="https://github.com/sd-ppp/monorepo/blob/master/LICENSE.md">\u8BB8\u53EF\u8BC1: GPL-3.0</a>
        </div>
        <sp-divider></sp-divider>
        <h2>\u8D5E\u52A9\u8005</h2>
        <div>
            
                <a href="https://v.douyin.com/cw4ba7Vn5-w/" key="\u82BD\u9EA6AI&\u5218\u9510">\u82BD\u9EA6AI&\u5218\u9510</a>
            
                <a href="https://v.douyin.com/eF9nVQdbBCs/" key="\u98CE\u66B4AI">\u98CE\u66B4AI</a>
            
                <a href="https://v.douyin.com/hD2X7S717uw/" key="\u56DB\u559CAI">\u56DB\u559CAI</a>
            
                <a href="https://v.douyin.com/Jssc9ysKic4/" key="\u7075\u7ED8AI">\u7075\u7ED8AI</a>
            
                <a href="https://v.douyin.com/hbtnVQ2A9G4/" key="AIX">AIX</a>
            
                <a href="https://v.douyin.com/xZR_LKxE_z4/" key="\u662D\u73BA\u6587\u5316">\u662D\u73BA\u6587\u5316</a>
            
                <a href="https://v.douyin.com/k6yKDEcVgP8/" key="\u6C90\u6C90AI">\u6C90\u6C90AI</a>
            
                <a href="https://v.douyin.com/55KuUbZVGCM/" key="\u68A8\u68A8AI">\u68A8\u68A8AI</a>
            
                <a href="https://www.starfusion.cn/" key="\u661F\u6C47\u672A\u6765">\u661F\u6C47\u672A\u6765</a>
            
                <a href="https://v.douyin.com/dOlouy4GIo0/" key="\u8001\u8881AIGC">\u8001\u8881AIGC</a>
            
                <a href="https://space.bilibili.com/44908313" key="B\u7AD9\u5145\u7535\u7684\u5C0F\u4F19\u4F34\u4EEC">B\u7AD9\u5145\u7535\u7684\u5C0F\u4F19\u4F34\u4EEC</a>
            
        </div>
        <sp-divider></sp-divider>
        <h2>\u53CB\u60C5\u94FE\u63A5</h2>
        <div>
            
                <a href="https://www.xiaohongshu.com/user/profile/59f1fcc411be101aba7f048f" key="\u732B\u54AA\u8001\u5E08Reimagined">\u732B\u54AA\u8001\u5E08Reimagined</a>
            
                <a href="https://space.bilibili.com/590784254" key="\u6765\u771F\u7684">\u6765\u771F\u7684</a>
            
                <a href="https://space.bilibili.com/284721975" key="\u54D1\u72D7Egao">\u54D1\u72D7Egao</a>
            
        </div>
        <sp-divider></sp-divider>
        <h2>SD-PPP \u793E\u533A</h2>
        <div>
            
                <a href="https://github.com/zombieyang/sd-ppp" key="Github">Github</a>
            
                <a href="https://pd.qq.com/s/5m42umo28" key="QQ\u9891\u9053">QQ\u9891\u9053</a>
            
                <a href="https://space.bilibili.com/44908313" key="Bilibili">Bilibili</a>
            
        </div>
        <sp-divider></sp-divider>
        
            <h2>
                <a href="https://sdppp.zombee.tech/">>> SD-PPP \u5B98\u65B9\u7AD9</a>
            </h2>
        
    </div>
    `,en:`
    <style>
        #sdppp-about {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 14px;
            color: var(--uxp-host-text-color);
            word-break: break-word;
            white-space: normal;
        }
        #sdppp-about a {
            color: var(--uxp-host-text-color);
            text-align: center;
            word-break: break-word;
            white-space: normal;
            text-decoration: underline;
            margin: 0 0.5em;
        }
        #sdppp-about h2 {
            font-size: 24px;
            margin: 0.5em 0;
            color: var(--uxp-host-text-color);
            text-align: center;
            word-break: break-word;
            white-space: normal;
        }
        #sdppp-about div {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            text-align: center; 
            margin-bottom: 0.5em;
            word-break: break-word;
            white-space: normal;
        }
    </style>
    <div id="sdppp-about">
        <div>
            <a href="https://github.com/sd-ppp/monorepo/blob/master/LICENSE.md">LICENSE: GPL-3.0</a>
        </div>
        <sp-divider></sp-divider>
        <h2>Sponsors</h2>
        <div>
            
                <a href="https://v.douyin.com/cw4ba7Vn5-w/" key="\u82BD\u9EA6AI&\u5218\u9510">\u82BD\u9EA6AI&\u5218\u9510</a>
            
                <a href="https://v.douyin.com/eF9nVQdbBCs/" key="\u98CE\u66B4AI">\u98CE\u66B4AI</a>
            
                <a href="https://v.douyin.com/hD2X7S717uw/" key="\u56DB\u559CAI">\u56DB\u559CAI</a>
            
                <a href="https://v.douyin.com/Jssc9ysKic4/" key="\u7075\u7ED8AI">\u7075\u7ED8AI</a>
            
                <a href="https://v.douyin.com/hbtnVQ2A9G4/" key="AIX">AIX</a>
            
                <a href="https://v.douyin.com/xZR_LKxE_z4/" key="\u662D\u73BA\u6587\u5316">\u662D\u73BA\u6587\u5316</a>
            
                <a href="https://v.douyin.com/k6yKDEcVgP8/" key="\u6C90\u6C90AI">\u6C90\u6C90AI</a>
            
                <a href="https://v.douyin.com/55KuUbZVGCM/" key="\u68A8\u68A8AI">\u68A8\u68A8AI</a>
            
                <a href="https://www.starfusion.cn/" key="\u661F\u6C47\u672A\u6765">\u661F\u6C47\u672A\u6765</a>
            
                <a href="https://v.douyin.com/dOlouy4GIo0/" key="\u8001\u8881AIGC">\u8001\u8881AIGC</a>
            
                <a href="https://space.bilibili.com/44908313" key="B\u7AD9\u5145\u7535\u7684\u5C0F\u4F19\u4F34\u4EEC">B\u7AD9\u5145\u7535\u7684\u5C0F\u4F19\u4F34\u4EEC</a>
            
        </div>
        <sp-divider></sp-divider>
        <h2>Links</h2>
        <div>
            
                <a href="https://www.xiaohongshu.com/user/profile/59f1fcc411be101aba7f048f" key="\u732B\u54AA\u8001\u5E08Reimagined">\u732B\u54AA\u8001\u5E08Reimagined</a>
            
                <a href="https://space.bilibili.com/590784254" key="\u6765\u771F\u7684">\u6765\u771F\u7684</a>
            
                <a href="https://space.bilibili.com/284721975" key="\u54D1\u72D7Egao">\u54D1\u72D7Egao</a>
            
        </div>
        <sp-divider></sp-divider>
        <h2>SD-PPP Community</h2>
        <div>
            
                <a href="https://github.com/zombieyang/sd-ppp" key="Github">Github</a>
            
                <a href="https://discord.gg/9HeGjDvEmn" key="Discord">Discord</a>
            
                <a href="https://www.youtube.com/@Github-Zombeeyang/videos" key="Youtube">Youtube</a>
            
        </div>
        <sp-divider></sp-divider>
        
            <h2>
                <a href="https://github.com/zombieyang/sd-ppp">Github</a>
            </h2>
        
    </div>
    `};var So=ai,ci="sponsorData",$s="https://sdppp.zombee.tech/sponsors/sponsors.html.json",Js=500;function Do(){try{let e=localStorage.getItem(ci);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to parse sponsor data from localStorage:",e)}return null}function js(e){try{localStorage.setItem(ci,JSON.stringify(e))}catch(t){console.warn("Failed to save sponsor data to localStorage:",t)}}function kr(e){try{return!e||typeof e!="object"?(console.warn("Invalid sponsor data: not an object"),!1):typeof e.en!="string"?(console.warn("Invalid sponsor data: en is not a string"),!1):typeof e.zh!="string"?(console.warn("Invalid sponsor data: zh is not a string"),!1):!0}catch(t){return console.warn("Error validating sponsor data:",t),!1}}async function Xs(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`Fetch failed with status: ${t.status}`);let r=await t.json();return kr(r)?r:null}catch(t){return console.warn(`Failed to fetch from ${e}:`,t),null}}var Lr=null;function _r(){let[e,t]=Fe.default.useState(!0);if(!Lr){let s=Do();Lr=new Promise(a=>{let c=!1;Xs($s).then(m=>{!c&&m&&(c=!0,js(m),a(m),t(!1))}),setTimeout(()=>{c||(c=!0,s&&kr(s)?(a(s),t(!1)):(console.warn("Using default data as fallback"),a(So),t(!1)))},Js)})}let[r,o]=Fe.default.useState(()=>{let s=Do();return s&&kr(s)?s:So});Fe.default.useEffect(()=>{Lr&&Lr.then(s=>{o(s)}).catch(s=>{console.error("Error in useSponsor:",s);let a=Do();o(a&&kr(a)?a:So)})},[]);let[n,i]=(0,Fe.useState)(!0);return(0,Fe.useEffect)(()=>{n&&!e&&i(e)},[e]),{data:r,isLoading:n}}var li=v(P(),1);function ui(){let{data:e}=_r(),t=e[Ht()=="zhcn"?"zh":"en"];return(0,li.jsx)("div",{style:{height:"100%",overflow:"auto"},dangerouslySetInnerHTML:{__html:t}})}var be=v(E(),1);var di=v(E(),1),wt=v(P(),1),Wt=class extends di.default.Component{render(){let t=this.props.size||1;return(0,wt.jsx)("div",{slot:"icon",className:"sdppp-icon",onClick:this.props.onClick,children:(0,wt.jsxs)("svg",{width:20*t,height:20*t,viewBox:"0 0 14 14",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,wt.jsx)("path",{d:"M5.586 5.586A2 2 0 018.862 7.73a.5.5 0 10.931.365 3 3 0 10-1.697 1.697.5.5 0 10-.365-.93 2 2 0 01-2.145-3.277z",fill:"currentColor"}),(0,wt.jsx)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M.939 6.527c.127.128.19.297.185.464a.635.635 0 01-.185.465L0 8.395a7.099 7.099 0 001.067 2.572h1.32c.182 0 .345.076.46.197a.635.635 0 01.198.46v1.317A7.097 7.097 0 005.602 14l.94-.94a.634.634 0 01.45-.186H7.021c.163 0 .326.061.45.186l.939.938a7.098 7.098 0 002.547-1.057V11.61c0-.181.075-.344.197-.46a.634.634 0 01.46-.197h1.33c.507-.76.871-1.622 1.056-2.55l-.946-.946a.635.635 0 01-.186-.465.635.635 0 01.186-.464l.943-.944a7.099 7.099 0 00-1.044-2.522h-1.34a.635.635 0 01-.46-.197.635.635 0 01-.196-.46V1.057A7.096 7.096 0 008.413.002l-.942.942a.634.634 0 01-.45.186H6.992a.634.634 0 01-.45-.186L5.598 0a7.097 7.097 0 00-2.553 1.058v1.33c0 .182-.076.345-.197.46a.635.635 0 01-.46.198h-1.33A7.098 7.098 0 00.003 5.591l.936.936zm.707 1.636c.324-.324.482-.752.479-1.172a1.634 1.634 0 00-.48-1.171l-.538-.539c.126-.433.299-.847.513-1.235h.768c.459 0 .873-.19 1.167-.49.3-.295.49-.708.49-1.167v-.77c.39-.215.807-.388 1.243-.515l.547.547c.32.32.742.48 1.157.48l.015-.001h.014c.415 0 .836-.158 1.157-.479l.545-.544c.433.126.846.299 1.234.512v.784c0 .46.19.874.49 1.168.294.3.708.49 1.167.49h.776c.209.382.378.788.502 1.213l-.545.546a1.635 1.635 0 00-.48 1.17c-.003.421.155.849.48 1.173l.549.55c-.126.434-.3.85-.513 1.239h-.77c-.458 0-.872.19-1.166.49-.3.294-.49.708-.49 1.167v.77a6.09 6.09 0 01-1.238.514l-.54-.54a1.636 1.636 0 00-1.158-.48H6.992c-.415 0-.837.159-1.157.48l-.543.543a6.091 6.091 0 01-1.247-.516v-.756c0-.459-.19-.873-.49-1.167-.294-.3-.708-.49-1.167-.49h-.761a6.094 6.094 0 01-.523-1.262l.542-.542z",fill:"currentColor"})]})})}};var Mt=v(P(),1);function fi(){let{loggedInUsername:e,logout:t}=me();return(0,Mt.jsxs)("div",{className:"login-block",children:[(0,Mt.jsxs)("div",{className:"api-key-title",children:[R.\u63D2\u4EF6\u540D\u5B57," ID: ",e||"\u672A\u767B\u5F55"]}),(0,Mt.jsx)("div",{className:"logout-btn action-button",onClick:()=>{t()},children:e?g("Logout"):g("Login")})]})}var xr=v(E(),1);var xe=v(P(),1);function Tr(e){let{state:t}=he(D,["/comfyUserToken"]),{logout:r}=re(),{workflowAgentSID:o,workflowAgent:n,comfyMultiUser:i}=A(),{resetWebview:s}=J(),[a,c]=(0,xr.useState)(!1);if((0,xr.useEffect)(()=>{if(!n){D.setComfyUserToken("");return}let l=(f,u)=>{let p=t?.comfyUserToken;D.setComfyUserToken(f),p==""&&a&&(s(),c(!1))};return n.subscribe("/comfyUserToken",l),l(n.data.comfyUserToken,""),()=>{n&&n.unsubscribe(l)}},[n,a,s]),!i)return null;if(!R.enableMU&&i)return(0,xe.jsxs)("div",{className:"login-block",children:[(0,xe.jsx)("div",{className:"login-title",children:g("Comfy multi-user: ")}),(0,xe.jsx)("div",{children:g("ComfyUI with --multi-user is only available for sponsors")})]});let m=n&&t?.comfyUserToken,d=t?.comfyUserToken?.split("_")[0]||"";return(0,xe.jsxs)("div",{className:"login-block",children:[(0,xe.jsx)("div",{className:`login-title${m?"":" login-title-secondary"}`,children:g("Comfy multi-user: ")+(m?d:"")}),m?(0,xe.jsx)("div",{className:"logout-btn action-button",onClick:()=>{r(o),c(!1)},children:g("Logout")}):(0,xe.jsx)("div",{className:"logout-btn action-button",onClick:()=>{c(!0),e.onRequestLogin?.()},children:g("Not Login")})]})}var Be=v(P(),1);function Rr(){let{workflowAgent:e}=A(),{state:t}=he(e,["/comfyOrgAPIKey","/comfyOrgLoggedIn"]),{setComfyOrgAPIKey:r}=re();return t?t.comfyOrgLoggedIn&&!t.comfyOrgAPIKey?(0,Be.jsxs)("div",{className:"login-block",children:[(0,Be.jsx)("div",{className:"api-key-title",children:"ComfyOrg API Key"}),(0,Be.jsx)("div",{children:g("Logged in by email/password")})]}):(0,Be.jsxs)("div",{className:"login-block",children:[(0,Be.jsx)("div",{className:"api-key-title",children:"ComfyOrg API Key"}),(0,Be.jsx)("div",{className:"logout-btn action-button",onClick:()=>{let o=prompt(g("Please input API key (will reload Runner)"));o&&r(o)},children:g("Set API Key")})]}):null}var Nr=v(P(),1),Zs=({pageInstance:e})=>{let{autoRunning:t,workflowAgentSID:r,setWorkflowAgentSID:o}=A(),n=r==e.sid,i=t?.value==e.sid;return(0,Nr.jsx)("div",{className:`agent-list-item${n?" selected":""}${n||i?" checked":""}`,onClick:()=>o(n?"":e.sid),children:(0,Nr.jsxs)("span",{children:["\u25CF [",e.ssid,"] ",e.title]})})},pi=Zs;var ye=v(P(),1),mi=()=>{let{workflowAgentSID:e,setWorkflowAgentSID:t,backendURL:r}=A(),{webviewAgentSID:o}=J(),{pageInstances:n}=Ar(),{timeoutError:i}=J();return(0,ye.jsxs)(ye.Fragment,{children:[i?(0,ye.jsx)("div",{className:"client-panel-title",children:g("Webview load timeout, please switch to a different runner")}):(0,ye.jsxs)("div",{className:"client-panel-title",children:[g("Runner")," (",r,")"]}),(0,ye.jsx)("sp-label",{children:g("Open ComfyUI in the browser to see more options")}),(0,ye.jsxs)("div",{className:"agent-list",children:[(0,ye.jsx)("div",{className:`agent-list-item${e==o?" selected":""}`,onClick:()=>t(o),children:(0,ye.jsxs)("span",{children:["\u25CF ",g("PS Webview")]})}),n.map(s=>(0,ye.jsx)(pi,{pageInstance:s},s.sid))]})]})};var Ie=v(P(),1);function hi({onRequestLogin:e}){let{timeoutError:t}=J(),{hasAuthingLogin:r}=me();return(0,Ie.jsxs)("div",{className:"client-panel",children:[(!r||t)&&(0,Ie.jsx)(mi,{}),(0,Ie.jsxs)("div",{className:"app-login-container",children:[(0,Ie.jsx)("div",{className:"client-panel-title",children:g("Login/Auth")}),r&&(0,Ie.jsx)(fi,{}),(0,Ie.jsx)(Tr,{onRequestLogin:e}),(0,Ie.jsx)(Rr,{}),(0,Ie.jsxs)("sp-label",{children:["photoshop id: ",D.data.uname]})]})]})}var q=v(P(),1);function gi(){let{backendURL:e,setBackendURL:t,connectState:r,doConnectOrDisconnect:o}=A(),n=r==="connected"||r==="connecting"?{disabled:!0}:{};(0,be.useEffect)(()=>{e&&r==="disconnected"&&setTimeout(()=>{o()},1e3)},[]);let i=(0,be.useRef)(!1);return(0,be.useEffect)(()=>()=>{i.current=!0},[]),(0,be.useEffect)(()=>()=>{r==="connected"&&i.current&&o()},[r]),(0,q.jsxs)(q.Fragment,{children:[r==="connected"?(0,q.jsx)(ea,{}):(0,q.jsx)("sp-textfield",{id:"url-bar",label:"backendURL",onInput:s=>{t(s.currentTarget.value)},...n,value:e||"",placeholder:gr}),(0,q.jsx)("sp-action-button",{id:"connect-btn",onClick:()=>{o()},children:r!=="disconnected"?"\u2297":"\u2192"})]})}function ea(){let[e,t]=(0,be.useState)(""),[r,o]=(0,be.useState)(""),{workflowAgentSID:n}=We(),{comfyMultiUser:i}=A(),{webviewAgentSID:s,timeoutError:a,loadError:c,toggleWebviewDialog:m}=J(),d=(0,be.useRef)(null),{ssid:l,lastError:f,progress:u,executingNodeTitle:p,queueSize:h}=Er(n),{loggedInUsername:w,hasAuthingLogin:b,isLogin:y}=me(),S=n&&h?`(${h})`:"";(0,be.useEffect)(()=>{n?n&&(p?t(`(${u}% - ${p}...)`):(t(""),o(""))):i&&!D.data.comfyUserToken?t(g("--multi-user Not Login!")):(a||c)&&o(g("Error: {0}",c||g("timeout")))},[n,f,u,p,a,c,i]);let I="";return s==n?I=g("PS Webview"):n&&l?I=g("Browser {0}",l):I=g("Loading..."),(0,q.jsxs)("div",{className:"connect-configuration",onClick:()=>{d.current?.show()},children:[(0,q.jsx)("dialog",{ref:d,style:{margin:"0",width:"480px",height:"540px",padding:"8px"},onClick:$=>{$.stopPropagation()},children:(0,q.jsx)(hi,{onRequestLogin:async()=>{d.current?.close(),await new Promise($=>setTimeout($,300)),m()}})}),(0,q.jsxs)("div",{className:"connect-config-content",children:[b?(0,q.jsxs)("span",{children:["\u7528\u6237\u540D\uFF1A",y?w:"\u672A\u767B\u5F55"]}):(0,q.jsxs)("span",{children:["\u23F5 ",g("Runner"),": ",I," ",S]}),r&&(0,q.jsx)("span",{className:"connect-config-error",children:r}),!r&&e&&(0,q.jsx)("span",{className:"connect-config-message",children:e})]}),(0,q.jsx)("div",{className:"connect-config-actions",children:(0,q.jsx)(Wt,{size:.8})}),u?(0,q.jsx)("div",{className:"connect-config-progress",style:{width:`${u}%`}}):""]})}var vi=v(E(),1);var Ve=class{static makeDocumentDataOptions(t){let r=t.data,o=[`${C.getSpecialDocumentCurrent()}`];return Object.keys(r.documents).forEach(n=>{let i=r.documents[n];o.push(i.identify)}),o}static findDocumentData(t,r){let o=C.is_SPECIAL_DOCUMENT_CURRENT(r)?t.data.activeDocumentID:No(r).id;return t.data.documents[o]}static makeLayerOptions(t,r){return r.concat(t.layers.map(n=>n.identify))}static getLayerDirtyID(t,r){return t.layers.find(n=>n.identify===r)?.dirtyID||0}static getCanvasDirtyID(t){return t.canvasDirtyID||0}static getSelectionDirtyID(t){return t.selectionDirtyID||0}};var wi=v(E(),1);var yi=v(E(),1);function Pe(e){return e=e||12,{flex:`${e} 0 calc(${e/12*100}% - 10px)`,maxWidth:"100%"}}var vt=class extends wi.Component{computeUIWeightCSS(t){return Pe(t)}};var tt=v(P(),1),Ge=class extends vt{state={filter:""};handleSelectUpdate=(t,r)=>{this.props.onSelectUpdate(t,r),this.setState({filter:""})};render(){let{options:t,value:r,name:o}=this.props;return(0,tt.jsxs)("div",{style:{display:"flex",alignItems:"center",...this.computeUIWeightCSS(this.props.uiWeight)},children:[o&&(0,tt.jsx)("sp-label",{style:{flex:1},children:o}),(0,tt.jsx)("sp-picker",{class:"sdppp-dropdown-widget",size:"s",style:this.props.name?{flex:2}:{width:"100%"},children:(0,tt.jsx)("sp-menu",{slot:"options",children:t.map((n,i)=>this.state.filter&&!n.includes(this.state.filter)?"":(0,tt.jsx)("sp-menu-item",{...Or(n)===Or(r)?{selected:!0}:{},onClick:()=>this.handleSelectUpdate(n,i),children:Or(n)},Or(n)))})})]})}};function Or(e){return typeof e=="string"?e:e.content}var bi=v(P(),1),Wr=class e extends vi.default.Component{state={options:Ve.makeDocumentDataOptions(D)};constructor(t){super(t),D.subscribe("/documents",this.updateOptions)}updateOptions=()=>{let t=Ve.makeDocumentDataOptions(D);this.setState({options:t})};componentwillUnmount(){D.unsubscribe(this.updateOptions)}static getValueIfIsValidOptionOrCurrent(t,r){return!r||r.includes(t)?t:C.getSpecialDocumentCurrent()}static getDerivedStateFromProps(t,r){let o=t.value;if(o){let n=o.split("/"),i=e.getValueIfIsValidOptionOrCurrent(n.slice(1).join("/"),r.options);return C.is_SPECIAL_DOCUMENT_CURRENT(i)?o=C.getSpecialDocumentCurrent():o=i,n[0]!=D.data.uname&&t.onSelectUpdate(D.data.uname+"/"+o,0),Object.assign(r,{value:o})}return null}render(){let t=e.getValueIfIsValidOptionOrCurrent(this.props.value,this.state.options);return(0,bi.jsx)(Ge,{uiWeight:this.props.uiWeight,options:this.state.options,onSelectUpdate:(r,o)=>{this.props.onSelectUpdate(D.data.uname+"/"+r,o)},value:t})}};var Si=v(E(),1);var Pi=v(P(),1);function we(e){return(0,Pi.jsx)("a",{onClick:e.onClick,children:e.label})}var Te=v(P(),1),Qe=class extends Si.default.Component{state={options:[]};constructor(t){super(t),D.subscribe("/documents",this.updataOptionsAfterDocumentChange)}componentwillUnmount(){D.unsubscribe(this.updataOptionsAfterDocumentChange)}componentDidMount(){this.updateOptions(this.props.documentValue||C.getSpecialDocumentCurrent())}shouldComponentUpdate(t,r){return t.documentValue!=this.props.documentValue&&t.documentValue&&this.updateOptions(t.documentValue),!0}updataOptionsAfterDocumentChange=()=>{this.updateOptions(this.props.documentValue||C.getSpecialDocumentCurrent())};updateOptions=t=>{t=t||this.props.documentValue||C.getSpecialDocumentCurrent();let r=Ve.findDocumentData(D,t);if(!r){this.setState({options:[]});return}let o=Ve.makeLayerOptions(r,C.getSpecialLayerForGet());this.setState({options:o})};render(){let t=this.props.value;if(t)try{t=g(t)}catch{}return(0,Te.jsxs)("div",{className:"sdppp-layer-widget",style:Pe(this.props.uiWeight),children:[(0,Te.jsx)("div",{className:"sdppp-layer-widget-dropdown",children:(0,Te.jsx)(Ge,{uiWeight:12,options:this.state.options,onSelectUpdate:this.props.onSelectUpdate,value:t})}),(0,Te.jsxs)("div",{className:"sdppp-layer-widget-quick-set",children:[(0,Te.jsxs)("sp-label",{children:[g("Quick Set"),":"]}),(0,Te.jsx)(we,{onClick:async()=>{let r=$e();this.props.onSelectUpdate(r,this.state.options.indexOf(r))},label:g("Selected Layer")}),(0,Te.jsx)(we,{onClick:async()=>{this.props.onSelectUpdate(C.get_SPECIAL_LAYER_USE_CANVAS(),this.state.options.indexOf(C.get_SPECIAL_LAYER_USE_CANVAS()))},label:g("Canvas")})]})]})}};var Bt=v(kt(),1),bt=N("photoshop"),ue=v(E(),1);var Co=v(kt(),1),Mr=N("photoshop"),ce=v(E(),1);var Ut=v(P(),1);function Ft({mode:e,setMode:t}){let r=o=>{t(o)};return(0,Ut.jsxs)("div",{className:"widget-mode-selection",children:[(0,Ut.jsx)("button",{className:`widget-mode-selection-button ${e==="manual"?"selected":""}`,onClick:()=>r("manual"),children:g("Manual")}),(0,Ut.jsx)("button",{className:`widget-mode-selection-button ${e==="auto"?"selected":""}`,onClick:()=>r("auto"),children:g("Auto")})]})}var ae=v(P(),1);function Di(e){let[t,r]=(0,ce.useState)(""),[o,n]=(0,ce.useState)(""),[i,s]=(0,ce.useState)("manual"),[a,c]=(0,ce.useState)(!1),[m,d]=(0,ce.useState)(null),{backendURL:l}=A(),{uploadImage:f}=re(),{addBeforeWorkflowRunHook:u}=ht(),p=(0,ce.useRef)(null),h=(0,ce.useCallback)(async()=>{if(i==="manual"&&!a&&m){await e.onValueChange(m);return}try{if(i==="auto"&&await b(t),p.current){let y=await p.current.getBuffer(Co.JimpMime.jpeg),S=await f(y,St(6)+".jpeg");S?.name&&(d(S.subfolder+"/"+S.name),c(!1),await e.onValueChange(S.subfolder+"/"+S.name))}}catch(y){console.error(y)}},[i,a,m,e.onValueChange]);(0,ce.useEffect)(()=>{let S=u(h);return()=>{S()}},[h]);let w=o;if(!w&&(m||e.value)){let y=m||e.value,S=y.split("/").slice(0,-1).join("/");w=l+(l.endsWith("/")?"":"/")+`api/view?filename=${y}&type=input&subfolder=${S}&rand=`+Math.random()}let b=(0,ce.useCallback)(async y=>{let S=await Io(y);if(!S)return;p.current=S;let I=await ta(S);r(y),n(I),c(!0)},[]);return(0,ae.jsxs)("div",{className:"image-widget",children:[(0,ae.jsx)("div",{className:"image-widget-left",children:(0,ae.jsx)("img",{src:w,className:"image-widget-image"+(w?"":" image-widget-image-empty")})}),(0,ae.jsxs)("div",{className:"image-widget-right",children:[(0,ae.jsx)(Ft,{mode:i,setMode:s}),i==="manual"&&(0,ae.jsxs)("div",{className:"image-widget-more-quickset",children:[(0,ae.jsx)("sp-label",{children:g("Set As:")}),(0,ae.jsx)(we,{onClick:()=>{b($e())},label:g("Selected Layer")}),(0,ae.jsx)(we,{onClick:()=>{b(C.get_SPECIAL_LAYER_USE_CANVAS())},label:g("Canvas")})]}),i=="auto"&&(0,ae.jsx)("div",{className:"image-widget-layer-widget-container",children:(0,ae.jsx)(Qe,{onSelectUpdate:b,uiWeight:10,value:t})})]})]})}async function Io(e){if(!Mr.app.activeDocument)return null;try{return await lr.getJimpImage({document_identify:Ae(Mr.app.activeDocument.id,Mr.app.activeDocument.name),layer_identify:e})}catch(t){throw console.error(t),t}}async function ta(e){let t=100/Math.max(e.width,e.height);return e=e.clone(),e.scale(t),await e.getBase64(Co.JimpMime.jpeg)}var X=v(P(),1);function Ii(e){let[t,r]=(0,ue.useState)(""),[o,n]=(0,ue.useState)(""),[i,s]=(0,ue.useState)("manual"),[a,c]=(0,ue.useState)(!1),[m,d]=(0,ue.useState)(null),{backendURL:l}=A(),{uploadImage:f}=re(),{addBeforeWorkflowRunHook:u}=ht(),p=(0,ue.useRef)(null),h=(0,ue.useCallback)(async()=>{if(i==="manual"&&!a&&m){await e.onValueChange(m);return}try{if(i==="auto"&&await b(t),p.current){let y=await p.current.getBuffer(Bt.JimpMime.png),S=await f(y,St(6)+".png");S?.name&&(d(S.subfolder+"/"+S.name),c(!1),await e.onValueChange(S.subfolder+"/"+S.name))}}catch(y){console.error(y)}},[i,a,m,e.onValueChange]);(0,ue.useEffect)(()=>{let y=u(h);return()=>{y()}},[h]);let w=o;if(!w&&(m||e.value)){let y=m||e.value,S=y.split("/").slice(0,-1).join("/");w=l+(l.endsWith("/")?"":"/")+`api/view?filename=${y}&type=input&subfolder=${S}&rand=`+Math.random()}let b=(0,ue.useCallback)(async(y,S=!1)=>{let I=await Io(y);if(!I)return;S&&I.scan(0,0,I.bitmap.width,I.bitmap.height,function(ve,oe,k){I.bitmap.data[k+3]=255-I.bitmap.data[k+3]}),p.current=I;let $=await Ci(I);r(y),n($),c(!0)},[]);return(0,X.jsxs)("div",{className:"image-widget",children:[(0,X.jsx)("div",{className:"image-widget-left",children:(0,X.jsx)("img",{src:w,className:"image-widget-image"+(w?"":" image-widget-image-empty")})}),(0,X.jsxs)("div",{className:"image-widget-right",children:[(0,X.jsx)(Ft,{mode:i,setMode:y=>{s(y)}}),i==="manual"&&(0,X.jsxs)("div",{className:"image-widget-more-quickset",children:[(0,X.jsx)("sp-label",{children:g("Set As:")}),(0,X.jsx)(we,{onClick:()=>{b($e(),!1)},label:g("Selected Layer")}),(0,X.jsx)(we,{onClick:async()=>{b($e(),!0)},label:g("Selected Layer (invert)")}),(0,X.jsx)(we,{onClick:()=>{b(C.get_SPECIAL_LAYER_USE_CANVAS())},label:g("Canvas")}),(0,X.jsx)(we,{onClick:async()=>{let y=await ra();if(!y)return;p.current=y;let S=await Ci(y);r(""),n(S),c(!0)},label:g("Selection")})]}),i==="auto"&&(0,X.jsx)("div",{className:"image-widget-layer-widget-container",children:(0,X.jsx)(Qe,{onSelectUpdate:y=>{b(y,!1)},uiWeight:12,value:t})})]})]})}async function ra(){if(!bt.app.activeDocument)return null;try{let e=await Tt({document_identify:Ae(bt.app.activeDocument.id,bt.app.activeDocument.name),boundary:{left:0,top:0,right:0,bottom:0,width:bt.app.activeDocument.width,height:bt.app.activeDocument.height}});if(!e?.blob)return null;let t=e.blob,r=new Uint8Array(t.length*4);for(let o=0;o<t.length;o++)r[o*4]=127,r[o*4+1]=127,r[o*4+2]=127,r[o*4+3]=255-t[o];return new Bt.Jimp({data:r,width:e.width,height:e.height})}catch(e){throw console.error(e),e}}async function Ci(e,t=!1){let r=100/Math.max(e.width,e.height);return e=e.clone(),e.scale(r),e.scan(0,0,e.bitmap.width,e.bitmap.height,function(o,n,i){let s=e.bitmap.data[i+3],a=t?s:255-s;e.bitmap.data[i]=a,e.bitmap.data[i+1]=a,e.bitmap.data[i+2]=a,e.bitmap.data[i+3]=255}),await e.getBase64(Bt.JimpMime.png)}var ko=v(E(),1);var rt=v(E(),1);var z=v(P(),1);function Eo({widgetTableStructure:e,widgetTableValue:t,widgetTableErrors:r,onWidgetRender:o,onWidgetChange:n,onTitleRender:i}){let[s,a]=(0,rt.useState)(0),c=(0,rt.useMemo)(()=>e.nodeIndexes.map(f=>{let u=e.nodes[f],p=(y,S,I)=>y.keepRender?S.outputType==="error"?(y.result.push((0,z.jsx)("span",{className:"list-error-label",children:t[u.id][I]})),y):(o?.(y,u,S,I),y):y,h=Object.values(e.groups).find(y=>y.nodeIDs.includes(u.id)),w=h?.color||"rgba(127, 127, 127, .4)";if(s&&h?.id!==s)return null;let b=u.uiWeightSum<=8&&u.widgets.length==1&&(u.widgets[0].outputType!=="number"||!e.extraOptions?.useSliderForNumberWidget);return(0,z.jsxs)("div",{className:"workflow-edit-field",children:[(0,z.jsx)("div",{className:"workflow-edit-field-title",title:u.title,style:{...Pe(b?4:12),borderColor:w},children:i?i(u.title,u):(0,z.jsx)("span",{children:u.title})}),u.widgets.reduce(p,{keepRender:!0,result:[]}).result.map((y,S)=>(0,z.jsx)(Ao,{children:y},S)),r[u.id]?(0,z.jsx)("span",{className:"list-error-label",children:r[u.id]}):""]},u.id)}).filter(Boolean),[e,t,r,o,n,i,s]),[m,d]=(0,rt.useMemo)(()=>[Object.keys(r).filter(f=>e.nodes[parseInt(f)]),Object.keys(r).filter(f=>!e.nodes[parseInt(f)])],[r,e]),l=null;return d.length>0?l=(0,z.jsx)("span",{className:"list-error-label",children:r[+d[0]]}):m.length>0&&(l=(0,z.jsx)("span",{className:"list-error-label",children:r[+m[0]]})),(0,z.jsxs)(z.Fragment,{children:[l,Object.keys(e.nodes).length?"":(0,z.jsx)("span",{className:"list-error-label",children:g("no suitable node to control in this workflow")}),(0,z.jsx)("div",{className:"workflow-edit-content",children:c})]})}var Ao=class extends rt.default.Component{constructor(t){super(t),this.state={hasError:!1,error:null}}componentDidCatch(t,r){this.setState({hasError:!0,error:t})}render(){return this.state.hasError?(0,z.jsx)("span",{className:"list-error-label",children:this.state.error?.stack||this.state.error?.message||this.state.error?.toString()}):this.props.children}};var Ke=v(E(),1);var qe=v(P(),1),Ai=e=>{let{inputMin:t,inputMax:r,inputStep:o,value:n=0,onValueChange:i,name:s,uiWeight:a,extraOptions:c}=e,[m,d]=(0,Ke.useState)(+n.toFixed(3));(0,Ke.useEffect)(()=>{d(+n.toFixed(3))},[n]);let l=(0,Ke.useCallback)(h=>{let w=+h.target.value;d(+w.toFixed(3))},[]),f=(0,Ke.useCallback)(()=>{i(m)},[m,i]),u=(0,Ke.useCallback)(h=>{let w=+h.target.value;d(+w.toFixed(3)),i(+w.toFixed(3))},[m,i]);return!((r-t)/o>1e3)&&a&&a>=1&&c?.useSliderForNumberWidget?(0,qe.jsxs)("div",{style:{...Pe(a),display:"flex",alignItems:"center"},children:[(0,qe.jsx)("sp-slider",{style:{width:"60%"},min:t,max:r,step:o,value:m,onInput:u,"show-value":"false",class:"sdppp-slider"}),(0,qe.jsx)("sp-textfield",{style:{width:"40%"},onInput:l,onBlur:f,value:m})]}):(0,qe.jsxs)("div",{style:{...Pe(a),display:"flex",alignItems:"center"},children:[s&&(0,qe.jsx)("sp-label",{style:{flex:"1"},children:s}),(0,qe.jsx)("sp-textfield",{style:s?{flex:"2"}:{width:"100%"},onInput:l,onBlur:f,value:m})]})};var Y=v(E(),1);var Pt=v(P(),1);function Ei(e){let t=Y.default.useRef(null),[r,o]=(0,Y.useState)(0),[n,i]=(0,Y.useState)(e.value??""),[s,a]=(0,Y.useState)(!1);return(0,Y.useEffect)(()=>{s||i(e.value??"")},[e.value]),(0,Y.useEffect)(()=>{let c=setInterval(()=>{if(t.current){let m=t.current.offsetHeight;m!==r&&o(m)}},16);return()=>clearInterval(c)},[r]),(0,Pt.jsxs)("div",{className:"widget-container",style:{...Pe(e.uiWeight),position:"relative",height:Math.max(55,r)},children:[(0,Pt.jsx)(oa,{textAreaValue:n,setTextAreaValue:i,editing:s,setEditing:a,onValueChange:e.onValueChange,hiddenDivHeight:r}),(0,Pt.jsx)("p",{ref:t,style:{fontSize:14,visibility:"hidden",whiteSpace:"pre-line",width:"100%"},children:n})]})}function oa({textAreaValue:e,onValueChange:t,editing:r,setEditing:o,setTextAreaValue:n,hiddenDivHeight:i}){let[s,a]=(0,Y.useState)(0),c=(0,Y.useCallback)(u=>{let p=u.target.value;t(p),n(p)},[t,n]),m=(0,Y.useCallback)(()=>{o(!0)},[o]),d=(0,Y.useCallback)(()=>{let u={textfieldRerender:s,editing:!1};s==2&&(u.textfieldRerender=1),a(u.textfieldRerender),o(u.editing)},[s,a,o]),[l,f]=(0,Y.useState)(i);return(0,Y.useEffect)(()=>{i!=l&&(a(r?2:1),f(i))},[i]),(0,Y.useEffect)(()=>{s==1&&Promise.resolve().then(async()=>{await new Promise(requestAnimationFrame),a(0)})},[s]),s==1?"":(0,Pt.jsx)("sp-textarea",{style:{position:"absolute",height:"100%",width:"100%",top:0,left:0},value:e,onInput:c,onFocus:m,onBlur:d})}var Lo=v(P(),1),Ur=class extends vt{onInput=t=>{let r=!!t.target.value;this.setState({value:r}),this.props.onValueChange(r)};render(){let t=this.props.value?{checked:!0}:{};return R.checkboxStyle==="div"?(0,Lo.jsx)("div",{style:{...this.computeUIWeightCSS(this.props.uiWeight)},className:(t.checked?"active":"")+" sdppp-checkbox",onClick:r=>{this.props.onValueChange(!this.props.value)},children:this.props.name||""}):(0,Lo.jsx)("sp-checkbox",{label:this.props.name||"",style:{...this.computeUIWeightCSS(this.props.uiWeight)},onInput:r=>{this.props.onValueChange(r.target.checked)},...t,children:this.props.name||""})}};function Li(e){return e.replace(/^workflows\//,"").replace(/\.json$/,"").split("://").pop()}var Z=v(P(),1);function ki(){let{callForPSDExtract:e}=re(),{workflowAgent:t}=A(),{setWidgetValue:r}=ei(),{setShouldTriggerLivePainting:o}=Cr(),{state:n}=he(t,["/widgetTableValue","/widgetTableStructure","/widgetTableErrors"]),i=!!t?.data.hasPSDNodes,s=(0,ko.useCallback)(async(l,f,u,p)=>{await r(l,f,u),o(!0)},[r,o]),a=n?.widgetTableStructure,c=n?.widgetTableValue,m=n?.widgetTableErrors,d=(0,ko.useCallback)((l,f,u,p)=>{if(u.outputType=="PS_DOCUMENT")return l.result.push((0,Z.jsx)(Wr,{uiWeight:u.uiWeight||12,value:c?.[f.id]?.[p]||"",onSelectUpdate:h=>{s(f.id,p,h,f)},extraOptions:a?.extraOptions},p)),!0;if(u.outputType=="PS_LAYER"){let h=u.options?.documentNodeID||0,w=c?.[h]?.[0]||"";return l.result.push((0,Z.jsx)(Qe,{uiWeight:u.uiWeight||12,value:c?.[f.id]?.[p]||"",documentValue:w?w.split("/").pop():"",onSelectUpdate:b=>{s(f.id,p,b,f)},extraOptions:a?.extraOptions},p)),!0}else{if(u.outputType=="IMAGE_PATH")return l.result.push((0,Z.jsx)(Di,{uiWeight:u.uiWeight||12,value:c?.[f.id]?.[p]||"",onValueChange:async h=>{await s(f.id,p,h,f)},extraOptions:a?.extraOptions},p)),!0;if(u.outputType=="MASK_PATH")return l.result.push((0,Z.jsx)(Ii,{uiWeight:u.uiWeight||12,value:c?.[f.id]?.[p]||"",onValueChange:async h=>{await s(f.id,p,h,f)},extraOptions:a?.extraOptions},p)),!0;if(u.outputType==="number"){let h=u.options?.min??0,w=u.options?.max??100,b=u.options?.step??1;l.result.push((0,Z.jsx)(Ai,{uiWeight:u.uiWeight||12,name:u.name,inputMin:h,inputMax:w,inputStep:b,value:parseFloat(c?.[f.id]?.[p]||"0"),onValueChange:y=>{s(f.id,p,y,f)},extraOptions:a?.extraOptions},p))}else if(u.outputType==="combo")l.result.push((0,Z.jsx)(Ge,{uiWeight:u.uiWeight||12,name:u.name,options:u.options?.values||[],onSelectUpdate:h=>{s(f.id,p,h,f)},value:c?.[f.id]?.[p]||"",extraOptions:a?.extraOptions},p));else if(u.outputType==="toggle")l.result.push((0,Z.jsx)(Ur,{uiWeight:u.uiWeight||12,name:u.name,value:c?.[f.id]?.[p]||"",onValueChange:h=>{s(f.id,p,h,f)},extraOptions:a?.extraOptions},p));else{let h=c?.[f.id]?.[p]||"";l.result.push((0,Z.jsx)(Ei,{uiWeight:u.uiWeight||12,value:typeof h=="string"?h:JSON.stringify(h),onValueChange:w=>{s(f.id,p,w,f)},extraOptions:a?.extraOptions},p))}}return!1},[r,c]);return a?(0,Z.jsxs)("div",{className:"workflow-edit",children:[(0,Z.jsxs)("div",{className:"workflow-edit-title",children:[a.widgetTablePath&&(0,Z.jsx)("sp-label",{style:{fontWeight:"bold"},children:Li(a.widgetTablePath)}),i?(0,Z.jsx)("a",{onClick:()=>{e(t?.data.sid||"").catch(l=>{alert(l.message)})},children:">"+g("sample .psd")}):""]}),(0,Z.jsx)(Eo,{widgetTableStructure:a,widgetTableValue:c||{},widgetTableErrors:m||{},onWidgetChange:s,onWidgetRender:d})]}):null}var Fr=v(E(),1);var G=v(P(),1);function _i(){let{login:e,loginStyle:t,loginBannerTop:r,loginBannerBottom:o,setIsTrialing:n}=me(),[i,s]=(0,Fr.useState)(localStorage.getItem("last-username")||""),[a,c]=(0,Fr.useState)(""),[m,d]=(0,Fr.useState)("");return(0,G.jsxs)("div",{className:"login-container",children:[r,(0,G.jsx)("div",{className:"login-container-login",children:(0,G.jsxs)("div",{className:"login-form",children:[t==="invitation"?(0,G.jsxs)("div",{className:"login-form-item",children:[(0,G.jsx)("label",{htmlFor:"username",children:g("Invitation Code")}),(0,G.jsx)("sp-textfield",{type:"text",id:"username",placeholder:g("Please input invitation code"),value:i,onInput:l=>s(l.target.value)})]}):(0,G.jsxs)(G.Fragment,{children:[(0,G.jsxs)("div",{className:"login-form-item",children:[(0,G.jsx)("label",{htmlFor:"username",children:g("Username")}),(0,G.jsx)("sp-textfield",{type:"text",id:"username",placeholder:g("Please input username"),value:i,onInput:l=>s(l.target.value)})]}),(0,G.jsxs)("div",{className:"login-form-item",children:[(0,G.jsx)("label",{htmlFor:"password",children:g("Password")}),(0,G.jsx)("sp-textfield",{type:"password",id:"password",placeholder:g("Please input password"),value:a,onInput:l=>c(l.target.value)})]})]}),(0,G.jsx)("div",{className:"login-error-message",children:m}),(0,G.jsx)("button",{className:"login-button",onClick:async()=>{let l=await e(i,a);l.success?(d(""),localStorage.setItem("last-username",i)):d(l.message)},children:g("Login")}),t==="trialable-password"&&(0,G.jsx)("a",{className:"trial-button",onClick:()=>n(!0),children:"\u6E38\u5BA2\u8BD5\u7528"})]})}),o]})}var He=v(P(),1);function xi({renderContent:e}){let{connectState:t}=A(),{isLogin:r,isTrialing:o}=me();return(0,He.jsxs)("div",{className:"sdppp-container",style:t!=="connected"?{height:"100vh"}:{},children:[(0,He.jsx)(et,{children:r||o?e(t,gi,ki):(0,He.jsx)(_i,{})}),t!="connected"&&(0,He.jsx)(ui,{}),o&&(0,He.jsx)("div",{className:"sdppp-trial-tips",children:(0,He.jsx)("span",{children:"\u6E38\u5BA2\u8BD5\u7528\u4E2D\uFF0C\u767B\u9646\u89E3\u9501\u66F4\u591A\u529F\u80FD"})})]})}var Ti=v(E(),1);var ot=v(P(),1);function Ri(){let e=A(),{toggleWebviewDialog:t}=J(),r=(0,Ti.useCallback)(()=>{t()},[t]);return(0,ot.jsx)("div",{className:"auths-bar",children:(0,ot.jsx)("div",{className:"identifier-bar",children:(0,ot.jsxs)("div",{className:"identifier-bar-left",children:[(0,ot.jsx)(Rr,{}),e.comfyMultiUser&&(0,ot.jsx)(Tr,{onRequestLogin:r})]})})})}var Vt=v(E(),1),Ni=v(E(),1),Oi=N("uxp"),_o=v(P(),1),na={en:[],zhcn:[{name:"\u6668\u7FBD\u667A\u4E91",url:"https://www.chenyu.cn/console/login?invitationCode=BUD913",icon:"https://sdppp.zombee.tech/img/icons/chenyu.ico",color:"var(--uxp-host-text-color-secondary)"},{name:"\u4ED9\u5BAB\u4E91",url:"https://www.xiangongyun.com/register/NWF5AH",icon:"https://sdppp.zombee.tech/img/icons/xgc.ico",color:"var(--uxp-host-text-color-secondary)"},{name:"Cephalon",url:"https://cephalon.cloud/share/register-landing?invite_id=m95SDj",icon:"https://sdppp.zombee.tech/img/icons/cephalon.ico",color:"var(--uxp-host-text-color-secondary)"}]};function Wi(){let e=document.getElementById("color_computer")?.style.color||"#777",{data:t,isLoading:r}=_r(),o=(0,Vt.useRef)(null),[n,i]=(0,Vt.useState)(!1),[s,a]=(0,Vt.useState)(!1);if((0,Ni.useEffect)(()=>{o.current&&(r||s||(a(!0),o.current.addEventListener("loadstop",d=>{d.target.postMessage({action:"init",payload:{color:e,cloud:m}})}),o.current.addEventListener("loaderror",d=>{i(!0)}),o.current.addEventListener("message",d=>{let l=d.message;if(!l)return;let f=JSON.parse(l);f.action==="open"&&Oi.shell.openExternal(f.payload.url)})))},[o,r]),r||n)return(0,_o.jsx)("div",{style:{height:"8px"}});let c="./promote.html?color="+e,m=na[Ht()=="zhcn"?"zhcn":"en"];return m.length==0?null:(0,_o.jsx)("webview",{ref:o,className:"promote-webview",style:{width:"100%",height:"24px"},src:c})}Object.assign(globalThis,{SDPPPInternal:xo});})();
/*! Bundled license information:

fast-json-patch/module/helpers.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

fast-json-patch/module/duplex.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2021 Joachim Wester
   * MIT license
   *)
*/
